# PostgreSQL 17.5 æ ¸å¿ƒæ¶æ„å…¨æ™¯åˆ†æ

> æœ¬æ–‡æ¡£ç³»ç»Ÿæ€§æ¢³ç† PostgreSQL 17.5 çš„æ•´ä½“æ¶æ„ï¼Œä¸ºæ·±å…¥å­¦ä¹ å„æ ¸å¿ƒæ¨¡å—å¥ å®šåŸºç¡€ã€‚

---

## ç›®å½•

1. [PostgreSQL æ¶æ„æ¦‚è§ˆ](#ä¸€postgresql-æ¶æ„æ¦‚è§ˆ)
2. [è¿›ç¨‹æ¶æ„](#äºŒè¿›ç¨‹æ¶æ„)
3. [å†…å­˜æ¶æ„](#ä¸‰å†…å­˜æ¶æ„)
4. [å­˜å‚¨æ¶æ„](#å››å­˜å‚¨æ¶æ„)
5. [æ ¸å¿ƒæ¨¡å—åˆ†ç±»](#äº”æ ¸å¿ƒæ¨¡å—åˆ†ç±»)
6. [æ¨¡å—ä¾èµ–å…³ç³»](#å…­æ¨¡å—ä¾èµ–å…³ç³»)
7. [æ•°æ®æµè½¬å…¨æ™¯](#ä¸ƒæ•°æ®æµè½¬å…¨æ™¯)
8. [æ–‡æ¡£å¯¼èˆª](#å…«æ–‡æ¡£å¯¼èˆª)

---

## ä¸€ã€PostgreSQL æ¶æ„æ¦‚è§ˆ

### 1.1 ä¸‰å±‚æ¶æ„æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ (Applications)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  psql    â”‚  â”‚  JDBC    â”‚  â”‚  ODBC    â”‚  â”‚   App    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ (TCP/IP æˆ– Unix Socket)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â–¼                                           â”‚
â”‚              PostgreSQL æœåŠ¡å™¨å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è¿æ¥ç®¡ç† (Postmaster + Backend Processes)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SQL å¤„ç†å±‚ (Parser â†’ Rewriter â†’ Planner â†’ Executor)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  äº‹åŠ¡ç®¡ç†å±‚ (MVCC + Transaction Manager + Lock Manager)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å­˜å‚¨ç®¡ç†å±‚ (Buffer Manager + WAL + Storage Manager)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç‰©ç†å­˜å‚¨å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Data     â”‚  â”‚   WAL    â”‚  â”‚  CLOG    â”‚  â”‚  Index   â”‚      â”‚
â”‚  â”‚ Files    â”‚  â”‚  Files   â”‚  â”‚  Files   â”‚  â”‚  Files   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | ä½“ç° |
|------|------|------|
| **Write-Ahead Logging** | å…ˆå†™æ—¥å¿—ï¼Œåå†™æ•°æ® | WAL æœºåˆ¶ç¡®ä¿æŒä¹…æ€§ |
| **MVCC** | å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ | è¯»å†™ä¸é˜»å¡ï¼Œé«˜å¹¶å‘ |
| **Process-per-Connection** | æ¯ä¸ªè¿æ¥ä¸€ä¸ªè¿›ç¨‹ | éš”ç¦»æ€§å¥½ï¼Œç¨³å®šæ€§é«˜ |
| **Shared-Nothing Storage** | æ— å…±äº«å­˜å‚¨æ¶æ„ | ç®€åŒ–è®¾è®¡ï¼Œæ˜“æ‰©å±• |
| **Extensibility** | é«˜åº¦å¯æ‰©å±• | è‡ªå®šä¹‰ç±»å‹ã€å‡½æ•°ã€ç´¢å¼•ç­‰ |

---

## äºŒã€è¿›ç¨‹æ¶æ„

### 2.1 è¿›ç¨‹å…¨æ™¯å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Postmaster (ä¸»å®ˆæŠ¤è¿›ç¨‹)              â”‚
                    â”‚  - ç›‘å¬ç«¯å£ (é»˜è®¤ 5432)                   â”‚
                    â”‚  - Fork å„ç±»å­è¿›ç¨‹                        â”‚
                    â”‚  - ç®¡ç†è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                    â”‚                    â”‚
              â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Backend è¿›ç¨‹    â”‚  â”‚  è¾…åŠ©è¿›ç¨‹        â”‚  â”‚  åå°å·¥ä½œè¿›ç¨‹    â”‚
    â”‚  (å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚) â”‚  â”‚  (ç³»ç»Ÿç»´æŠ¤)      â”‚  â”‚  (åå°ä»»åŠ¡)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚    â”‚                 â”‚   â”‚                 â”‚
    â–¼               â–¼    â–¼                 â–¼   â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚   â”‚                 â”‚
â”‚Backend â”‚    â”‚Backend â”‚ â”‚                 â”‚   â”‚                 â”‚
â”‚ Proc 1 â”‚    â”‚ Proc 2 â”‚ â”‚  Checkpointer   â”‚   â”‚  Bgwriter       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  WAL Writer     â”‚   â”‚  Autovacuum     â”‚
                         â”‚  WAL Sender     â”‚   â”‚  Logical Worker â”‚
                         â”‚  WAL Receiver   â”‚   â”‚  Parallel Workerâ”‚
                         â”‚  Archiver       â”‚   â”‚  Stats Collectorâ”‚
                         â”‚  Logger         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¿›ç¨‹è¯¦ç»†è¯´æ˜

#### 2.2.1 Postmaster (ä¸»è¿›ç¨‹)

**æºç ä½ç½®**: `src/backend/postmaster/postmaster.c:1250 PostmasterMain()`

**èŒè´£**:
1. **ç›‘å¬è¿æ¥**: ç›‘å¬ TCP/IP ç«¯å£å’Œ Unix Socket
2. **Fork Backend**: ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºç‹¬ç«‹çš„ Backend è¿›ç¨‹
3. **å¯åŠ¨è¾…åŠ©è¿›ç¨‹**: å¯åŠ¨æ‰€æœ‰åå°è¾…åŠ©è¿›ç¨‹
4. **è¿›ç¨‹ç›‘æ§**: ç›‘æ§å­è¿›ç¨‹å¥åº·çŠ¶æ€ï¼Œå´©æºƒæ—¶é‡å¯
5. **ä¿¡å·å¤„ç†**: å¤„ç† SIGHUP (é‡æ–°åŠ è½½é…ç½®)ã€SIGTERM (å…³é—­) ç­‰

**ç”Ÿå‘½å‘¨æœŸ**:
```
pg_ctl start
    â†“
å¯åŠ¨ Postmaster
    â†“
åŠ è½½é…ç½®æ–‡ä»¶ (postgresql.conf)
    â†“
åˆå§‹åŒ–å…±äº«å†…å­˜
    â†“
å¯åŠ¨æ‰€æœ‰è¾…åŠ©è¿›ç¨‹
    â†“
è¿›å…¥ä¸»å¾ªç¯ï¼Œç›‘å¬è¿æ¥
    â†“
pg_ctl stop
    â†“
ä¼˜é›…å…³é—­æ‰€æœ‰å­è¿›ç¨‹
```

#### 2.2.2 Backend è¿›ç¨‹ (å·¥ä½œè¿›ç¨‹)

**æºç ä½ç½®**: `src/backend/tcop/postgres.c:4280 PostgresMain()`

**èŒè´£**:
1. **æ¥æ”¶ SQL**: ä»å®¢æˆ·ç«¯æ¥æ”¶ SQL å‘½ä»¤
2. **è§£æ SQL**: Parser â†’ Rewriter â†’ Planner â†’ Executor
3. **æ‰§è¡ŒæŸ¥è¯¢**: è°ƒç”¨å­˜å‚¨å¼•æ“è¯»å†™æ•°æ®
4. **è¿”å›ç»“æœ**: å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯
5. **äº‹åŠ¡ç®¡ç†**: ç®¡ç†äº‹åŠ¡çš„å¼€å§‹ã€æäº¤ã€å›æ»š

**å…³é”®ç‰¹ç‚¹**:
- **ä¸€å¯¹ä¸€**: ä¸€ä¸ª Backend è¿›ç¨‹æœåŠ¡ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
- **ç‹¬ç«‹å†…å­˜**: æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„æœ¬åœ°å†…å­˜ (work_mem)
- **å…±äº«å†…å­˜è®¿é—®**: é€šè¿‡å…±äº«å†…å­˜è®¿é—®ç¼“å†²æ± å’Œé”è¡¨

**æ‰§è¡Œæµç¨‹**:
```
å®¢æˆ·ç«¯è¿æ¥
    â†“
Postmaster fork() æ–°è¿›ç¨‹
    â†“
Backend è¿›ç¨‹åˆå§‹åŒ–
    â†“
æ¥æ”¶ SQL å‘½ä»¤
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Parser (gram.y)              â”‚  å°† SQL è§£æä¸ºè¯­æ³•æ ‘
â”‚    src/backend/parser/          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Rewriter (rewriteHandler.c)  â”‚  åº”ç”¨è§„åˆ™å’Œè§†å›¾é‡å†™
â”‚    src/backend/rewrite/         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Planner (planner.c)          â”‚  ç”Ÿæˆæœ€ä¼˜æ‰§è¡Œè®¡åˆ’
â”‚    src/backend/optimizer/       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Executor (execMain.c)        â”‚  æ‰§è¡Œè®¡åˆ’ï¼Œè¿”å›ç»“æœ
â”‚    src/backend/executor/        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
```

#### 2.2.3 è¾…åŠ©è¿›ç¨‹ (Auxiliary Processes)

| è¿›ç¨‹å | æºç ä½ç½® | èŒè´£ | æ•°é‡ |
|--------|----------|------|------|
| **Checkpointer** | postmaster/checkpointer.c:173 | å®šæœŸæ‰§è¡Œ checkpointï¼Œåˆ·å†™è„é¡µ | 1 |
| **WAL Writer** | postmaster/walwriter.c:100 | å¼‚æ­¥åˆ·å†™ WAL ç¼“å†²åŒºåˆ°ç£ç›˜ | 1 |
| **Bgwriter** | postmaster/bgwriter.c:150 | åå°å†™è„é¡µï¼Œå‡è½» checkpoint å‹åŠ› | 1 |
| **Autovacuum Launcher** | postmaster/autovacuum.c:400 | è‡ªåŠ¨å¯åŠ¨ VACUUM ä»»åŠ¡ | 1 |
| **Stats Collector** | postmaster/pgstat.c:500 | æ”¶é›†æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ | 1 |
| **Logger** | postmaster/syslogger.c:200 | ç®¡ç†æ—¥å¿—æ–‡ä»¶ | 0-1 |
| **Archiver** | postmaster/pgarch.c:150 | å½’æ¡£å·²å®Œæˆçš„ WAL æ®µæ–‡ä»¶ | 0-1 |
| **WAL Sender** | replication/walsender.c:2000 | å‘é€ WAL åˆ°å¤‡åº“ | 0-N |
| **WAL Receiver** | replication/walreceiver.c:200 | (å¤‡åº“) æ¥æ”¶ WAL | 0-1 |
| **Startup** | postmaster/startup.c:200 | (æ¢å¤ä¸­) é‡æ”¾ WAL æ—¥å¿— | 0-1 |

#### 2.2.4 åå°å·¥ä½œè¿›ç¨‹ (Background Workers)

**ç‰¹ç‚¹**: åŠ¨æ€åˆ›å»ºï¼Œå¯è‡ªå®šä¹‰

| ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| **Autovacuum Worker** | æ‰§è¡Œ VACUUM æ¸…ç† | è‡ªåŠ¨æ¸…ç†æ­»å…ƒç»„ |
| **Parallel Worker** | å¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œ | å¹¶è¡Œæ‰«æã€èšåˆã€æ’åº |
| **Logical Replication Worker** | é€»è¾‘å¤åˆ¶ | è®¢é˜…ç«¯åº”ç”¨å˜æ›´ |
| **è‡ªå®šä¹‰ Worker** | æ‰©å±•åŠŸèƒ½ | é€šè¿‡ bgworker API æ³¨å†Œ |

### 2.3 è¿›ç¨‹é—´é€šä¿¡ (IPC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å…±äº«å†…å­˜ (Shared Memory)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Shared Bufferâ”‚  â”‚  Lock Table  â”‚  â”‚  Proc Array  â”‚        â”‚
â”‚  â”‚    Pool      â”‚  â”‚              â”‚  â”‚              â”‚        â”‚
â”‚  â”‚  (é»˜è®¤ 128MB) â”‚  â”‚  (é”ç®¡ç†å™¨)   â”‚  â”‚ (è¿›ç¨‹ä¿¡æ¯)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  WAL Buffers â”‚  â”‚  CLOG Buffer â”‚  â”‚  Checkpointerâ”‚        â”‚
â”‚  â”‚   (16MB)     â”‚  â”‚              â”‚  â”‚    Shmem     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â–²                    â–²
         â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚Backend 1â”‚          â”‚Backend 2â”‚         â”‚Checkpntrâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¶ä»– IPC æœºåˆ¶:
- Semaphores (ä¿¡å·é‡): ç”¨äºé”åŒæ­¥
- Signals (ä¿¡å·): è¿›ç¨‹é—´é€šçŸ¥ (å¦‚ SIGINT è§¦å‘ checkpoint)
- Pipes (ç®¡é“): Logger è¿›ç¨‹æ—¥å¿—ä¼ è¾“
- Message Queue: Parallel Query åè°ƒ
```

---

## ä¸‰ã€å†…å­˜æ¶æ„

### 3.1 å†…å­˜å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL å†…å­˜æ¶æ„                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                         â”‚
         â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…±äº«å†…å­˜ (Shared)   â”‚              â”‚  æœ¬åœ°å†…å­˜ (Local)     â”‚
â”‚   æ‰€æœ‰è¿›ç¨‹å…±äº«        â”‚              â”‚  æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼                          â–¼                   â–¼
```

### 3.2 å…±äº«å†…å­˜è¯¦è§£

**æ€»å¤§å°è®¡ç®—**:
```c
// src/backend/storage/ipc/ipci.c:83
total_shared_memory =
    BufferPoolSize              // shared_buffers
  + WalBufferSize               // wal_buffers
  + CLOGBufferSize              // CLOG ç¼“å†²
  + LockSpaceSize               // max_locks_per_transaction
  + ProcArraySize               // max_connections
  + CheckpointerShmemSize       // Checkpointer çŠ¶æ€
  + AutoVacuumShmemSize         // Autovacuum çŠ¶æ€
  + ... (å…¶ä»–å„æ¨¡å—)
```

#### 3.2.1 Shared Buffers (å…±äº«ç¼“å†²æ± )

**é…ç½®**: `shared_buffers = 128MB` (é»˜è®¤)

**ç»“æ„**:
```
shared_buffers å†…å­˜å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Buffer Descriptor Array (BufferDescriptors)    â”‚  æ§åˆ¶ä¿¡æ¯
â”‚  æ¯ä¸ª BufferDesc: 64 å­—èŠ‚                        â”‚
â”‚  æ•°é‡: shared_buffers / 8KB                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Buffer Pool (BufferBlocks)                      â”‚  å®é™…æ•°æ®
â”‚  æ¯ä¸ª Block: 8KB                                 â”‚
â”‚  å­˜å‚¨æ•°æ®é¡µå†…å®¹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾‹å¦‚ shared_buffers = 128MB:
- é¡µé¢æ•°: 128MB / 8KB = 16384 ä¸ªé¡µ
- BufferDesc æ•°ç»„: 16384 * 64B = 1MB
- å®é™…æ•°æ®: 128MB
- æ€»è®¡: ~129MB
```

**ç®¡ç†ç®—æ³•**: Clock-Sweep (æ—¶é’Ÿæ‰«æç®—æ³•)
- æºç : `src/backend/storage/buffer/freelist.c:150 StrategyGetBuffer()`

#### 3.2.2 WAL Buffers

**é…ç½®**: `wal_buffers = 16MB` (é»˜è®¤ï¼Œè‡ªåŠ¨æ ¹æ® shared_buffers è°ƒæ•´)

**ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WAL ç¼“å†²åŒº (XLogCtlData->pages)   â”‚
â”‚  å¾ªç¯ä½¿ç”¨çš„ç¯å½¢ç¼“å†²åŒº               â”‚
â”‚                                    â”‚
â”‚  Insert Ptr  â”€â”€>  [WAL Record]    â”‚  å½“å‰å†™å…¥ä½ç½®
â”‚                   [WAL Record]    â”‚
â”‚  Flush Ptr   â”€â”€>  [WAL Record]    â”‚  å·²åˆ·åˆ°ç£ç›˜ä½ç½®
â”‚                   [Free Space]    â”‚
â”‚                   [Free Space]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 Lock Table (é”è¡¨)

**é…ç½®**: `max_locks_per_transaction = 64` (é»˜è®¤)

**æ€»å¤§å°**: `max_locks_per_transaction * (max_connections + max_prepared_transactions)`

**ç»“æ„**:
```
src/backend/storage/lmgr/lock.c:200

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOCK Hash Table                          â”‚
â”‚  - Key: (database, relation, page, tuple) â”‚
â”‚  - Value: LOCK ç»“æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PROCLOCK Hash Table                      â”‚
â”‚  - Key: (LOCK, PGPROC)                    â”‚
â”‚  - Value: PROCLOCK ç»“æ„ (æŒæœ‰è€…ä¿¡æ¯)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é”ç±»å‹**: 8 ç§é”æ¨¡å¼
1. AccessShareLock (SELECT)
2. RowShareLock (SELECT FOR UPDATE)
3. RowExclusiveLock (INSERT/UPDATE/DELETE)
4. ShareUpdateExclusiveLock (VACUUM)
5. ShareLock (CREATE INDEX)
6. ShareRowExclusiveLock
7. ExclusiveLock (REFRESH MATERIALIZED VIEW)
8. AccessExclusiveLock (DROP TABLE, TRUNCATE)

### 3.3 æœ¬åœ°å†…å­˜è¯¦è§£

**æ¯ä¸ª Backend è¿›ç¨‹ç‹¬ç«‹æ‹¥æœ‰**:

#### 3.3.1 work_mem (å·¥ä½œå†…å­˜)

**é…ç½®**: `work_mem = 4MB` (é»˜è®¤)

**ç”¨é€”**:
- æ’åºæ“ä½œ (ORDER BY, CREATE INDEX)
- å“ˆå¸Œè¡¨ (Hash Join, Hash Aggregate)
- ä½å›¾ç´¢å¼•æ‰«æ
- Merge Join

**æ³¨æ„**: ä¸€ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨å¤šä¸ª work_mem å—ï¼

**ç¤ºä¾‹**:
```sql
-- è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä½¿ç”¨ 3 * work_mem:
SELECT *
FROM t1
  JOIN t2 USING (id)       -- 1 ä¸ª work_mem (hash join)
ORDER BY t1.name, t2.value -- 2 ä¸ª work_mem (2 ä¸ªæ’åº)
```

#### 3.3.2 maintenance_work_mem (ç»´æŠ¤å†…å­˜)

**é…ç½®**: `maintenance_work_mem = 64MB` (é»˜è®¤)

**ç”¨é€”**:
- VACUUM
- CREATE INDEX
- ALTER TABLE ADD FOREIGN KEY
- CLUSTER

#### 3.3.3 temp_buffers (ä¸´æ—¶è¡¨ç¼“å†²)

**é…ç½®**: `temp_buffers = 8MB` (é»˜è®¤)

**ç”¨é€”**: æ¯ä¸ªä¼šè¯çš„ä¸´æ—¶è¡¨ç¼“å­˜

### 3.4 å†…å­˜ä¸Šä¸‹æ–‡ (Memory Context)

PostgreSQL ä½¿ç”¨å†…å­˜ä¸Šä¸‹æ–‡ç®¡ç†å†…å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

**æºç **: `src/backend/utils/mmgr/mcxt.c:100`

**å±‚æ¬¡ç»“æ„**:
```
TopMemoryContext (æ°¸ä¸é‡Šæ”¾)
    â”‚
    â”œâ”€ ErrorContext (é”™è¯¯å¤„ç†)
    â”‚
    â”œâ”€ PostmasterContext (Postmaster å…¨å±€)
    â”‚
    â”œâ”€ CacheMemoryContext (ç³»ç»Ÿç¼“å­˜)
    â”‚
    â”œâ”€ MessageContext (æ¯æ¡æ¶ˆæ¯)
    â”‚      â””â”€ (å¤„ç†å®Œæ¶ˆæ¯åé‡Šæ”¾)
    â”‚
    â”œâ”€ TopTransactionContext (äº‹åŠ¡é¡¶å±‚)
    â”‚      â”œâ”€ CurTransactionContext (å½“å‰äº‹åŠ¡)
    â”‚      â”‚      â”œâ”€ ExecutorState (æ‰§è¡Œå™¨çŠ¶æ€)
    â”‚      â”‚      â”œâ”€ TupleSort (æ’åº)
    â”‚      â”‚      â””â”€ ... (ç®—å­å†…å­˜)
    â”‚      â”‚
    â”‚      â””â”€ (äº‹åŠ¡ç»“æŸåé‡Šæ”¾)
    â”‚
    â””â”€ ... (å…¶ä»–ä¸Šä¸‹æ–‡)
```

**ä¼˜ç‚¹**:
1. **æ‰¹é‡é‡Šæ”¾**: é‡Šæ”¾ä¸Šä¸‹æ–‡æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å…¶ä¸‹æ‰€æœ‰å†…å­˜
2. **å±‚æ¬¡æ¸…æ™°**: å†…å­˜ç”Ÿå‘½å‘¨æœŸæ˜ç¡®
3. **é˜²æ­¢æ³„æ¼**: å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†

**ç¤ºä¾‹**:
```c
// åˆ›å»ºä¸´æ—¶ä¸Šä¸‹æ–‡
MemoryContext tempContext = AllocSetContextCreate(
    CurrentMemoryContext,
    "My Temp Context",
    ALLOCSET_DEFAULT_SIZES
);

// åœ¨ä¸´æ—¶ä¸Šä¸‹æ–‡ä¸­åˆ†é…å†…å­˜
MemoryContext oldContext = MemoryContextSwitchTo(tempContext);
char *temp_data = palloc(1024);  // åœ¨ tempContext ä¸­åˆ†é…
// ... ä½¿ç”¨ temp_data ...
MemoryContextSwitchTo(oldContext);

// æ‰¹é‡é‡Šæ”¾
MemoryContextDelete(tempContext);  // temp_data è‡ªåŠ¨é‡Šæ”¾
```

---

## å››ã€å­˜å‚¨æ¶æ„

### 4.1 ç‰©ç†å­˜å‚¨å¸ƒå±€

```
$PGDATA (æ•°æ®ç›®å½•)
â”‚
â”œâ”€â”€ base/                    # æ•°æ®åº“æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ 1/                   # template1 æ•°æ®åº“ (OID=1)
â”‚   â”œâ”€â”€ 13000/               # template0 æ•°æ®åº“
â”‚   â”œâ”€â”€ 13001/               # postgres æ•°æ®åº“
â”‚   â””â”€â”€ 16384/               # ç”¨æˆ·æ•°æ®åº“
â”‚       â”œâ”€â”€ 16385            # è¡¨æ–‡ä»¶ (OID=16385)
â”‚       â”œâ”€â”€ 16385_fsm        # Free Space Map (ç©ºé—²ç©ºé—´æ˜ å°„)
â”‚       â”œâ”€â”€ 16385_vm         # Visibility Map (å¯è§æ€§æ˜ å°„)
â”‚       â”œâ”€â”€ 16386            # ç´¢å¼•æ–‡ä»¶
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ global/                  # å…¨å±€å…±äº«å¯¹è±¡
â”‚   â”œâ”€â”€ pg_control           # æ§åˆ¶æ–‡ä»¶ (8KB)
â”‚   â”œâ”€â”€ pg_filenode.map      # ç³»ç»Ÿè¡¨æ–‡ä»¶æ˜ å°„
â”‚   â””â”€â”€ 1260                 # pg_authid ç­‰ç³»ç»Ÿè¡¨
â”‚
â”œâ”€â”€ pg_wal/                  # WAL æ—¥å¿—æ–‡ä»¶
â”‚   â”œâ”€â”€ 000000010000000000000001  # WAL æ®µæ–‡ä»¶ (16MB)
â”‚   â”œâ”€â”€ 000000010000000000000002
â”‚   â”œâ”€â”€ 000000010000000000000003
â”‚   â””â”€â”€ archive_status/       # å½’æ¡£çŠ¶æ€
â”‚       â”œâ”€â”€ 000000010000000000000001.done
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ pg_xact/                 # äº‹åŠ¡æäº¤çŠ¶æ€ (CLOG)
â”‚   â”œâ”€â”€ 0000                 # CLOG æ–‡ä»¶ (256KB)
â”‚   â”œâ”€â”€ 0001
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ pg_multixact/            # å¤šäº‹åŠ¡çŠ¶æ€
â”‚   â”œâ”€â”€ members/             # MultiXact æˆå‘˜
â”‚   â””â”€â”€ offsets/             # MultiXact åç§»
â”‚
â”œâ”€â”€ pg_subtrans/             # å­äº‹åŠ¡çŠ¶æ€
â”œâ”€â”€ pg_commit_ts/            # æäº¤æ—¶é—´æˆ³
â”œâ”€â”€ pg_twophase/             # ä¸¤é˜¶æ®µæäº¤çŠ¶æ€æ–‡ä»¶
â”‚
â”œâ”€â”€ pg_stat/                 # ç»Ÿè®¡ä¿¡æ¯
â”‚   â””â”€â”€ pg_stat_tmp/         # ä¸´æ—¶ç»Ÿè®¡æ–‡ä»¶
â”‚
â”œâ”€â”€ pg_tblspc/               # è¡¨ç©ºé—´ç¬¦å·é“¾æ¥
â”‚   â””â”€â”€ 16387 -> /data/pg_tblspc1/
â”‚
â”œâ”€â”€ pg_logical/              # é€»è¾‘å¤åˆ¶çŠ¶æ€
â”‚   â”œâ”€â”€ snapshots/           # é€»è¾‘å¿«ç…§
â”‚   â””â”€â”€ mappings/            # æ–‡ä»¶æ˜ å°„
â”‚
â”œâ”€â”€ postgresql.conf          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ pg_hba.conf              # è®¿é—®æ§åˆ¶é…ç½®
â”œâ”€â”€ pg_ident.conf            # ç”¨æˆ·æ˜ å°„é…ç½®
â””â”€â”€ postmaster.pid           # PID æ–‡ä»¶
```

### 4.2 æ•°æ®æ–‡ä»¶ç»„ç»‡

#### 4.2.1 è¡¨æ–‡ä»¶ (Heap File)

**æ–‡ä»¶å¤§å°**: æ¯ä¸ªæ–‡ä»¶æœ€å¤§ 1GBï¼Œè¶…è¿‡ååˆ›å»º `.1`, `.2` ç­‰åç¼€

**é¡µé¢ç»“æ„** (8KB):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† 0 å­—èŠ‚
â”‚  PageHeaderData (24 å­—èŠ‚)                              â”‚
â”‚  - pd_lsn:      æœ€åä¿®æ”¹çš„ LSN                          â”‚
â”‚  - pd_checksum: é¡µé¢æ ¡éªŒå’Œ                              â”‚
â”‚  - pd_flags:    æ ‡å¿—ä½                                  â”‚
â”‚  - pd_lower:    ç©ºé—²ç©ºé—´èµ·å§‹ä½ç½®                         â”‚
â”‚  - pd_upper:    ç©ºé—²ç©ºé—´ç»“æŸä½ç½®                         â”‚
â”‚  - pd_special:  ç‰¹æ®Šç©ºé—´èµ·å§‹ä½ç½® (ç´¢å¼•ç”¨)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â† 24 å­—èŠ‚
â”‚  Line Pointer Array (ItemIdData[])                     â”‚
â”‚  æ¯ä¸ª ItemId 4 å­—èŠ‚:                                    â”‚
â”‚  - lp_off:   æŒ‡å‘å…ƒç»„çš„åç§»                             â”‚
â”‚  - lp_flags: æ ‡å¿— (unused/normal/redirect/dead)        â”‚
â”‚  - lp_len:   å…ƒç»„é•¿åº¦                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Free Space (ç©ºé—²ç©ºé—´)                                  â”‚
â”‚  â† pd_lower                                            â”‚
â”‚                                                        â”‚
â”‚  â†“ å‘ä¸‹å¢é•¿ (Line Pointers)                            â”‚
â”‚  â†‘ å‘ä¸Šå¢é•¿ (Tuples)                                    â”‚
â”‚                                                        â”‚
â”‚  â† pd_upper                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tuples (å…ƒç»„æ•°æ®ï¼Œä»é¡µé¢æœ«å°¾å‘å‰å¢é•¿)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ HeapTupleHeaderData (23 å­—èŠ‚)        â”‚             â”‚
â”‚  â”‚ - t_xmin: æ’å…¥äº‹åŠ¡ ID                 â”‚             â”‚
â”‚  â”‚ - t_xmax: åˆ é™¤äº‹åŠ¡ ID                 â”‚             â”‚
â”‚  â”‚ - t_cid:  å‘½ä»¤ ID                     â”‚             â”‚
â”‚  â”‚ - t_ctid: å…ƒç»„ä½ç½® (TID)              â”‚             â”‚
â”‚  â”‚ - t_infomask: æ ‡å¿—ä½                  â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ Null Bitmap (å˜é•¿)                   â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ User Data (å®é™…åˆ—æ•°æ®)                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Special Space (ç‰¹æ®Šç©ºé—´ï¼Œç´¢å¼•é¡µä½¿ç”¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â† 8192 å­—èŠ‚
```

**æºç **: `src/include/storage/bufpage.h:160`

#### 4.2.2 Free Space Map (FSM)

**ä½œç”¨**: å¿«é€Ÿæ‰¾åˆ°æœ‰è¶³å¤Ÿç©ºé—²ç©ºé—´çš„é¡µé¢

**ç»“æ„**: ä¸‰å±‚æ ‘å½¢ç»“æ„
```
FSM é¡µé¢ (8KB)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Root FSM Page (ç¬¬ 3 å±‚)            â”‚  1 ä¸ªé¡µé¢
â”‚  æ¯ä¸ªå­—èŠ‚ä»£è¡¨ä¸‹å±‚ä¸€ä¸ªé¡µé¢çš„ç©ºé—²åº¦    â”‚  4096 ä¸ªå­—èŠ‚ â†’ æŒ‡å‘ 4096 ä¸ªå­é¡µé¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                   â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ L2 FSM Page  â”‚... â”‚ L2 FSM Page  â”‚  ~4096 ä¸ªé¡µé¢
  â”‚ (ç¬¬ 2 å±‚)     â”‚    â”‚              â”‚  æ¯ä¸ªæŒ‡å‘ 4096 ä¸ªæ•°æ®é¡µ
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” ...
â”‚Data Pg â”‚ â”‚Data Pg â”‚ â”‚Data Pg â”‚      ~16M ä¸ªæ•°æ®é¡µ (128GB)
â”‚(ç¬¬ 1å±‚)â”‚ â”‚        â”‚ â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç©ºé—²åº¦**: 0-255ï¼Œè¡¨ç¤ºé¡µé¢å¯ç”¨ç©ºé—´çš„è¿‘ä¼¼å€¼
- 255: å®Œå…¨ç©º
- 0: å®Œå…¨æ»¡

**æºç **: `src/backend/storage/freespace/freespace.c:100`

#### 4.2.3 Visibility Map (VM)

**ä½œç”¨**: æ ‡è®°å“ªäº›é¡µé¢çš„æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§ (all-visible)

**ä¼˜åŒ–**:
1. **Index-Only Scan**: å¦‚æœé¡µé¢ all-visibleï¼Œç´¢å¼•æ‰«ææ— éœ€è®¿é—®å †è¡¨
2. **VACUUM ä¼˜åŒ–**: è·³è¿‡ all-visible é¡µé¢

**ç»“æ„**:
```
æ¯ä¸ªæ•°æ®é¡µå¯¹åº” 2 ä¸ª bit:
- Bit 0: all-visible (æ‰€æœ‰å…ƒç»„å¯è§)
- Bit 1: all-frozen (æ‰€æœ‰å…ƒç»„å·²å†»ç»“)

VM æ–‡ä»¶å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page 0 (8KB)                       â”‚
â”‚  Bit pairs: è¡¨ç¤º 32768 ä¸ªæ•°æ®é¡µ     â”‚  æ¯ä¸ªæ•°æ®é¡µ 2 bit
â”‚  è¦†ç›–èŒƒå›´: 32768 * 8KB = 256MB      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Page 1 (8KB)                       â”‚
â”‚  è¦†ç›–ä¸‹ä¸€ä¸ª 256MB                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç **: `src/backend/access/heap/visibilitymap.c:100`

### 4.3 WAL æ–‡ä»¶

**æ®µæ–‡ä»¶å¤§å°**: 16MB (é»˜è®¤ï¼Œç¼–è¯‘æ—¶å¯é…ç½®)

**å‘½åè§„åˆ™**: `000000010000000000000001`
- å‰ 8 ä½: Timeline ID (00000001)
- ä¸­ 8 ä½: é€»è¾‘æ®µå·é«˜ä½ (00000000)
- å 8 ä½: é€»è¾‘æ®µå·ä½ä½ (00000001)

**é¡µé¢ç»“æ„** (8KB):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  XLogPageHeaderData (20-48 å­—èŠ‚)           â”‚
â”‚  - xlp_magic:     é­”æ•° (0xD10B)            â”‚
â”‚  - xlp_info:      æ ‡å¿—ä½                    â”‚
â”‚  - xlp_tli:       Timeline ID              â”‚
â”‚  - xlp_pageaddr:  é¡µé¢ LSN                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WAL Records (å˜é•¿)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ XLogRecord (24 å­—èŠ‚ + å˜é•¿æ•°æ®)     â”‚   â”‚
â”‚  â”‚ - xl_tot_len: è®°å½•æ€»é•¿åº¦            â”‚   â”‚
â”‚  â”‚ - xl_xid:     äº‹åŠ¡ ID                â”‚   â”‚
â”‚  â”‚ - xl_prev:    å‰ä¸€æ¡è®°å½• LSN         â”‚   â”‚
â”‚  â”‚ - xl_info:    èµ„æºç®¡ç†å™¨ + æ“ä½œç±»å‹  â”‚   â”‚
â”‚  â”‚ - xl_rmid:    èµ„æºç®¡ç†å™¨ ID          â”‚   â”‚
â”‚  â”‚ - xl_crc:     CRC æ ¡éªŒå’Œ             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Data (å˜é•¿)                         â”‚   â”‚
â”‚  â”‚ - Main data block                  â”‚   â”‚
â”‚  â”‚ - FPI (Full Page Image, å¦‚æœéœ€è¦)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  ...                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èµ„æºç®¡ç†å™¨ (Resource Manager)**:
```c
// src/include/access/rmgrlist.h
RM_XLOG_ID      = 0   // WAL æœ¬èº«çš„æ—¥å¿—
RM_XACT_ID      = 1   // äº‹åŠ¡æ“ä½œ
RM_SMGR_ID      = 2   // å­˜å‚¨ç®¡ç†å™¨
RM_CLOG_ID      = 3   // CLOG æ“ä½œ
RM_DBASE_ID     = 4   // æ•°æ®åº“æ“ä½œ
RM_TBLSPC_ID    = 5   // è¡¨ç©ºé—´æ“ä½œ
RM_MULTIXACT_ID = 6   // MultiXact æ“ä½œ
RM_RELMAP_ID    = 7   // å…³ç³»æ˜ å°„
RM_STANDBY_ID   = 8   // å¤‡åº“æ“ä½œ
RM_HEAP2_ID     = 9   // Heap æ“ä½œ (HOT)
RM_HEAP_ID      = 10  // Heap æ“ä½œ
RM_BTREE_ID     = 11  // B-Tree ç´¢å¼•
RM_HASH_ID      = 12  // Hash ç´¢å¼•
RM_GIN_ID       = 13  // GIN ç´¢å¼•
RM_GIST_ID      = 14  // GiST ç´¢å¼•
RM_SEQ_ID       = 15  // åºåˆ—
... (å…± ~30 ä¸ª)
```

---

## äº”ã€æ ¸å¿ƒæ¨¡å—åˆ†ç±»

### 5.1 æ¨¡å—åˆ†ç±»æ ‘

```
PostgreSQL æ ¸å¿ƒæ¨¡å—
â”‚
â”œâ”€â”€ 1. è¿æ¥ä¸è¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ Postmaster (ä¸»è¿›ç¨‹ç®¡ç†)
â”‚   â”œâ”€â”€ Backend Process (ä¼šè¯ç®¡ç†)
â”‚   â””â”€â”€ Background Workers (åå°ä»»åŠ¡)
â”‚
â”œâ”€â”€ 2. SQL å¤„ç†å±‚
â”‚   â”œâ”€â”€ Parser (è¯­æ³•è§£æ)
â”‚   â”œâ”€â”€ Analyzer (è¯­ä¹‰åˆ†æ)
â”‚   â”œâ”€â”€ Rewriter (è§„åˆ™é‡å†™)
â”‚   â”œâ”€â”€ Planner/Optimizer (æŸ¥è¯¢ä¼˜åŒ–)
â”‚   â””â”€â”€ Executor (æ‰§è¡Œå™¨)
â”‚
â”œâ”€â”€ 3. äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶
â”‚   â”œâ”€â”€ Transaction Manager (äº‹åŠ¡ç®¡ç†)
â”‚   â”œâ”€â”€ MVCC (å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)
â”‚   â”œâ”€â”€ Lock Manager (é”ç®¡ç†)
â”‚   â””â”€â”€ Snapshot Manager (å¿«ç…§ç®¡ç†)
â”‚
â”œâ”€â”€ 4. å­˜å‚¨ç®¡ç†å±‚
â”‚   â”œâ”€â”€ Buffer Manager (ç¼“å†²æ± ç®¡ç†) â­
â”‚   â”œâ”€â”€ Storage Manager (SMGR)
â”‚   â”œâ”€â”€ File Manager
â”‚   â””â”€â”€ Free Space Map (FSM)
â”‚
â”œâ”€â”€ 5. WAL ä¸æ¢å¤
â”‚   â”œâ”€â”€ WAL Writer (WAL å†™å…¥) â­
â”‚   â”œâ”€â”€ Checkpointer (æ£€æŸ¥ç‚¹) â­ (å·²å®Œæˆ)
â”‚   â”œâ”€â”€ WAL Archiver (å½’æ¡£)
â”‚   â”œâ”€â”€ Recovery (å´©æºƒæ¢å¤)
â”‚   â””â”€â”€ PITR (æ—¶é—´ç‚¹æ¢å¤)
â”‚
â”œâ”€â”€ 6. è®¿é—®æ–¹æ³• (Access Methods)
â”‚   â”œâ”€â”€ Heap (å †è¡¨)
â”‚   â”œâ”€â”€ B-Tree (B æ ‘ç´¢å¼•)
â”‚   â”œâ”€â”€ Hash (å“ˆå¸Œç´¢å¼•)
â”‚   â”œâ”€â”€ GiST (é€šç”¨æœç´¢æ ‘)
â”‚   â”œâ”€â”€ GIN (é€šç”¨å€’æ’ç´¢å¼•)
â”‚   â”œâ”€â”€ SP-GiST (ç©ºé—´åˆ†åŒº GiST)
â”‚   â””â”€â”€ BRIN (å—èŒƒå›´ç´¢å¼•)
â”‚
â”œâ”€â”€ 7. VACUUM ä¸è‡ªåŠ¨ç»´æŠ¤
â”‚   â”œâ”€â”€ VACUUM (æ¸…ç†æ­»å…ƒç»„) â­
â”‚   â”œâ”€â”€ Autovacuum (è‡ªåŠ¨æ¸…ç†)
â”‚   â”œâ”€â”€ ANALYZE (ç»Ÿè®¡ä¿¡æ¯æ”¶é›†)
â”‚   â””â”€â”€ FREEZE (äº‹åŠ¡ ID å†»ç»“)
â”‚
â”œâ”€â”€ 8. ç³»ç»Ÿç›®å½• (System Catalog)
â”‚   â”œâ”€â”€ pg_class (è¡¨å’Œç´¢å¼•)
â”‚   â”œâ”€â”€ pg_attribute (åˆ—å®šä¹‰)
â”‚   â”œâ”€â”€ pg_type (ç±»å‹ç³»ç»Ÿ)
â”‚   â””â”€â”€ ... (100+ ç³»ç»Ÿè¡¨)
â”‚
â”œâ”€â”€ 9. å¤åˆ¶ä¸é«˜å¯ç”¨
â”‚   â”œâ”€â”€ Streaming Replication (æµå¤åˆ¶)
â”‚   â”œâ”€â”€ Logical Replication (é€»è¾‘å¤åˆ¶)
â”‚   â”œâ”€â”€ WAL Sender/Receiver
â”‚   â””â”€â”€ Replication Slots
â”‚
â””â”€â”€ 10. å·¥å…·ä¸ç›‘æ§
    â”œâ”€â”€ Statistics Collector (ç»Ÿè®¡æ”¶é›†)
    â”œâ”€â”€ pg_stat_* è§†å›¾
    â”œâ”€â”€ Logging (æ—¥å¿—ç³»ç»Ÿ)
    â””â”€â”€ Background Writer (åå°å†™)
```

### 5.2 æ ¸å¿ƒæ¨¡å—ä¼˜å…ˆçº§

æ ¹æ®é‡è¦æ€§å’Œä¾èµ–å…³ç³»ï¼Œæ¨èå­¦ä¹ é¡ºåºï¼š

| ä¼˜å…ˆçº§ | æ¨¡å—å | é‡è¦æ€§ | å¤æ‚åº¦ | ç›®å½•å |
|-------|--------|--------|--------|--------|
| ğŸ”´ P0 | **Checkpoint** | â­â­â­â­â­ | â­â­â­â­ | âœ… `checkpoint/` (å·²å®Œæˆ) |
| ğŸ”´ P0 | **WAL (Write-Ahead Log)** | â­â­â­â­â­ | â­â­â­â­â­ | `wal/` |
| ğŸ”´ P0 | **Buffer Manager** | â­â­â­â­â­ | â­â­â­â­â­ | `buffer_manager/` |
| ğŸ”´ P0 | **MVCC** | â­â­â­â­â­ | â­â­â­â­â­ | `mvcc/` |
| ğŸŸ  P1 | **Transaction Manager** | â­â­â­â­â­ | â­â­â­â­ | `transaction/` |
| ğŸŸ  P1 | **Lock Manager** | â­â­â­â­ | â­â­â­â­ | `lock/` |
| ğŸŸ  P1 | **VACUUM** | â­â­â­â­â­ | â­â­â­â­ | `vacuum/` |
| ğŸŸ  P1 | **Executor** | â­â­â­â­â­ | â­â­â­â­â­ | `executor/` |
| ğŸŸ¡ P2 | **Planner/Optimizer** | â­â­â­â­â­ | â­â­â­â­â­ | `planner/` |
| ğŸŸ¡ P2 | **B-Tree Index** | â­â­â­â­ | â­â­â­â­ | `btree/` |
| ğŸŸ¡ P2 | **Heap Access Method** | â­â­â­â­ | â­â­â­â­ | `heap/` |
| ğŸŸ¡ P2 | **Storage Manager** | â­â­â­â­ | â­â­â­ | `storage/` |
| ğŸŸ¢ P3 | **Parser** | â­â­â­ | â­â­â­â­ | `parser/` |
| ğŸŸ¢ P3 | **Replication** | â­â­â­â­ | â­â­â­â­ | `replication/` |
| ğŸŸ¢ P3 | **å…¶ä»–ç´¢å¼•ç±»å‹** | â­â­â­ | â­â­â­ | `indexes/` |

---

## å…­ã€æ¨¡å—ä¾èµ–å…³ç³»

### 6.1 ä¾èµ–å…³ç³»å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SQL æŸ¥è¯¢å±‚     â”‚
                    â”‚  (Parser/       â”‚
                    â”‚   Planner/      â”‚
                    â”‚   Executor)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
                â–¼            â–¼            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Transactionâ”‚ â”‚   MVCC     â”‚ â”‚   Lock     â”‚
        â”‚  Manager   â”‚ â”‚            â”‚ â”‚  Manager   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Buffer Managerâ”‚  â”‚  WAL System   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚                 â”‚
                      â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Checkpoint â”‚   â”‚   Storage   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   Manager   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  File System    â”‚
                              â”‚  (OS)           â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ ¸å¿ƒä¾èµ–è¯´æ˜

#### 6.2.1 WAL â†’ Buffer Manager
- **ä¾èµ–**: WAL å¿…é¡»å…ˆå†™å…¥ï¼Œæ‰èƒ½ä¿®æ”¹ç¼“å†²æ± ä¸­çš„é¡µé¢
- **åŸå› **: Write-Ahead Logging åŸåˆ™
- **ä½“ç°**: `MarkBufferDirty()` å‰å¿…é¡»è°ƒç”¨ `XLogInsert()`

#### 6.2.2 Checkpoint â†’ WAL + Buffer Manager
- **ä¾èµ–**: Checkpoint ä¾èµ– WAL çš„ REDO ç‚¹å’Œ Buffer Manager çš„è„é¡µåˆ·å†™
- **ä½“ç°**: `CreateCheckPoint()` è°ƒç”¨ `BufferSync()` å’Œ `XLogInsert()`

#### 6.2.3 MVCC â†’ Transaction Manager
- **ä¾èµ–**: MVCC é€šè¿‡äº‹åŠ¡ ID (XID) åˆ¤æ–­å…ƒç»„å¯è§æ€§
- **ä½“ç°**: `HeapTupleSatisfiesMVCC()` æ£€æŸ¥ `t_xmin` å’Œ `t_xmax`

#### 6.2.4 Executor â†’ æ‰€æœ‰ä¸‹å±‚æ¨¡å—
- **ä¾èµ–**: æ‰§è¡Œå™¨è°ƒç”¨æ‰€æœ‰å­˜å‚¨å±‚å’Œäº‹åŠ¡å±‚åŠŸèƒ½
- **ä½“ç°**: `ExecScan()` â†’ `heap_getnext()` â†’ `ReadBuffer()` â†’ `BufferAlloc()`

---

## ä¸ƒã€æ•°æ®æµè½¬å…¨æ™¯

### 7.1 å†™äº‹åŠ¡å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Client Application                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ INSERT INTO t VALUES (1, 'data')
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Backend Process: Parser â†’ Planner â†’ Executor            â”‚
â”‚    src/backend/tcop/postgres.c:1053 exec_simple_query()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Transaction Manager: å¼€å§‹äº‹åŠ¡ï¼Œåˆ†é… XID                  â”‚
â”‚    src/backend/access/transam/xact.c:350 GetCurrentTransactionId()
â”‚    XID = 1000                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Heap Access: æ‰¾åˆ°å¯æ’å…¥çš„é¡µé¢                            â”‚
â”‚    src/backend/access/heap/heapam.c:2000 heap_insert()     â”‚
â”‚    - é€šè¿‡ FSM æŸ¥æ‰¾æœ‰ç©ºé—²ç©ºé—´çš„é¡µé¢                          â”‚
â”‚    - æˆ–è€…æ‰©å±•æ–°é¡µé¢                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Buffer Manager: å°†é¡µé¢è¯»å…¥ç¼“å†²æ±                          â”‚
â”‚    src/backend/storage/buffer/bufmgr.c:800 ReadBuffer()    â”‚
â”‚    - æ£€æŸ¥ shared_buffers ä¸­æ˜¯å¦å­˜åœ¨                         â”‚
â”‚    - å¦‚ä¸å­˜åœ¨ï¼Œä»ç£ç›˜è¯»å–                                    â”‚
â”‚    - è·å– Buffer ä¸Šçš„ Exclusive Lock                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. WAL System: ç”Ÿæˆå¹¶å†™å…¥ WAL è®°å½•                          â”‚
â”‚    src/backend/access/transam/xlog.c:950 XLogInsert()      â”‚
â”‚    WAL Record:                                              â”‚
â”‚    - Type: RM_HEAP_ID, XLOG_HEAP_INSERT                    â”‚
â”‚    - XID: 1000                                              â”‚
â”‚    - Data: æ’å…¥çš„å…ƒç»„æ•°æ®                                    â”‚
â”‚    - LSN: 0/1A000128 (æ–° WAL ä½ç½®)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Buffer Manager: ä¿®æ”¹ç¼“å†²æ± ä¸­çš„é¡µé¢                       â”‚
â”‚    - è®¾ç½®é¡µé¢ LSN = 0/1A000128                              â”‚
â”‚    - æ’å…¥æ–°å…ƒç»„ï¼Œè®¾ç½® t_xmin = 1000                          â”‚
â”‚    - MarkBufferDirty() æ ‡è®°ä¸ºè„é¡µ                           â”‚
â”‚    - é‡Šæ”¾ Buffer Lock                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Transaction Manager: æäº¤äº‹åŠ¡                            â”‚
â”‚    src/backend/access/transam/xact.c:2100 CommitTransaction()
â”‚    - å†™å…¥ COMMIT WAL è®°å½•                                    â”‚
â”‚    - æ ‡è®° XID=1000 ä¸º COMMITTED (åœ¨ CLOG ä¸­)                â”‚
â”‚    - é‡Šæ”¾é”                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Backend: è¿”å›ç»“æœç»™å®¢æˆ·ç«¯                                â”‚
â”‚    "INSERT 0 1"                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                   (å¼‚æ­¥åå°)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. WAL Writer: å¼‚æ­¥åˆ·å†™ WAL ç¼“å†²åŒºåˆ°ç£ç›˜                    â”‚
â”‚    src/backend/postmaster/walwriter.c:300 WalWriterMain()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                   (å‘¨æœŸæ€§åå°)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Checkpointer: åˆ·å†™è„é¡µåˆ°ç£ç›˜                            â”‚
â”‚     src/backend/postmaster/checkpointer.c:400              â”‚
â”‚     - BufferSync() æ‰«æå¹¶å†™å…¥æ‰€æœ‰è„é¡µ                       â”‚
â”‚     - æ›´æ–° pg_control                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è¯»äº‹åŠ¡å®Œæ•´æµç¨‹

```
Client: SELECT * FROM t WHERE id = 1;
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Backend: Parser â†’ Planner           â”‚
â”‚    ç”Ÿæˆæ‰§è¡Œè®¡åˆ’: SeqScan æˆ– IndexScan   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Snapshot Manager: è·å–å¿«ç…§           â”‚
â”‚    src/backend/utils/time/snapmgr.c    â”‚
â”‚    Snapshot {                           â”‚
â”‚      xmin: 995,  // æœ€å°æ´»è·ƒäº‹åŠ¡        â”‚
â”‚      xmax: 1005, // ä¸‹ä¸€ä¸ª XID          â”‚
â”‚      xip: [998, 1001, 1003] // æ´»è·ƒäº‹åŠ¡ â”‚
â”‚    }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Executor: æ‰«æè¡¨                     â”‚
â”‚    src/backend/executor/nodeSeqscan.c  â”‚
â”‚    è°ƒç”¨ heap_getnext() é€è¡Œè¯»å–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ (å¯¹æ¯ä¸€è¡Œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Buffer Manager: ReadBuffer()        â”‚
â”‚    - åœ¨ shared_buffers ä¸­æŸ¥æ‰¾           â”‚
â”‚    - Cache Hit: ç›´æ¥è¿”å›                â”‚
â”‚    - Cache Miss: ä»ç£ç›˜è¯»å–             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. MVCC: æ£€æŸ¥å…ƒç»„å¯è§æ€§                 â”‚
â”‚    HeapTupleSatisfiesMVCC()            â”‚
â”‚    æ£€æŸ¥ t_xmin, t_xmax æ˜¯å¦å¯¹å¿«ç…§å¯è§   â”‚
â”‚    - t_xmin = 990 (< xmin) â†’ å¯è§      â”‚
â”‚    - t_xmin = 1003 (åœ¨ xip ä¸­) â†’ ä¸å¯è§â”‚
â”‚    - t_xmax æ£€æŸ¥ç±»ä¼¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Executor: åº”ç”¨è¿‡æ»¤æ¡ä»¶ (WHERE)       â”‚
â”‚    å¦‚æœæ»¡è¶³ï¼ŒåŠ å…¥ç»“æœé›†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Backend: è¿”å›ç»“æœç»™å®¢æˆ·ç«¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å´©æºƒæ¢å¤æµç¨‹

```
ç³»ç»Ÿå´©æºƒ
    â”‚
    â–¼
PostgreSQL é‡å¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Postmaster: è¯»å– pg_control          â”‚
â”‚    - checkPoint: 0/1A000000 (LSN)      â”‚
â”‚    - redo: 0/19FFF000 (REDO ç‚¹)        â”‚
â”‚    - state: DB_IN_CRASH_RECOVERY       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Startup Process: è¿›å…¥æ¢å¤æ¨¡å¼        â”‚
â”‚    src/backend/access/transam/xlog.c   â”‚
â”‚    StartupXLOG()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä» REDO ç‚¹å¼€å§‹è¯»å– WAL               â”‚
â”‚    LSN = 0/19FFF000                     â”‚
â”‚    æ‰“å¼€ WAL æ–‡ä»¶: 00000001000000000019  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ (å¯¹æ¯æ¡ WAL è®°å½•)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é‡æ”¾ WAL è®°å½•                        â”‚
â”‚    è°ƒç”¨å¯¹åº”èµ„æºç®¡ç†å™¨çš„ redo å‡½æ•°        â”‚
â”‚    ä¾‹å¦‚:                                 â”‚
â”‚    - RM_HEAP_ID â†’ heap_redo()           â”‚
â”‚    - RM_BTREE_ID â†’ btree_redo()         â”‚
â”‚                                         â”‚
â”‚    æ“ä½œ:                                 â”‚
â”‚    - è¯»å–é¡µé¢åˆ°ç¼“å†²æ±                     â”‚
â”‚    - åº”ç”¨ WAL è®°å½•ä¸­çš„ä¿®æ”¹               â”‚
â”‚    - æ ‡è®°ä¸ºè„é¡µ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ç»§ç»­é‡æ”¾ç›´åˆ° WAL ç»“æŸ                 â”‚
â”‚    LSN = 0/1A023456 (æœ€åä¸€æ¡è®°å½•)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åˆ·å†™æ‰€æœ‰è„é¡µåˆ°ç£ç›˜                    â”‚
â”‚    FlushBufferPool()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ‰§è¡Œ End-of-Recovery Checkpoint      â”‚
â”‚    CreateCheckPoint(CHECKPOINT_END_OF_RECOVERY)
â”‚    - åˆ·å†™æ‰€æœ‰è„é¡µ                        â”‚
â”‚    - è®°å½•æ–°çš„ checkpoint ç‚¹              â”‚
â”‚    - æ›´æ–° pg_control                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. è¿›å…¥æ­£å¸¸è¿è¡ŒçŠ¶æ€                      â”‚
â”‚    state: DB_IN_PRODUCTION              â”‚
â”‚    å¼€å§‹æ¥å—å®¢æˆ·ç«¯è¿æ¥                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€æ–‡æ¡£å¯¼èˆª

### 8.1 å·²å®Œæˆæ–‡æ¡£

| æ¨¡å— | æ–‡æ¡£è·¯å¾„ | çŠ¶æ€ | å†…å®¹ |
|------|----------|------|------|
| **Checkpoint** | `studydoc/checkpoint/` | âœ… å®Œæˆ | 8 ç¯‡æ–‡æ¡£ï¼Œ223KBï¼ŒåŒ…å« 18 ä¸ªå›¾è¡¨å’Œ 65+ æµ‹è¯•ç”¨ä¾‹ |

### 8.2 è®¡åˆ’åˆ›å»ºçš„æ–‡æ¡£

åŸºäºä¼˜å…ˆçº§ P0-P3ï¼Œæˆ‘ä»¬å°†æŒ‰ä»¥ä¸‹é¡ºåºåˆ›å»ºæ¨¡å—æ–‡æ¡£ï¼š

#### ğŸ”´ ç¬¬ä¸€æ‰¹ (P0 - æ ¸å¿ƒåŸºç¡€æ¨¡å—)

| æ¨¡å— | ç›®å½• | é¢„è®¡é¡µæ•° | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| **WAL (Write-Ahead Log)** | `studydoc/wal/` | ~250KB | P0 |
| **Buffer Manager** | `studydoc/buffer_manager/` | ~230KB | P0 |
| **MVCC** | `studydoc/mvcc/` | ~220KB | P0 |

#### ğŸŸ  ç¬¬äºŒæ‰¹ (P1 - æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)

| æ¨¡å— | ç›®å½• | é¢„è®¡é¡µæ•° | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| **Transaction Manager** | `studydoc/transaction/` | ~200KB | P1 |
| **Lock Manager** | `studydoc/lock/` | ~180KB | P1 |
| **VACUUM** | `studydoc/vacuum/` | ~210KB | P1 |
| **Executor** | `studydoc/executor/` | ~280KB | P1 |

#### ğŸŸ¡ ç¬¬ä¸‰æ‰¹ (P2 - é‡è¦æ¨¡å—)

| æ¨¡å— | ç›®å½• | é¢„è®¡é¡µæ•° | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| **Planner/Optimizer** | `studydoc/planner/` | ~300KB | P2 |
| **B-Tree Index** | `studydoc/btree/` | ~200KB | P2 |
| **Heap Access** | `studydoc/heap/` | ~180KB | P2 |
| **Storage Manager** | `studydoc/storage/` | ~150KB | P2 |

#### ğŸŸ¢ ç¬¬å››æ‰¹ (P3 - æ‰©å±•æ¨¡å—)

| æ¨¡å— | ç›®å½• | é¢„è®¡é¡µæ•° | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| **Parser** | `studydoc/parser/` | ~120KB | P3 |
| **Replication** | `studydoc/replication/` | ~200KB | P3 |
| **å…¶ä»–ç´¢å¼•** | `studydoc/indexes/` | ~180KB | P3 |

### 8.3 æ–‡æ¡£ç»“æ„æ ‡å‡†

æ¯ä¸ªæ¨¡å—æ–‡æ¡£å°†åŒ…å«ä»¥ä¸‹æ ‡å‡†ç»“æ„ï¼ˆå‚ç…§ Checkpoint æ¨¡å—ï¼‰ï¼š

```
æ¨¡å—åç§°/
â”œâ”€â”€ 01_overview.md              # æ¦‚è¿°ä¸æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ 02_data_structures.md       # æ ¸å¿ƒæ•°æ®ç»“æ„è¯¦è§£
â”œâ”€â”€ 03_implementation_flow.md   # å®ç°æµç¨‹åˆ†æ
â”œâ”€â”€ 04_key_algorithms.md        # å…³é”®ç®—æ³•ä¸å¤æ‚åº¦
â”œâ”€â”€ 05_performance.md           # æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
â”œâ”€â”€ 06_testcases.md             # éªŒè¯æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ 07_diagrams.md              # å¯è§†åŒ–å›¾è¡¨é›†
â””â”€â”€ README.md                   # æ¨¡å—å¯¼èˆªä¸æ€»è§ˆ
```

æ¯ä¸ªæ–‡æ¡£è¦æ±‚ï¼š
1. âœ… **å®Œæ•´æ€§**: è¦†ç›–æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå’Œå®ç°ç»†èŠ‚
2. âœ… **å¯è§†åŒ–**: åŒ…å«ä¸°å¯Œçš„ ASCII å›¾è¡¨å’Œæµç¨‹å›¾
3. âœ… **ç¤ºä¾‹**: æä¾›å¤§é‡å¯æ‰§è¡Œçš„ä»£ç å’Œ SQL ç¤ºä¾‹
4. âœ… **æºç å®šä½**: æ ‡æ³¨å…·ä½“æ–‡ä»¶å’Œè¡Œå·
5. âœ… **æµ‹è¯•ç”¨ä¾‹**: åŒ…å«å¯éªŒè¯çš„æµ‹è¯•è„šæœ¬

---

## é™„å½•ï¼šæºç ç›®å½•æ˜ å°„

### A.1 Backend ä¸»è¦ç›®å½•

| ç›®å½• | æ¨¡å— | è¯´æ˜ |
|------|------|------|
| `src/backend/access/` | è®¿é—®æ–¹æ³• | heap, btree, gin, gist ç­‰ |
| `src/backend/storage/` | å­˜å‚¨ç®¡ç† | buffer, file, smgr, lmgr |
| `src/backend/access/transam/` | äº‹åŠ¡ç®¡ç† | xlog, xact, clog, mvcc |
| `src/backend/postmaster/` | è¿›ç¨‹ç®¡ç† | postmaster, checkpointer, walwriter |
| `src/backend/executor/` | æ‰§è¡Œå™¨ | å„ç±»æ‰§è¡ŒèŠ‚ç‚¹ |
| `src/backend/optimizer/` | ä¼˜åŒ–å™¨ | planner, path, plan |
| `src/backend/parser/` | è§£æå™¨ | gram.y, scan.l |
| `src/backend/commands/` | DDL å‘½ä»¤ | CREATE, ALTER, DROP |
| `src/backend/catalog/` | ç³»ç»Ÿç›®å½• | ç³»ç»Ÿè¡¨ç®¡ç† |
| `src/backend/utils/` | å·¥å…·å‡½æ•° | adt, cache, mmgr, time |
| `src/backend/replication/` | å¤åˆ¶ | walsender, walreceiver |

### A.2 Include ä¸»è¦ç›®å½•

| ç›®å½• | è¯´æ˜ |
|------|------|
| `src/include/access/` | è®¿é—®æ–¹æ³•å¤´æ–‡ä»¶ |
| `src/include/storage/` | å­˜å‚¨ç®¡ç†å¤´æ–‡ä»¶ |
| `src/include/catalog/` | ç³»ç»Ÿè¡¨å®šä¹‰ (pg_*.h) |
| `src/include/nodes/` | èŠ‚ç‚¹ç±»å‹å®šä¹‰ |
| `src/include/postmaster/` | è¿›ç¨‹ç®¡ç†å¤´æ–‡ä»¶ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åŸºäºæºç **: PostgreSQL 17.5
**åˆ›å»ºæ—¥æœŸ**: 2025-01-15

**ä¸‹ä¸€æ­¥**: å¼€å§‹åˆ›å»º `WAL` æ¨¡å—å®Œæ•´åˆ†ææ–‡æ¡£
