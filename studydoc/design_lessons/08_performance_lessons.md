# ä»PostgreSQLå­¦ä¹ æ€§èƒ½ä¼˜åŒ– (å¢å¼ºç‰ˆ)

> PostgreSQLæºç ä¸­çš„æ€§èƒ½ä¼˜åŒ–æ™ºæ…§å…¨æ™¯ - å¸¦éªŒè¯æ–¹æ³•

**ç‰ˆæœ¬**: PostgreSQL 17.6  
**æœ€åæ›´æ–°**: 2025-10-17

---

## ğŸ“‘ ç›®å½•

1. [I/Oä¼˜åŒ–æŠ€å·§](#1-ioä¼˜åŒ–æŠ€å·§)
2. [å†…å­˜ä¼˜åŒ–æŠ€å·§](#2-å†…å­˜ä¼˜åŒ–æŠ€å·§)
3. [CPUä¼˜åŒ–æŠ€å·§](#3-cpuä¼˜åŒ–æŠ€å·§)
4. [å¹¶å‘ä¼˜åŒ–æŠ€å·§](#4-å¹¶å‘ä¼˜åŒ–æŠ€å·§)
5. [æ•°æ®ç»“æ„ä¼˜åŒ–](#5-æ•°æ®ç»“æ„ä¼˜åŒ–)
6. [ç®—æ³•ä¼˜åŒ–](#6-ç®—æ³•ä¼˜åŒ–)
7. [ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–](#7-ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–)
8. [æ€§èƒ½ä¼˜åŒ–æ–¹æ³•è®º](#8-æ€§èƒ½ä¼˜åŒ–æ–¹æ³•è®º)
9. [éªŒè¯æ–¹æ³•æ±‡æ€»](#9-éªŒè¯æ–¹æ³•æ±‡æ€»)

---

## 1. I/Oä¼˜åŒ–æŠ€å·§

### 1.1 é¡ºåºå†™ä¼˜åŒ– (WAL)

#### æ ¸å¿ƒæ€æƒ³

é¡ºåºå†™æ¯”éšæœºå†™å¿«**100å€+** (HDD) æˆ– **10å€+** (SSD)

#### è¯¦ç»†å›¾è§£

```
ã€éšæœºå†™æ•°æ®é¡µã€‘- éœ€è¦é¢‘ç¹å¯»é“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç£ç›˜å¸ƒå±€ (1TB)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  100MB: [Page 1]  â†â”€ å†™å…¥                              â”‚
â”‚                     â†“                                   â”‚
â”‚                     ç£å¤´ç§»åŠ¨ 400MB! (å¯»é“ 8ms)          â”‚
â”‚  500MB: [Page 2]  â†â”€ å†™å…¥                              â”‚
â”‚                     â†“                                   â”‚
â”‚                     ç£å¤´ç§»åŠ¨ 300MB! (å¯»é“ 6ms)          â”‚
â”‚  200MB: [Page 3]  â†â”€ å†™å…¥                              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»æ—¶é—´ = 3æ¬¡å†™å…¥(3ms) + 2æ¬¡å¯»é“(14ms) = 17ms
å†™å…¥é€Ÿåº¦ â‰ˆ 24KB / 17ms â‰ˆ 1.4 MB/s

ã€é¡ºåºå†™WALã€‘- è¿½åŠ å†™å…¥ï¼Œæ— éœ€å¯»é“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WALæ–‡ä»¶å¸ƒå±€                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Offset:                                                â”‚
â”‚  0MB:    [WAL Record 1 (8KB)]                          â”‚
â”‚  0.008MB:[WAL Record 2 (8KB)]  â† é¡ºåºè¿½åŠ               â”‚
â”‚  0.016MB:[WAL Record 3 (8KB)]  â† é¡ºåºè¿½åŠ               â”‚
â”‚          ...                                            â”‚
â”‚  16MB:   [æ–°WALæ®µæ–‡ä»¶]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»æ—¶é—´ = 3æ¬¡å†™å…¥(3ms) + 0æ¬¡å¯»é“(0ms) = 3ms
å†™å…¥é€Ÿåº¦ â‰ˆ 24KB / 3ms â‰ˆ 8 MB/s

æ€§èƒ½æå‡: 8 / 1.4 â‰ˆ 5.7å€ (SSDæ›´æ˜æ˜¾!)
```

#### PostgreSQLæºç å®ç°

**æ–‡ä»¶**: `src/backend/access/transam/xlog.c`

```c
/*
 * XLogWrite() - å°†WALç¼“å†²åŒºå†™å…¥ç£ç›˜
 * 
 * æ ¸å¿ƒä¼˜åŒ–:
 * 1. é¡ºåºè¿½åŠ å†™å…¥WALæ–‡ä»¶
 * 2. ä½¿ç”¨write()ç³»ç»Ÿè°ƒç”¨æ‰¹é‡å†™å…¥
 * 3. fsync()ç¡®ä¿æŒä¹…åŒ–
 */
static void
XLogWrite(XLogwrtRqst WriteRqst, TimeLineID tli, bool flexible)
{
    bool        ispartialpage;
    XLogRecPtr  LogwrtResult;
    
    /* å¾ªç¯å†™å…¥æ‰€æœ‰éœ€è¦åˆ·ç›˜çš„WALç¼“å†²åŒº */
    while (XLogCtl->LogwrtResult < WriteRqst.Flush)
    {
        /*
         * è®¡ç®—è¦å†™å…¥çš„å­—èŠ‚æ•°
         * ä¼˜åŒ–: å°½å¯èƒ½å¤šåœ°æ‰¹é‡å†™å…¥ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
         */
        Size nbytes = /* ... */;
        
        /*
         * é¡ºåºå†™å…¥WALæ–‡ä»¶
         * ä¼˜åŒ–: å§‹ç»ˆè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œæ— éœ€lseek()
         */
        errno = 0;
        pgstat_report_wait_start(WAIT_EVENT_WAL_WRITE);
        written = write(openLogFile, from, nbytes);  // â† é¡ºåºå†™
        pgstat_report_wait_end();
        
        /* ... é”™è¯¯å¤„ç† ... */
    }
    
    /*
     * fsync()åˆ·ç›˜
     * æ³¨æ„: è¿™æ˜¯å”¯ä¸€éœ€è¦ç­‰å¾…çš„åœ°æ–¹
     */
    issue_xlog_fsync(openLogFile, openLogSegNo, tli);
}
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: ä½¿ç”¨fioåŸºå‡†æµ‹è¯•**

```bash
# æµ‹è¯•éšæœºå†™ (æ¨¡æ‹Ÿæ•°æ®é¡µå†™å…¥)
fio --name=random_write \
    --ioengine=psync \
    --rw=randwrite \
    --bs=8k \
    --size=1G \
    --numjobs=1 \
    --runtime=60 \
    --group_reporting

# è¾“å‡ºç¤ºä¾‹:
# WRITE: bw=15.2MiB/s, iops=1948

# æµ‹è¯•é¡ºåºå†™ (æ¨¡æ‹ŸWALå†™å…¥)
fio --name=seq_write \
    --ioengine=psync \
    --rw=write \
    --bs=8k \
    --size=1G \
    --numjobs=1 \
    --runtime=60 \
    --group_reporting

# è¾“å‡ºç¤ºä¾‹:
# WRITE: bw=156MiB/s, iops=19968

# æ€§èƒ½å¯¹æ¯”: 156 / 15.2 â‰ˆ 10.3å€æå‡!
```

**æ–¹æ³•2: PostgreSQLç»Ÿè®¡ä¿¡æ¯**

```sql
-- æŸ¥çœ‹WALå†™å…¥ç»Ÿè®¡
SELECT 
    pg_current_wal_lsn(),                   -- å½“å‰WALä½ç½®
    pg_wal_lsn_diff(
        pg_current_wal_lsn(), 
        '0/0'
    ) / 1024 / 1024 AS wal_mb_written,      -- æ€»å†™å…¥MB
    
    -- æŸ¥çœ‹WALå†™å…¥é€Ÿç‡
    pg_stat_get_wal_buffers_full() AS wal_buffers_full;

-- ç›‘æ§WALå†™å…¥æ€§èƒ½
SELECT 
    checkpoints_timed,          -- å®šæ—¶æ£€æŸ¥ç‚¹
    checkpoints_req,            -- è¯·æ±‚æ£€æŸ¥ç‚¹
    buffers_checkpoint,         -- æ£€æŸ¥ç‚¹å†™å…¥ç¼“å†²åŒºæ•°
    buffers_backend,            -- åç«¯è¿›ç¨‹å†™å…¥
    buffers_backend_fsync       -- åç«¯fsyncæ¬¡æ•°
FROM pg_stat_bgwriter;
```

**æ–¹æ³•3: straceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨**

```bash
# è·Ÿè¸ªPostgreSQLçš„WALå†™å…¥
sudo strace -f -e trace=write,fsync -p <postgres_pid> 2>&1 | grep wal

# è§‚å¯Ÿè¾“å‡º:
# write(4, "...", 8192) = 8192    â† é¡ºåºå†™å…¥
# write(4, "...", 8192) = 8192    â† é¡ºåºå†™å…¥
# fsync(4) = 0                     â† æ‰¹é‡åŒæ­¥
```

---

### 1.2 æ‰¹é‡åˆ·ç›˜ (Group Commit)

#### é—®é¢˜åˆ†æ

æ¯ä¸ªäº‹åŠ¡ç‹¬ç«‹fsync = å·¨å¤§æ€§èƒ½æŸå¤±

#### è¯¦ç»†å›¾è§£

```
ã€ä¼ ç»Ÿæ–¹å¼ - æ¯äº‹åŠ¡ä¸€æ¬¡fsyncã€‘
æ—¶é—´è½´ â†’
t=0ms    t=1ms    t=2ms    t=3ms
  â†“        â†“        â†“        â†“
â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”
â”‚ T1 â”‚â”€â”€â”€â†’fsyncâ”‚   â”‚    â”‚
â”‚BEGIN    (1ms)   â”‚    â”‚
â”‚COMMITâ”‚          â”‚    â”‚
â””â”€â”€â”€â”€â”˜           â”‚    â”‚
                  â”‚    â”‚
â”Œâ”€â”€â”€â”€â”            â”‚    â”‚
â”‚ T2 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’fsyncâ”‚
â”‚BEGIN             (1ms)â”‚
â”‚COMMITâ”‚               â”‚
â””â”€â”€â”€â”€â”˜                 â”‚
                        â”‚
â”Œâ”€â”€â”€â”€â”                 â”‚
â”‚ T3 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’fsync
â”‚BEGIN                  (1ms)
â”‚COMMITâ”‚
â””â”€â”€â”€â”€â”˜

æ€»æ—¶é—´: 3ms
ååé‡: 1000 TPS

ã€Group Commit - æ‰¹é‡fsyncã€‘
æ—¶é—´è½´ â†’
t=0ms         t=1ms
  â†“             â†“
â”Œâ”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T1 â”‚â”€â”€â”     â”‚              â”‚
â”‚BEGIN â”‚  â”‚     â”‚   Group      â”‚
â”‚COMMITâ”‚  â”œâ”€â”€â”€â”€â†’â”‚   fsync      â”‚
â””â”€â”€â”€â”€â”˜  â”‚     â”‚   (1ms)      â”‚
        â”‚     â”‚              â”‚
â”Œâ”€â”€â”€â”€â”  â”‚     â”‚   ä¸€æ¬¡æ€§åˆ·ç›˜ â”‚
â”‚ T2 â”‚â”€â”€â”¤     â”‚   3ä¸ªäº‹åŠ¡    â”‚
â”‚BEGIN â”‚  â”‚     â”‚              â”‚
â”‚COMMITâ”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”˜  â”‚
        â”‚
â”Œâ”€â”€â”€â”€â”  â”‚
â”‚ T3 â”‚â”€â”€â”˜
â”‚BEGIN â”‚
â”‚COMMITâ”‚
â””â”€â”€â”€â”€â”˜

æ€»æ—¶é—´: 1ms
ååé‡: 3000 TPS

æ€§èƒ½æå‡: 3000 / 1000 = 3å€
```

#### PostgreSQLæºç å®ç°

**æ–‡ä»¶**: `src/backend/access/transam/xlog.c:2779`

```c
/*
 * XLogFlush - å°†WALåˆ·æ–°åˆ°æŒ‡å®šLSN
 * 
 * Group Commitæ ¸å¿ƒå®ç°:
 * 1. æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å…¶ä»–è¿›ç¨‹åˆ·ç›˜
 * 2. å°è¯•è·å–WALWriteLock
 * 3. ç­‰å¾…å…¶ä»–è¿›ç¨‹æ—¶ï¼Œå®ƒä»¬å¯èƒ½å·²å®Œæˆåˆ·ç›˜
 */
void
XLogFlush(XLogRecPtr record)
{
    XLogRecPtr  WriteRqstPtr;
    XLogwrtRqst WriteRqst;
    TimeLineID  insertTLI = XLogCtl->InsertTimeLineID;
    
    /* å¿«é€Ÿè·¯å¾„: æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å…¶ä»–è¿›ç¨‹åˆ·ç›˜ */
    if (record <= LogwrtResult.Flush)
        return;  // â† Group Commitç”Ÿæ•ˆ! æ— éœ€å†æ¬¡åˆ·ç›˜
    
    /*
     * å°è¯•è·å–WALWriteLock
     * å¦‚æœè·å–å¤±è´¥ï¼Œç­‰å¾…æ—¶å…¶ä»–è¿›ç¨‹å¯èƒ½å®Œæˆåˆ·ç›˜
     */
    if (!LWLockAcquireOrWait(WALWriteLock, LW_EXCLUSIVE))
    {
        /*
         * ç­‰å¾…é”æ—¶ï¼ŒæŒæœ‰é”çš„è¿›ç¨‹å¯èƒ½å·²å®Œæˆåˆ·ç›˜
         * è¿™æ˜¯Group Commitçš„æ ¸å¿ƒæœºåˆ¶!
         */
        LWLockAcquire(WALWriteLock, LW_EXCLUSIVE);
        
        /* å†æ¬¡æ£€æŸ¥ - å¯èƒ½å·²è¢«åˆ·ç›˜ */
        if (record <= LogwrtResult.Flush)
        {
            LWLockRelease(WALWriteLock);
            return;  // â† å·²è¢«å…¶ä»–è¿›ç¨‹åˆ·ç›˜!
        }
    }
    
    /*
     * commit_delay: ä¸»åŠ¨å»¶è¿Ÿï¼Œå¢åŠ Group Commitæœºä¼š
     * 
     * é…ç½®: commit_delay = 10 å¾®ç§’ (é»˜è®¤0)
     *       commit_siblings = 5 (é»˜è®¤5)
     * 
     * å«ä¹‰: å¦‚æœæœ‰5+ä¸ªæ´»è·ƒäº‹åŠ¡ï¼Œå»¶è¿Ÿ10usç­‰æ›´å¤šäº‹åŠ¡åŠ å…¥
     */
    if (CommitDelay > 0 && enableFsync &&
        CountActiveBackends() >= CommitSiblings)
    {
        pg_usleep(CommitDelay);  // â† ä¸»åŠ¨ç­‰å¾…æ›´å¤šäº‹åŠ¡
    }
    
    /* æ‰§è¡Œå®é™…çš„WALå†™å…¥å’Œfsync */
    XLogWrite(WriteRqst, insertTLI, false);
    
    LWLockRelease(WALWriteLock);
}
```

#### å…³é”®æœºåˆ¶

```
Group Commitè§¦å‘æ¡ä»¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚  è¿›ç¨‹1æŒæœ‰WALWriteLock                            â”‚
â”‚    â”‚                                              â”‚
â”‚    â”œâ”€â”€â†’ æ­£åœ¨æ‰§è¡Œ XLogWrite + fsync               â”‚
â”‚    â”‚                                              â”‚
â”‚  è¿›ç¨‹2,3,4,5ç­‰å¾…WALWriteLock â†â”€â”                 â”‚
â”‚    â”‚                            â”‚                 â”‚
â”‚    â”‚                            â””â”€ Groupç­‰å¾…      â”‚
â”‚    â”‚                                              â”‚
â”‚  è¿›ç¨‹1å®Œæˆfsyncï¼Œé‡Šæ”¾é”                           â”‚
â”‚    â”‚                                              â”‚
â”‚  è¿›ç¨‹2è·å–é”ï¼Œæ£€æŸ¥LogwrtResult.Flush              â”‚
â”‚    â”‚                                              â”‚
â”‚    â””â”€â”€â†’ å‘ç°å·²ç»è¢«è¿›ç¨‹1åˆ·ç›˜ï¼Œç›´æ¥è¿”å›!           â”‚
â”‚                                                   â”‚
â”‚  è¿›ç¨‹3,4,5åŒæ ·æ£€æŸ¥å¹¶è¿”å›                          â”‚
â”‚                                                   â”‚
â”‚  ç»“æœ: 5ä¸ªäº‹åŠ¡åªæ‰§è¡Œäº†1æ¬¡fsync!                   â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: pgbenchåŸºå‡†æµ‹è¯•**

```bash
# æµ‹è¯•1: ä¸ä½¿ç”¨Group Commit (commit_delay=0)
psql -c "ALTER SYSTEM SET commit_delay = 0"
psql -c "SELECT pg_reload_conf()"

pgbench -i -s 10 testdb
pgbench -c 10 -j 4 -T 60 testdb

# è¾“å‡º:
# tps = 1523.456789 (including connections establishing)

# æµ‹è¯•2: å¯ç”¨Group Commit (commit_delay=10us)
psql -c "ALTER SYSTEM SET commit_delay = 10"
psql -c "ALTER SYSTEM SET commit_siblings = 2"
psql -c "SELECT pg_reload_conf()"

pgbench -c 10 -j 4 -T 60 testdb

# è¾“å‡º:
# tps = 2845.123456 (including connections establishing)

# æ€§èƒ½æå‡: 2845 / 1523 â‰ˆ 1.87å€
```

**æ–¹æ³•2: ç›‘æ§fsyncæ¬¡æ•°**

```bash
# ä½¿ç”¨straceç»Ÿè®¡fsyncè°ƒç”¨
sudo strace -c -f -e trace=fsync -p <postgres_pid>

# ä¸ä½¿ç”¨Group Commit:
# fsync calls: ~1500æ¬¡ (60ç§’)

# ä½¿ç”¨Group Commit:
# fsync calls: ~800æ¬¡ (60ç§’)

# fsyncå‡å°‘: (1500-800)/1500 = 46.7%
```

**æ–¹æ³•3: æŸ¥çœ‹WALç»Ÿè®¡**

```sql
-- é‡ç½®ç»Ÿè®¡
SELECT pg_stat_reset_shared('bgwriter');

-- è¿è¡Œè´Ÿè½½æµ‹è¯•...

-- æŸ¥çœ‹ç»Ÿè®¡
SELECT 
    stats_reset,
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,    -- å†™å…¥æ—¶é—´(ms)
    checkpoint_sync_time,     -- syncæ—¶é—´(ms)
    buffers_checkpoint
FROM pg_stat_bgwriter;

-- å¯¹æ¯”Group Commitå‰åçš„syncæ—¶é—´æ¯”ç‡
```

---

### 1.3 é¢„è¯»ä¼˜åŒ– (Prefetch)

#### é—®é¢˜åˆ†æ

åŒæ­¥I/Oä¸²è¡Œç­‰å¾… = æµªè´¹CPUæ—¶é—´

#### è¯¦ç»†å›¾è§£

```
ã€åŒæ­¥è¯»å– - CPUç©ºé—²ç­‰å¾…ã€‘
è¿›ç¨‹æ—¶é—´çº¿:
  â†“ å‘èµ·I/Oè¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Issue Read Block 1                   â”‚
â”‚   â†“                                  â”‚
â”‚ [=== Wait 10ms ===]  â† CPUç©ºé—²!     â”‚
â”‚   â†“                                  â”‚
â”‚ Process Block 1 (0.1ms)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Issue Read Block 2                   â”‚
â”‚   â†“                                  â”‚
â”‚ [=== Wait 10ms ===]  â† CPUç©ºé—²!     â”‚
â”‚   â†“                                  â”‚
â”‚ Process Block 2 (0.1ms)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Issue Read Block 3                   â”‚
â”‚   â†“                                  â”‚
â”‚ [=== Wait 10ms ===]  â† CPUç©ºé—²!     â”‚
â”‚   â†“                                  â”‚
â”‚ Process Block 3 (0.1ms)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»æ—¶é—´: 30.3ms (90%åœ¨ç­‰å¾…I/O!)
CPUåˆ©ç”¨ç‡: 0.3/30.3 = 0.99%

ã€å¼‚æ­¥é¢„è¯» - CPU/I/Oå¹¶è¡Œã€‘
è¿›ç¨‹æ—¶é—´çº¿:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Issue Read Block 1  â”€â”               â”‚
â”‚ Issue Read Block 2   â”œâ†’ å¹¶è¡ŒI/O     â”‚
â”‚ Issue Read Block 3  â”€â”˜               â”‚
â”‚   â†“                                  â”‚
â”‚ [=== Wait 10ms ===]  â† 3ä¸ªI/Oå¹¶è¡Œ   â”‚
â”‚   â†“                                  â”‚
â”‚ Process Block 1 (0.1ms)              â”‚
â”‚ Process Block 2 (0.1ms)              â”‚
â”‚ Process Block 3 (0.1ms)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»æ—¶é—´: 10.3ms
CPUåˆ©ç”¨ç‡: 0.3/10.3 = 2.9%
æ€§èƒ½æå‡: 30.3 / 10.3 â‰ˆ 2.94å€

ã€I/Oé˜Ÿåˆ—æ·±åº¦å¯¹æ¯”ã€‘
åŒæ­¥I/O:
æ—¶é—´ â†’
t0   t10  t20  t30
â”‚    â”‚    â”‚    â”‚
I/O1â•â•â•  â”‚    â”‚    â”‚  â† é˜Ÿåˆ—æ·±åº¦=1
     I/O2â•â•â•  â”‚    â”‚
          I/O3â•â•â•  â”‚

å¼‚æ­¥é¢„è¯»:
æ—¶é—´ â†’
t0   t10
â”‚    â”‚
I/O1â•â•â•  â”‚  â† é˜Ÿåˆ—æ·±åº¦=3
I/O2â•â•â•  â”‚
I/O3â•â•â•  â”‚
```

#### PostgreSQLæºç å®ç°

**æ–‡ä»¶**: `src/backend/storage/buffer/bufmgr.c`

```c
/*
 * PrefetchBuffer - å¼‚æ­¥é¢„è¯»ç¼“å†²åŒº
 * 
 * è¿”å›: trueè¡¨ç¤ºéœ€è¦I/Oï¼Œfalseè¡¨ç¤ºå·²åœ¨ç¼“å­˜
 */
PrefetchBufferResult
PrefetchBuffer(Relation reln, ForkNumber forkNum, BlockNumber blockNum)
{
    BufferTag   newTag;
    uint32      newHash;
    LWLock     *newPartitionLock;
    int         buf_id;
    
    /* æ„é€ bufferæ ‡ç­¾ */
    InitBufferTag(&newTag, &reln->rd_locator, forkNum, blockNum);
    newHash = BufTableHashCode(&newTag);
    newPartitionLock = BufMappingPartitionLock(newHash);
    
    /* å¿«é€Ÿæ£€æŸ¥: æ˜¯å¦å·²åœ¨shared buffer */
    LWLockAcquire(newPartitionLock, LW_SHARED);
    buf_id = BufTableLookup(&newTag, newHash);
    LWLockRelease(newPartitionLock);
    
    if (buf_id >= 0)
    {
        /* å·²åœ¨ç¼“å­˜ - æ— éœ€I/O */
        return (PrefetchBufferResult) {
            .initiated_io = false,
            .recent_buffer = buf_id
        };
    }
    
    /*
     * ä¸åœ¨ç¼“å­˜ - å‘èµ·å¼‚æ­¥I/O
     * 
     * å…³é”®: ä½¿ç”¨posix_fadvise(POSIX_FADV_WILLNEED)
     *       å‘Šè¯‰OSé¢„è¯»ï¼Œä½†ä¸é˜»å¡ç­‰å¾…
     */
    #ifdef USE_PREFETCH
    {
        SMgrRelation smgr = RelationGetSmgr(reln);
        
        /* å‘èµ·å¼‚æ­¥é¢„è¯»è¯·æ±‚ */
        smgrprefetch(smgr, forkNum, blockNum, 1);
        
        return (PrefetchBufferResult) {
            .initiated_io = true,
            .recent_buffer = InvalidBuffer
        };
    }
    #endif
}

/*
 * smgrprefetch - å®é™…çš„é¢„è¯»å®ç°
 */
void
smgrprefetch(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum)
{
    /*
     * ä½¿ç”¨posix_fadviseå‘Šè¯‰OSå†…æ ¸é¢„è¯»
     * POSIX_FADV_WILLNEED: "æˆ‘é©¬ä¸Šè¦ç”¨è¿™ä¸ªæ•°æ®"
     */
    #ifdef USE_POSIX_FADVISE
    {
        off_t   offset = (off_t) blocknum * BLCKSZ;
        
        posix_fadvise(fd, offset, BLCKSZ, POSIX_FADV_WILLNEED);
        // â† å¼‚æ­¥è¿”å›! ä¸ç­‰å¾…I/Oå®Œæˆ
    }
    #endif
}
```

#### å®é™…ä½¿ç”¨ç¤ºä¾‹

**åœºæ™¯: Index Scané¢„è¯»**

```c
/* æ–‡ä»¶: src/backend/executor/nodeIndexscan.c */

/*
 * IndexScanæ‰§è¡Œæµç¨‹ - ä½¿ç”¨é¢„è¯»ä¼˜åŒ–
 */
static TupleTableSlot *
IndexNext(IndexScanState *node)
{
    /*
     * æ­¥éª¤1: é¢„è¯»æœªæ¥Nä¸ªblock
     */
    #define PREFETCH_DISTANCE 16  // é¢„è¯»16ä¸ªblock
    
    for (int i = 0; i < PREFETCH_DISTANCE; i++)
    {
        BlockNumber future_block = GetNextBlockFromIndex();
        
        /* å¼‚æ­¥å‘èµ·é¢„è¯» - ä¸é˜»å¡ */
        PrefetchBuffer(relation, MAIN_FORKNUM, future_block);
    }
    
    /*
     * æ­¥éª¤2: è¯»å–å½“å‰block
     * ç”±äºä¹‹å‰é¢„è¯»ï¼Œè¿™ä¸ªblockå¾ˆå¯èƒ½å·²åœ¨ç¼“å­˜!
     */
    buffer = ReadBuffer(relation, current_block);
    // â† å¯èƒ½æ— éœ€ç­‰å¾…I/O
    
    /* æ­¥éª¤3: å¤„ç†tuple */
    ProcessTuple(buffer);
    
    return slot;
}
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: explain analyze å¯¹æ¯”**

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_prefetch (
    id int,
    data text
);

-- æ’å…¥100ä¸‡è¡Œ
INSERT INTO test_prefetch 
SELECT i, md5(i::text) 
FROM generate_series(1, 1000000) i;

CREATE INDEX idx_test ON test_prefetch(id);

-- æ¸…ç©ºç¼“å­˜
SELECT pg_prewarm_reset_stats();

-- æµ‹è¯•1: ç¦ç”¨é¢„è¯»
SET effective_io_concurrency = 0;

EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM test_prefetch WHERE id > 100000 AND id < 200000;

-- è¾“å‡º:
-- Execution Time: 856.234 ms
-- Buffers: shared hit=1024 read=23456

-- æµ‹è¯•2: å¯ç”¨é¢„è¯»
SET effective_io_concurrency = 16;

EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM test_prefetch WHERE id > 100000 AND id < 200000;

-- è¾“å‡º:
-- Execution Time: 312.567 ms
-- Buffers: shared hit=20123 read=4357  â† æ›´å¤šå‘½ä¸­!

-- æ€§èƒ½æå‡: 856 / 312 â‰ˆ 2.74å€
```

**æ–¹æ³•2: ç›‘æ§ç³»ç»ŸI/O**

```bash
# ç›‘æ§I/Oé˜Ÿåˆ—æ·±åº¦
iostat -x 1

# ä¸ä½¿ç”¨é¢„è¯»:
# avg-qu-sz: 1.2   â† é˜Ÿåˆ—æ·±åº¦ä½

# ä½¿ç”¨é¢„è¯»:
# avg-qu-sz: 8.5   â† é˜Ÿåˆ—æ·±åº¦é«˜ï¼Œå¹¶è¡Œåº¦å¥½
```

**æ–¹æ³•3: straceè·Ÿè¸ªposix_fadvise**

```bash
sudo strace -f -e trace=posix_fadvise -p <postgres_pid> 2>&1

# è¾“å‡ºç¤ºä¾‹:
# posix_fadvise(4, 819200, 8192, POSIX_FADV_WILLNEED) = 0
# posix_fadvise(4, 827392, 8192, POSIX_FADV_WILLNEED) = 0
# posix_fadvise(4, 835584, 8192, POSIX_FADV_WILLNEED) = 0
# â† å¯ä»¥çœ‹åˆ°è¿ç»­çš„é¢„è¯»è¯·æ±‚
```

---

### 1.4 Direct I/O (ç»•è¿‡OSç¼“å­˜)

#### é—®é¢˜åˆ†æ

åŒé‡ç¼“å­˜ = å†…å­˜æµªè´¹ + æ€§èƒ½ä¸å¯é¢„æµ‹

#### è¯¦ç»†å›¾è§£

```
ã€ä¼ ç»ŸBuffered I/O - åŒé‡ç¼“å­˜ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application (PostgreSQL)             â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚    Shared Buffers (8GB)             â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚Page 1â”‚Page 2â”‚Page 3â”‚Page 4â”‚     â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ read()/write()
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Operating System                     â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚    Page Cache (16GB)                â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚Page 1â”‚Page 2â”‚Page 3â”‚Page 4â”‚     â”‚ â† é‡å¤ç¼“å­˜!
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ block I/O
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Disk (1TB)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜:
1. å†…å­˜æµªè´¹: åŒæ ·çš„æ•°æ®å­˜2ä»½
2. ä¸å¯é¢„æµ‹: OSå¯èƒ½é©±é€PGçš„çƒ­æ•°æ®
3. é¢å¤–æ‹·è´: Disk â†’ Page Cache â†’ Shared Buffers

ã€Direct I/O - å•å±‚ç¼“å­˜ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application (PostgreSQL)             â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚    Shared Buffers (16GB)            â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚Page 1â”‚Page 2â”‚Page 3â”‚Page 4â”‚     â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ O_DIRECT
                    â†“ (ç»•è¿‡Page Cache)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Operating System                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚    Page Cache (ç©ºé—²ï¼Œç”¨äºå…¶ä»–)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ block I/O
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Disk (1TB)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿:
1. å†…å­˜å……åˆ†åˆ©ç”¨: 16GBå…¨ç»™åº”ç”¨
2. å¯é¢„æµ‹æ€§èƒ½: åº”ç”¨å®Œå…¨æ§åˆ¶ç¼“å­˜
3. å‡å°‘æ‹·è´: Disk â†’ Shared Buffers (ç›´æ¥DMA)
```

#### PostgreSQLå®ç°è€ƒè™‘

```c
/*
 * PostgreSQLç›®å‰ä¸ç›´æ¥ä½¿ç”¨O_DIRECT
 * åŸå› :
 * 1. è·¨å¹³å°å…¼å®¹æ€§ (ä¸æ˜¯æ‰€æœ‰OSéƒ½æ”¯æŒ)
 * 2. å¯¹é½è¦æ±‚ä¸¥æ ¼ (éœ€è¦512å­—èŠ‚å¯¹é½)
 * 3. Shared bufferså·²ç»å¾ˆé«˜æ•ˆ
 * 
 * ä½†æ˜¯å¯ä»¥é€šè¿‡OSé…ç½®è¾¾åˆ°ç±»ä¼¼æ•ˆæœ:
 */

// Linux: ä½¿ç”¨vm.dirty_ratioæ§åˆ¶page cache
// sysctl vm.dirty_ratio=10
// sysctl vm.dirty_background_ratio=5

/*
 * æœªæ¥å¯èƒ½çš„å®ç°:
 */
#ifdef USE_DIRECT_IO
int
OpenDataFile(RelFileNumber relNumber, ForkNumber forkNum)
{
    int fd;
    int flags = O_RDWR | O_CREAT;
    
    #ifdef O_DIRECT
    /* å¯ç”¨Direct I/O */
    if (use_direct_io)
        flags |= O_DIRECT;
    #endif
    
    fd = open(path, flags, 0600);
    
    /*
     * æ³¨æ„: ä½¿ç”¨O_DIRECTæ—¶ï¼Œæ‰€æœ‰I/Oå¿…é¡»:
     * 1. åœ°å€å¯¹é½åˆ°512å­—èŠ‚
     * 2. é•¿åº¦æ˜¯512å­—èŠ‚å€æ•°
     * 3. æ–‡ä»¶åç§»æ˜¯512å­—èŠ‚å€æ•°
     */
    
    return fd;
}
#endif
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: fioæµ‹è¯• Direct I/O vs Buffered I/O**

```bash
# æµ‹è¯•Buffered I/O
fio --name=buffered_io \
    --ioengine=psync \
    --rw=randread \
    --bs=8k \
    --direct=0 \
    --size=10G \
    --numjobs=4 \
    --runtime=60 \
    --group_reporting

# è¾“å‡º:
# READ: bw=523MiB/s, iops=67168

# æµ‹è¯•Direct I/O
fio --name=direct_io \
    --ioengine=psync \
    --rw=randread \
    --bs=8k \
    --direct=1 \      â† å¯ç”¨Direct I/O
    --size=10G \
    --numjobs=4 \
    --runtime=60 \
    --group_reporting

# è¾“å‡º:
# READ: bw=445MiB/s, iops=57088

# åˆ†æ:
# Buffered I/Oæ›´å¿« â†’ Page Cacheç”Ÿæ•ˆ
# Direct I/Oæ›´ç¨³å®š â†’ æ— Page Cacheå¹²æ‰°
```

**æ–¹æ³•2: ç›‘æ§Page Cacheä½¿ç”¨**

```bash
# æŸ¥çœ‹Page Cacheä½¿ç”¨æƒ…å†µ
free -h

#              total    used    free   shared  buff/cache
# Mem:          64Gi    15Gi    12Gi    2.0Gi   36Gi

# buff/cache = 36GB â†’ å¤§é‡Page Cache

# å¦‚æœä½¿ç”¨Direct I/O:
# buff/cache ä¼šæ˜¾è‘—å‡å°‘
```

**æ–¹æ³•3: ä½¿ç”¨vmtouchç›‘æ§**

```bash
# å®‰è£…vmtouch
git clone https://github.com/hoytech/vmtouch.git
cd vmtouch && make && sudo make install

# æ£€æŸ¥PostgreSQLæ•°æ®æ–‡ä»¶çš„ç¼“å­˜æƒ…å†µ
vmtouch -v /var/lib/postgresql/data/base/

# è¾“å‡º:
#            Files: 1234
#      Directories: 56
#   Resident Pages: 456789/789012  5.7G/9.8G  57.9%
#          Elapsed: 0.123 seconds

# å¦‚æœä½¿ç”¨Direct I/Oï¼ŒResident Pagesä¼šå¾ˆå°‘
```

---

## 2. å†…å­˜ä¼˜åŒ–æŠ€å·§

### 2.1 å†…å­˜æ±  (Memory Pool)

#### é—®é¢˜åˆ†æ

é¢‘ç¹malloc/free = ç³»ç»Ÿè°ƒç”¨å¼€é”€ + å†…å­˜ç¢ç‰‡

#### è¯¦ç»†å›¾è§£

```
ã€ä¼ ç»Ÿmalloc/free - ç³»ç»Ÿè°ƒç”¨å¼€é”€ã€‘
ç”¨æˆ·æ€ä»£ç :
  â†“
for (i = 0; i < 1000000; i++) {
    ptr = malloc(100);  â”â”â”â”“
                           â”ƒ ç³»ç»Ÿè°ƒç”¨ (æ…¢!)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ å†…æ ¸æ€:
    â”‚ 1. æŸ¥æ‰¾ç©ºé—²å†…å­˜å—
    â”‚ 2. åˆ†å‰²å†…å­˜å—
    â”‚ 3. æ›´æ–°å…ƒæ•°æ®
    â”‚ 4. è¿”å›ç”¨æˆ·æ€  â† ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€!
    â””â†’ è€—æ—¶: ~100ns

    // ä½¿ç”¨ptr
    
    free(ptr);  â”â”â”â”“
                   â”ƒ ç³»ç»Ÿè°ƒç”¨ (æ…¢!)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ å†…æ ¸æ€:
    â”‚ 1. æ ‡è®°å†…å­˜free
    â”‚ 2. å°è¯•åˆå¹¶ç›¸é‚»å—
    â”‚ 3. æ›´æ–°å…ƒæ•°æ®
    â”‚ 4. è¿”å›ç”¨æˆ·æ€
    â””â†’ è€—æ—¶: ~80ns
}

æ€»å¼€é”€: 1000000 * (100ns + 80ns) = 180ms
     â‰ˆ 18%çš„CPUæ—¶é—´ (å¦‚æœæ€»å¤„ç†æ—¶é—´1ç§’)

ã€å†…å­˜æ±  - æ‰¹é‡åˆ†é…ã€‘
åˆå§‹åŒ–é˜¶æ®µ:
pool = malloc(1MB);  â”â”â”â”“ ä»…1æ¬¡ç³»ç»Ÿè°ƒç”¨!
                        â”ƒ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ åˆ†é…1MBå¤§å†…å­˜å—
    â””â†’ è€—æ—¶: ~100ns

ä½¿ç”¨é˜¶æ®µ:
for (i = 0; i < 1000000; i++) {
    ptr = pool_alloc(pool, 100);  â† O(1)æŒ‡é’ˆç§»åŠ¨
    // offset += 100
    // return pool + offset
    // è€—æ—¶: ~5ns (æ— ç³»ç»Ÿè°ƒç”¨!)
    
    // ä½¿ç”¨ptr
    
    // freeæ˜¯no-opæˆ–åŠ å…¥ç©ºé—²é“¾è¡¨
}

æ¸…ç†é˜¶æ®µ:
pool_destroy(pool);  â”â”â”â”“ ä»…1æ¬¡ç³»ç»Ÿè°ƒç”¨!
                        â”ƒ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ é‡Šæ”¾æ•´ä¸ªpool
    â””â†’ è€—æ—¶: ~80ns

æ€»å¼€é”€: 100ns + (1000000 * 5ns) + 80ns = 5.18ms
æ€§èƒ½æå‡: 180ms / 5.18ms â‰ˆ 34.7å€!
```

#### PostgreSQL MemoryContextå®ç°

**æ–‡ä»¶**: `src/backend/utils/mmgr/aset.c`

```c
/*
 * AllocSet - PostgreSQLçš„å†…å­˜æ± å®ç°
 * 
 * è®¾è®¡è¦ç‚¹:
 * 1. å¤šä¸ªå¤§å†…å­˜å— (block)
 * 2. å°å¯¹è±¡ä»blockä¸­å¿«é€Ÿåˆ†é…
 * 3. å±‚æ¬¡åŒ–ä¸Šä¸‹æ–‡ (å¯åµŒå¥—)
 * 4. æ‰¹é‡é‡Šæ”¾ (Reset/Delete)
 */
typedef struct AllocSetContext
{
    MemoryContextData header;  /* æ ‡å‡†å¤´éƒ¨ */
    
    /* å†…å­˜å—é“¾è¡¨ */
    AllocBlock  blocks;         /* æ‰€æœ‰å¤§å—åˆ—è¡¨ */
    AllocChunk  freelist[11];   /* ç©ºé—²é“¾è¡¨ (æŒ‰å¤§å°) */
    
    /* å½“å‰æ´»åŠ¨å— */
    AllocBlock  keeper;         /* æ°¸ä¸é‡Šæ”¾çš„åˆå§‹å— */
    
    /* åˆ†é…ç»Ÿè®¡ */
    Size        initBlockSize;  /* åˆå§‹å—å¤§å° */
    Size        maxBlockSize;   /* æœ€å¤§å—å¤§å° */
    Size        totalSpace;     /* æ€»åˆ†é…ç©ºé—´ */
} AllocSetContext;

/*
 * palloc - ä»å½“å‰å†…å­˜ä¸Šä¸‹æ–‡åˆ†é…å†…å­˜
 * 
 * å¤æ‚åº¦: O(1)
 */
void *
palloc(Size size)
{
    MemoryContext context = CurrentMemoryContext;
    void       *ret;
    
    /* å¿«é€Ÿè·¯å¾„: å°å¯¹è±¡ä»freeliståˆ†é… */
    if (size <= ALLOC_CHUNK_LIMIT)  // 8KB
    {
        int fidx = /* è®¡ç®—freelistç´¢å¼• */;
        
        if (context->freelist[fidx] != NULL)
        {
            /* ä»freelistè·å– - O(1)! */
            ret = context->freelist[fidx];
            context->freelist[fidx] = *(void **) ret;
            return ret;  // â† æ— ç³»ç»Ÿè°ƒç”¨!
        }
    }
    
    /* æ…¢é€Ÿè·¯å¾„: ä»å½“å‰blockåˆ†é… */
    if (context->freeptr + size <= context->endptr)
    {
        /* å½“å‰blockæœ‰è¶³å¤Ÿç©ºé—´ - O(1)! */
        ret = context->freeptr;
        context->freeptr += size;
        return ret;  // â† æ— ç³»ç»Ÿè°ƒç”¨!
    }
    
    /* éå¸¸æ…¢è·¯å¾„: åˆ†é…æ–°block */
    AllocSetAllocNewBlock(context, size);
    // â† è¿™é‡Œæ‰è°ƒç”¨malloc!
}

/*
 * pfree - é‡Šæ”¾å†…å­˜åˆ°å†…å­˜æ± 
 * 
 * å…³é”®: ä¸è°ƒç”¨free()ï¼Œè€Œæ˜¯åŠ å…¥freelistå¤ç”¨!
 */
void
pfree(void *pointer)
{
    MemoryContext context = GetMemoryChunkContext(pointer);
    Size size = GetMemoryChunkSpace(pointer);
    
    if (size <= ALLOC_CHUNK_LIMIT)
    {
        /* å°å¯¹è±¡: åŠ å…¥freelistå¤ç”¨ */
        int fidx = /* è®¡ç®—ç´¢å¼• */;
        *(void **) pointer = context->freelist[fidx];
        context->freelist[fidx] = pointer;
        // â† æ— ç³»ç»Ÿè°ƒç”¨! O(1)
    }
    else
    {
        /* å¤§å¯¹è±¡: çœŸæ­£é‡Šæ”¾ */
        free(pointer);
    }
}

/*
 * MemoryContextReset - æ‰¹é‡é‡Šæ”¾
 * 
 * è¿™æ˜¯æœ€å¼ºå¤§çš„åŠŸèƒ½: ä¸€æ¬¡é‡Šæ”¾æ•´ä¸ªä¸Šä¸‹æ–‡!
 */
void
MemoryContextReset(MemoryContext context)
{
    AllocSetContext *set = (AllocSetContext *) context;
    AllocBlock block;
    
    /* é‡Šæ”¾æ‰€æœ‰block (é™¤äº†keeper) */
    block = set->blocks;
    while (block != NULL)
    {
        AllocBlock next = block->next;
        
        if (block != set->keeper)
            free(block);  // â† æ‰¹é‡é‡Šæ”¾!
        
        block = next;
    }
    
    /* é‡ç½®freelist */
    MemSetAligned(set->freelist, 0, sizeof(set->freelist));
    
    /* é‡ç½®å½“å‰block */
    set->freeptr = /* keeperèµ·å§‹ä½ç½® */;
}
```

#### å†…å­˜æ± å±‚æ¬¡ç»“æ„

```
PostgreSQLå†…å­˜ä¸Šä¸‹æ–‡æ ‘:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TopMemoryContext (æ°¸ä¸é‡Šæ”¾)                    â”‚
â”‚  â”œâ”€ ErrorContext (é”™è¯¯å¤„ç†)                    â”‚
â”‚  â”œâ”€ PostmasterContext (postmasterè¿›ç¨‹)         â”‚
â”‚  â””â”€ MessageContext (æ¶ˆæ¯å¤„ç†)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ forkå­è¿›ç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CacheMemoryContext (ç³»ç»Ÿç¼“å­˜)                  â”‚
â”‚  â”œâ”€ CatalogCacheContext                        â”‚
â”‚  â””â”€ RelCacheContext                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ æ¯ä¸ªè¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PortalMemoryContext (æ¯ä¸ªæŸ¥è¯¢é—¨æˆ·)             â”‚
â”‚  â””â”€ ExecutorContext (æŸ¥è¯¢æ‰§è¡Œ)                 â”‚
â”‚      â”œâ”€ Per-Tuple Context (æ¯è¡Œ)  â† é¢‘ç¹Reset â”‚
â”‚      â””â”€ Per-Scan Context (æ¯æ¬¡æ‰«æ)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿:
1. å±‚æ¬¡é‡Šæ”¾: çˆ¶contextåˆ é™¤ï¼Œå­contextè‡ªåŠ¨åˆ é™¤
2. ä¸´æ—¶å†…å­˜: Per-Tuple Contextæ¯è¡Œé‡ç½®
3. å†…å­˜æ³„æ¼é˜²æŠ¤: æŸ¥è¯¢ç»“æŸè‡ªåŠ¨æ¸…ç†
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: å¾®åŸºå‡†æµ‹è¯•**

```c
/* test_memory_pool.c - æ€§èƒ½å¯¹æ¯”æµ‹è¯• */
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define ITERATIONS 1000000
#define ALLOC_SIZE 100

/* æµ‹è¯•ä¼ ç»Ÿmalloc/free */
double test_malloc_free()
{
    clock_t start = clock();
    
    for (int i = 0; i < ITERATIONS; i++) {
        void *ptr = malloc(ALLOC_SIZE);
        free(ptr);
    }
    
    clock_t end = clock();
    return (double)(end - start) / CLOCKS_PER_SEC;
}

/* ç®€å•å†…å­˜æ± å®ç° */
typedef struct {
    char *pool;
    size_t offset;
    size_t size;
} MemPool;

MemPool *pool_create(size_t size)
{
    MemPool *pool = malloc(sizeof(MemPool));
    pool->pool = malloc(size);
    pool->offset = 0;
    pool->size = size;
    return pool;
}

void *pool_alloc(MemPool *pool, size_t size)
{
    if (pool->offset + size > pool->size)
        return NULL;
    
    void *ptr = pool->pool + pool->offset;
    pool->offset += size;
    return ptr;
}

void pool_destroy(MemPool *pool)
{
    free(pool->pool);
    free(pool);
}

/* æµ‹è¯•å†…å­˜æ±  */
double test_memory_pool()
{
    clock_t start = clock();
    
    MemPool *pool = pool_create(ITERATIONS * ALLOC_SIZE);
    
    for (int i = 0; i < ITERATIONS; i++) {
        void *ptr = pool_alloc(pool, ALLOC_SIZE);
    }
    
    pool_destroy(pool);
    
    clock_t end = clock();
    return (double)(end - start) / CLOCKS_PER_SEC;
}

int main()
{
    printf("Testing %d allocations of %d bytes each\n", 
           ITERATIONS, ALLOC_SIZE);
    
    double malloc_time = test_malloc_free();
    printf("malloc/free: %.3f seconds\n", malloc_time);
    
    double pool_time = test_memory_pool();
    printf("Memory pool: %.3f seconds\n", pool_time);
    
    printf("Speedup: %.1fx\n", malloc_time / pool_time);
    
    return 0;
}

/* ç¼–è¯‘è¿è¡Œ:
 * gcc -O2 test_memory_pool.c -o test_memory_pool
 * ./test_memory_pool
 *
 * è¾“å‡ºç¤ºä¾‹:
 * malloc/free: 0.256 seconds
 * Memory pool: 0.008 seconds
 * Speedup: 32.0x
 */
```

**æ–¹æ³•2: PostgreSQLå†…å­˜ç»Ÿè®¡**

```sql
-- æŸ¥çœ‹å½“å‰ä¼šè¯çš„å†…å­˜ä½¿ç”¨
SELECT 
    pg_size_pretty(pg_backend_memory_contexts.total_bytes) AS total,
    pg_size_pretty(pg_backend_memory_contexts.used_bytes) AS used,
    pg_size_pretty(pg_backend_memory_contexts.free_bytes) AS free,
    pg_backend_memory_contexts.name,
    pg_backend_memory_contexts.level
FROM pg_backend_memory_contexts
WHERE pg_backend_memory_contexts.parent IS NULL
ORDER BY pg_backend_memory_contexts.total_bytes DESC;

-- è¾“å‡ºç¤ºä¾‹:
-- total | used  | free | name              | level
-- 128MB | 64MB  | 64MB | TopMemoryContext  | 0
-- 8MB   | 6MB   | 2MB  | ExecutorState     | 1
-- 1MB   | 128KB | 896KB| Per-tuple context | 2

-- è§‚å¯ŸæŸ¥è¯¢å‰åå†…å­˜å˜åŒ–
\timing on
SELECT * FROM large_table;
-- æŸ¥è¯¢ç»“æŸåï¼ŒExecutorStateå’ŒPer-tuple contextè‡ªåŠ¨é‡Šæ”¾
```

**æ–¹æ³•3: valgrindå†…å­˜åˆ†æ**

```bash
# ä½¿ç”¨massifåˆ†æå†…å­˜åˆ†é…æ¨¡å¼
valgrind --tool=massif --massif-out-file=massif.out \
    postgres --single -D /path/to/data

# æŸ¥çœ‹æŠ¥å‘Š
ms_print massif.out

# å¯¹æ¯”:
# ä¸ä½¿ç”¨å†…å­˜æ± : å¤§é‡å°çš„malloc/freeå³°å€¼
# ä½¿ç”¨å†…å­˜æ± : å°‘é‡å¤§çš„mallocï¼Œå¹³æ»‘é‡Šæ”¾
```

---

### 2.2 å†…å­˜å¯¹é½ (Memory Alignment)

#### é—®é¢˜åˆ†æ

æœªå¯¹é½å†…å­˜è®¿é—® = CPUé¢å¤–å¤„ç† + æ€§èƒ½æŸå¤±

#### è¯¦ç»†å›¾è§£

```
ã€CPUç¼“å­˜è¡Œ (Cache Line) ç»“æ„ã€‘
ç°ä»£CPUç¼“å­˜è¡Œå¤§å°: 64å­—èŠ‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0 (64 bytes)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte: 0  1  2  3  4  5  6  7 | 8  9  10 11 12 13 14 15 |..â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æœªå¯¹é½è®¿é—® - è·¨Cache Lineã€‘
æƒ…å†µ1: è¯»å–int32 (4å­—èŠ‚)ï¼Œä½†æœªå¯¹é½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte: 0  1  2  3  4  5  6  [7]â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ int32è·¨è¶Šè¾¹ç•Œ!
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 1                    â†“                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte: 0  [1  2  3] 4  5  6  7 | 8  9  10 11 12 13 14 15 |.. â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CPUå¤„ç†æ­¥éª¤:
1. è¯»å–Cache Line 0 â†’ è·å–1å­—èŠ‚
2. è¯»å–Cache Line 1 â†’ è·å–3å­—èŠ‚  â† é¢å¤–1æ¬¡å†…å­˜è®¿é—®!
3. åˆå¹¶ä¸¤éƒ¨åˆ†æ•°æ®
4. è¿”å›ç»“æœ

å¼€é”€: 2æ¬¡å†…å­˜è®¿é—® + åˆå¹¶æ“ä½œ â‰ˆ 20ns

ã€å¯¹é½è®¿é—® - åŒä¸€Cache Lineã€‘
int32å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte: 0  1  2  3  [4  5  6  7] 8  9  10 11 12 13 14 15 |..â”‚
â”‚                    â†‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â†‘                             â”‚
â”‚                    int32å¯¹é½                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CPUå¤„ç†æ­¥éª¤:
1. è¯»å–Cache Line 0 â†’ è·å–4å­—èŠ‚
2. è¿”å›ç»“æœ

å¼€é”€: 1æ¬¡å†…å­˜è®¿é—® â‰ˆ 5ns

æ€§èƒ½æå‡: 20ns / 5ns = 4å€!

ã€ç»“æ„ä½“å¯¹é½ä¼˜åŒ–ã€‘
âŒ æœªä¼˜åŒ–çš„ç»“æ„ä½“:
struct Bad {
    char   a;      // 1 byte  [offset 0]
    int64  b;      // 8 bytes [offset 8]  â† ç¼–è¯‘å™¨å¡«å……7å­—èŠ‚!
    char   c;      // 1 byte  [offset 16]
    // ç¼–è¯‘å™¨å¡«å……7å­—èŠ‚åˆ°24
} __attribute__((packed));

å†…å­˜å¸ƒå±€:
Offset: 0    1    2    3    4    5    6    7    8    9   ...
Data:  [a] [pad][pad][pad][pad][pad][pad][pad][b........  ]
                â†‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†‘                      
                7å­—èŠ‚æµªè´¹!                                  

æ€»å¤§å°: 24å­—èŠ‚
Cache Lineå ç”¨: 2ä¸ª (0-15, 16-23)

âœ… ä¼˜åŒ–åçš„ç»“æ„ä½“:
struct Good {
    int64  b;      // 8 bytes [offset 0]
    char   a;      // 1 byte  [offset 8]
    char   c;      // 1 byte  [offset 9]
    // ç¼–è¯‘å™¨å¡«å……6å­—èŠ‚åˆ°16
};

å†…å­˜å¸ƒå±€:
Offset: 0    1    2    3    4    5    6    7    8    9   ...
Data:  [b...............................][a] [c] [pad]..  
                                                â†‘â”€â”€â†‘      
                                                6å­—èŠ‚å¡«å…… 

æ€»å¤§å°: 16å­—èŠ‚
Cache Lineå ç”¨: 1ä¸ª (0-15)
èŠ‚çœ: (24-16)/24 = 33.3%

æ€§èƒ½æå‡åŸå› :
1. æ›´å°‘å†…å­˜ â†’ æ›´å¤šæ•°æ®åœ¨åŒä¸€Cache Line
2. æ›´å¥½å±€éƒ¨æ€§ â†’ æ›´é«˜ç¼“å­˜å‘½ä¸­ç‡
3. æ›´å°‘å¡«å…… â†’ å‡å°‘å†…å­˜å¸¦å®½æµªè´¹
```

#### PostgreSQLå¯¹é½ç¤ºä¾‹

```c
/* 
 * HeapTupleHeaderData - PostgreSQLè¡Œå¤´éƒ¨
 * 
 * æ–‡ä»¶: src/include/access/htup_details.h
 * 
 * æ³¨æ„å¯¹é½ä¼˜åŒ–!
 */
typedef struct HeapTupleHeaderData
{
    union
    {
        HeapTupleFields t_heap;
        DatumTupleFields t_datum;
    }            t_choice;

    ItemPointerData t_ctid;      /* TIDæŒ‡é’ˆ (6 bytes) */

    /* ä»¥ä¸‹å­—æ®µæŒ‰å¤§å°é™åºæ’åˆ—! */
    uint16        t_infomask2;   /* 2 bytes */
    uint16        t_infomask;    /* 2 bytes */
    uint8         t_hoff;        /* 1 byte */

    /* 
     * t_bitså¼€å§‹ä½ç½®ä¿è¯8å­—èŠ‚å¯¹é½
     * è¿™æ ·è®¿é—®åç»­çš„æ•°æ®åˆ—ä¼šæ›´å¿«
     */
    bits8        t_bits[FLEXIBLE_ARRAY_MEMBER];

} HeapTupleHeaderData;

/*
 * MAXALIGN - å¯¹é½åˆ°8å­—èŠ‚è¾¹ç•Œ
 */
#define MAXALIGN(LEN)  TYPEALIGN(MAXIMUM_ALIGNOF, (LEN))
#define TYPEALIGN(ALIGNVAL,LEN)  \
    (((uintptr_t) (LEN) + ((ALIGNVAL) - 1)) & ~((uintptr_t) ((ALIGNVAL) - 1)))

/* 
 * ä½¿ç”¨ç¤ºä¾‹:
 */
size_t len = 13;  // æœªå¯¹é½
size_t aligned_len = MAXALIGN(len);  // = 16 (å¯¹é½åˆ°8å­—èŠ‚)

/*
 * palloc_aligned - åˆ†é…å¯¹é½å†…å­˜
 */
void *
palloc_aligned(Size size, Size alignto, int flags)
{
    void    *ptr;
    Size    alloc_size;

    /*
     * ç¡®ä¿åˆ†é…çš„å†…å­˜å¯¹é½åˆ°æŒ‡å®šè¾¹ç•Œ
     * å¯¹äºCache Lineä¼˜åŒ–ï¼Œalignto = 64
     */
    alloc_size = size + alignto;
    ptr = palloc(alloc_size);
    
    /* å¯¹é½æŒ‡é’ˆ */
    ptr = (void *) TYPEALIGN(alignto, ptr);
    
    return ptr;
}
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: æ€§èƒ½å¾®åŸºå‡†æµ‹è¯•**

```c
/* test_alignment.c - å¯¹é½æ€§èƒ½æµ‹è¯• */
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <time.h>
#include <string.h>

#define ITERATIONS 100000000

/* æœªå¯¹é½ç»“æ„ä½“ */
struct __attribute__((packed)) Unaligned {
    char a;
    int64_t b;
    char c;
};  // 10 bytes

/* å¯¹é½ç»“æ„ä½“ */
struct Aligned {
    int64_t b;
    char a;
    char c;
};  // 16 bytes (ç¼–è¯‘å™¨å¡«å……)

double test_unaligned()
{
    struct Unaligned *arr = malloc(sizeof(struct Unaligned) * 1000);
    clock_t start = clock();
    
    for (int i = 0; i < ITERATIONS; i++) {
        int idx = i % 1000;
        arr[idx].b += 1;  // è®¿é—®æœªå¯¹é½çš„int64
    }
    
    clock_t end = clock();
    free(arr);
    return (double)(end - start) / CLOCKS_PER_SEC;
}

double test_aligned()
{
    struct Aligned *arr = malloc(sizeof(struct Aligned) * 1000);
    clock_t start = clock();
    
    for (int i = 0; i < ITERATIONS; i++) {
        int idx = i % 1000;
        arr[idx].b += 1;  // è®¿é—®å¯¹é½çš„int64
    }
    
    clock_t end = clock();
    free(arr);
    return (double)(end - start) / CLOCKS_PER_SEC;
}

int main()
{
    printf("Struct sizes:\n");
    printf("  Unaligned: %zu bytes\n", sizeof(struct Unaligned));
    printf("  Aligned: %zu bytes\n\n", sizeof(struct Aligned));
    
    double unaligned_time = test_unaligned();
    printf("Unaligned access: %.3f seconds\n", unaligned_time);
    
    double aligned_time = test_aligned();
    printf("Aligned access: %.3f seconds\n", aligned_time);
    
    printf("Speedup: %.1f%%\n", 
           (unaligned_time - aligned_time) / unaligned_time * 100);
    
    return 0;
}

/* ç¼–è¯‘è¿è¡Œ:
 * gcc -O2 test_alignment.c -o test_alignment
 * ./test_alignment
 *
 * è¾“å‡ºç¤ºä¾‹ (x86_64):
 * Struct sizes:
 *   Unaligned: 10 bytes
 *   Aligned: 16 bytes
 *
 * Unaligned access: 2.456 seconds
 * Aligned access: 1.823 seconds
 * Speedup: 25.8%
 */
```

**æ–¹æ³•2: paholeæŸ¥çœ‹ç»“æ„ä½“å¸ƒå±€**

```bash
# å®‰è£…pahole (dwarvesåŒ…)
sudo yum install dwarves

# ç¼–è¯‘PostgreSQL with debug info
./configure --enable-debug CFLAGS="-g -O0"
make

# æŸ¥çœ‹ç»“æ„ä½“å¸ƒå±€
pahole -C HeapTupleHeaderData postgres

# è¾“å‡ºç¤ºä¾‹:
# struct HeapTupleHeaderData {
#     union {
#         ...
#     } t_choice;           /*     0    12 */
#     ItemPointerData t_ctid;  /*    12     6 */
#     uint16 t_infomask2;   /*    18     2 */
#     uint16 t_infomask;    /*    20     2 */
#     uint8 t_hoff;         /*    22     1 */
#     
#     /* size: 23, cachelines: 1, members: 6 */
#     /* padding: 1 */
# };
```

**æ–¹æ³•3: perfç»Ÿè®¡æœªå¯¹é½è®¿é—®**

```bash
# ä½¿ç”¨perfç›‘æ§æœªå¯¹é½å†…å­˜è®¿é—®
perf stat -e alignment-faults ./your_program

# è¾“å‡º:
# Performance counter stats:
#            1,234 alignment-faults
# 
# å¦‚æœalignment-faultså¾ˆé«˜ï¼Œè¯´æ˜æœ‰æœªå¯¹é½è®¿é—®é—®é¢˜
```

---

### 2.3 é¿å…False Sharing

#### é—®é¢˜åˆ†æ

å¤šçº¿ç¨‹ä¿®æ”¹åŒä¸€Cache Line â†’ Cacheä¸€è‡´æ€§åè®®å¼€é”€å·¨å¤§

#### è¯¦ç»†å›¾è§£

```
ã€False Sharingé—®é¢˜ã€‘
å¤šæ ¸CPUæ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CPU Core 0     â”‚      â”‚      CPU Core 1     â”‚
â”‚                     â”‚      â”‚                     â”‚
â”‚  L1 Cache (32KB)    â”‚      â”‚  L1 Cache (32KB)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cache Line 0  â”‚  â”‚      â”‚  â”‚ Cache Line 0  â”‚  â”‚
â”‚  â”‚ [Counter1][2] â”‚  â”‚      â”‚  â”‚ [Counter1][2] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   L3 Cache (Shared)  â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚  Cache Line 0   â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¶é—´åºåˆ—:
t0: åˆå§‹çŠ¶æ€ - ä¸¤ä¸ªCoreéƒ½ç¼“å­˜åŒä¸€è¡Œ
    Core 0 L1: [Counter1=0][Counter2=0]  (Shared)
    Core 1 L1: [Counter1=0][Counter2=0]  (Shared)

t1: Core 0ä¿®æ”¹Counter1++
    Core 0 L1: [Counter1=1][Counter2=0]  (Modified)
    â†“ MESIåè®®: å‘é€Invalidateæ¶ˆæ¯
    Core 1 L1: [INVALID]                 (Invalid)
    
    Core 1çš„æ•´ä¸ªCache Lineå¤±æ•ˆ!
    å³ä½¿å®ƒåªå…³å¿ƒCounter2!

t2: Core 1è¯»å–Counter2
    Core 1 L1: [INVALID] 
    â†“ Cache Miss! å¿…é¡»ä»Core 0æˆ–å†…å­˜é‡æ–°åŠ è½½
    Core 1 L1: [Counter1=1][Counter2=0]  (Shared)
    
    å»¶è¿Ÿ: ~100 cycles! (æœ¬æ¥L1å‘½ä¸­åªéœ€4 cycles)

t3: Core 1ä¿®æ”¹Counter2++
    Core 1 L1: [Counter1=1][Counter2=1]  (Modified)
    â†“ MESIåè®®: å‘é€Invalidateæ¶ˆæ¯
    Core 0 L1: [INVALID]                 (Invalid)
    
    Core 0çš„Cacheåˆå¤±æ•ˆäº†!

t4: Core 0è¯»å–Counter1
    Core 0 L1: [INVALID]
    â†“ Cache Miss!
    Core 0 L1: [Counter1=1][Counter2=1]  (Shared)
    
    åˆä¸€æ¬¡Cache Miss!

ç»“æœ:
- Counter1å’ŒCounter2åœ¨åŒä¸€Cache Line
- ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¿®æ”¹å®ƒä»¬
- å¯¼è‡´Cache Lineä¸æ–­åœ¨ä¸¤ä¸ªCoreé—´è·³åŠ¨
- æ€§èƒ½ä¸‹é™10å€+!

ã€è§£å†³æ–¹æ¡ˆ - Cache Lineå¡«å……ã€‘
æ–¹æ³•1: ç»“æ„ä½“å¡«å……
struct alignas(64) PaddedCounter {
    volatile int64_t counter;
    char padding[64 - sizeof(int64_t)];  // å¡«å……åˆ°64å­—èŠ‚
};

PaddedCounter counters[2];

å†…å­˜å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0 (64 bytes)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Counter1][padding....................................]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 1 (64 bytes)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Counter2][padding....................................]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•ˆæœ:
t0: Core 0ä¿®æ”¹Counter1
    Core 0 L1: [Counter1=1][pad...]  (Modified)
    Core 1 L1: [Counter2=0][pad...]  (Shared)  â† ä¸å—å½±å“!

t1: Core 1ä¿®æ”¹Counter2
    Core 0 L1: [Counter1=1][pad...]  (Modified)  â† ä¸å—å½±å“!
    Core 1 L1: [Counter2=1][pad...]  (Modified)

ç»“æœ:
- ä¸¤ä¸ªCounteråœ¨ä¸åŒCache Line
- ä¿®æ”¹äº’ä¸å½±å“
- æ— Cacheä¸€è‡´æ€§å¼€é”€
- æ€§èƒ½æå‡10å€+!

ã€MESIåè®®è¯¦è§£ã€‘
Cache LineçŠ¶æ€æœº:
Modified (M):  ç‹¬å ä¸”è„ï¼Œä¸å†…å­˜ä¸ä¸€è‡´
Exclusive (E): ç‹¬å ä¸”å¹²å‡€ï¼Œä¸å†…å­˜ä¸€è‡´
Shared (S):    å…±äº«ä¸”å¹²å‡€ï¼Œå¤šä¸ªCPUéƒ½å¯ä»¥è¯»
Invalid (I):   æ— æ•ˆï¼Œå¿…é¡»é‡æ–°åŠ è½½

çŠ¶æ€è½¬æ¢:
            Read Hit    Write Hit   Read Miss   Write Miss
Modified:      M            M        Mâ†’S (å†™å›)   ä¸å¯èƒ½
Exclusive:     E            Eâ†’M          E         ä¸å¯èƒ½
Shared:        S            Sâ†’M      S (å¤šæ’­)     Sâ†’M (Invalidate)
Invalid:      I (åŠ è½½)     I (åŠ è½½)   I (åŠ è½½)    I (åŠ è½½)

å¼€é”€æœ€å¤§çš„æ“ä½œ:
1. Sâ†’M: éœ€è¦å‘é€Invalidateåˆ°æ‰€æœ‰å…±äº«è€…
2. Iâ†’S/M: Cache Missï¼Œä»å…¶ä»–CPUæˆ–å†…å­˜åŠ è½½

False Sharingæ­£æ˜¯é¢‘ç¹è§¦å‘Sâ†’Mè½¬æ¢!
```

#### PostgreSQLé¿å…False Sharing

```c
/*
 * PostgreSQLçš„è¿›ç¨‹æ¨¡å‹å¤©ç„¶é¿å…äº†False Sharing
 * å› ä¸ºæ¯ä¸ªbackendæ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼Œæœ‰ç‹¬ç«‹åœ°å€ç©ºé—´
 * 
 * ä½†åœ¨å…±äº«å†…å­˜ä¸­ä»éœ€æ³¨æ„!
 */

/*
 * æ–‡ä»¶: src/include/storage/lwlock.h
 * 
 * LWLockæ•°ç»„ - ä½¿ç”¨å¡«å……é¿å…False Sharing
 */
typedef struct LWLock
{
    uint16          tranche;        /* tranche ID */
    pg_atomic_uint32 state;         /* çŠ¶æ€ (4 bytes) */
    proclist_head   waiters;        /* ç­‰å¾…è€…åˆ—è¡¨ */
    
#ifdef LOCK_DEBUG
    pg_atomic_uint32 nwaiters;      /* ç­‰å¾…è€…æ•°é‡ */
    struct PGPROC *owner;           /* æŒæœ‰è€… (debug) */
#endif
    
    /*
     * å¡«å……åˆ°64å­—èŠ‚ï¼Œé¿å…False Sharing
     * æ¯ä¸ªLWLockå ç”¨ç‹¬ç«‹Cache Line
     */
    char            padding[LWLOCK_PADDED_SIZE - sizeof(LWLock)];
    
} LWLock __attribute__((aligned(64)));  // â† å¼ºåˆ¶64å­—èŠ‚å¯¹é½

/*
 * PGSemaphore - ä¿¡å·é‡æ•°ç»„ä¹Ÿéœ€è¦å¡«å……
 */
typedef struct PGSemaphoreData
{
    sem_t           sem;
    
    /* å¡«å……åˆ°64å­—èŠ‚ */
    char            padding[64 - sizeof(sem_t)];
    
} PGSemaphoreData __attribute__((aligned(64)));
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: æ€§èƒ½å¾®åŸºå‡†æµ‹è¯•**

```c
/* test_false_sharing.c - False Sharingæµ‹è¯• */
#include <stdio.h>
#include <stdint.h>
#include <pthread.h>
#include <time.h>

#define ITERATIONS 100000000

/* æœªå¡«å…… - æœ‰False Sharing */
struct {
    volatile int64_t counter1;  // Core 0ä¿®æ”¹
    volatile int64_t counter2;  // Core 1ä¿®æ”¹
} no_padding;

/* å¡«å…… - é¿å…False Sharing */
struct {
    volatile int64_t counter1;
    char padding1[64 - sizeof(int64_t)];
    volatile int64_t counter2;
    char padding2[64 - sizeof(int64_t)];
} with_padding __attribute__((aligned(64)));

void *thread1_no_padding(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        no_padding.counter1++;  // â† è§¦å‘False Sharing
    }
    return NULL;
}

void *thread2_no_padding(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        no_padding.counter2++;  // â† è§¦å‘False Sharing
    }
    return NULL;
}

void *thread1_with_padding(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        with_padding.counter1++;  // â† æ— False Sharing
    }
    return NULL;
}

void *thread2_with_padding(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        with_padding.counter2++;  // â† æ— False Sharing
    }
    return NULL;
}

double test_no_padding()
{
    pthread_t t1, t2;
    struct timespec start, end;
    
    clock_gettime(CLOCK_MONOTONIC, &start);
    
    pthread_create(&t1, NULL, thread1_no_padding, NULL);
    pthread_create(&t2, NULL, thread2_no_padding, NULL);
    
    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    
    clock_gettime(CLOCK_MONOTONIC, &end);
    
    return (end.tv_sec - start.tv_sec) + 
           (end.tv_nsec - start.tv_nsec) / 1e9;
}

double test_with_padding()
{
    pthread_t t1, t2;
    struct timespec start, end;
    
    clock_gettime(CLOCK_MONOTONIC, &start);
    
    pthread_create(&t1, NULL, thread1_with_padding, NULL);
    pthread_create(&t2, NULL, thread2_with_padding, NULL);
    
    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    
    clock_gettime(CLOCK_MONOTONIC, &end);
    
    return (end.tv_sec - start.tv_sec) + 
           (end.tv_nsec - start.tv_nsec) / 1e9;
}

int main()
{
    printf("Testing False Sharing (%d iterations)\n\n", ITERATIONS);
    
    printf("Structure sizes:\n");
    printf("  No padding: %zu bytes\n", sizeof(no_padding));
    printf("  With padding: %zu bytes\n\n", sizeof(with_padding));
    
    double no_pad_time = test_no_padding();
    printf("No padding (False Sharing): %.3f seconds\n", no_pad_time);
    
    double with_pad_time = test_with_padding();
    printf("With padding (No False Sharing): %.3f seconds\n", with_pad_time);
    
    printf("\nSpeedup: %.1fx\n", no_pad_time / with_pad_time);
    
    return 0;
}

/* ç¼–è¯‘è¿è¡Œ:
 * gcc -O2 -pthread test_false_sharing.c -o test_false_sharing
 * ./test_false_sharing
 *
 * è¾“å‡ºç¤ºä¾‹ (åŒæ ¸):
 * Structure sizes:
 *   No padding: 16 bytes
 *   With padding: 128 bytes
 *
 * No padding (False Sharing): 8.567 seconds
 * With padding (No False Sharing): 1.234 seconds
 * 
 * Speedup: 6.9x  â† å·¨å¤§æå‡!
 */
```

**æ–¹æ³•2: perfç›‘æ§Cacheä¸€è‡´æ€§äº‹ä»¶**

```bash
# ç›‘æ§Cacheä¸€è‡´æ€§åè®®äº‹ä»¶
perf stat -e cache-misses,cache-references,LLC-load-misses \
    ./test_false_sharing

# è¾“å‡º (No padding):
# 15,234,567 cache-misses    # é«˜Cache Missç‡!
# 28,456,123 cache-references
# 12,345,678 LLC-load-misses

# è¾“å‡º (With padding):
# 1,234,567 cache-misses     # ä½Cache Missç‡
# 25,456,123 cache-references
# 234,567 LLC-load-misses

# Cache Missç‡ä¸‹é™: (15M - 1.2M) / 15M â‰ˆ 92%
```

**æ–¹æ³•3: Intel VTuneåˆ†æ**

```bash
# ä½¿ç”¨VTune profileråˆ†æFalse Sharing
vtune -collect memory-access -knob analyze-mem-objects=true \
    ./test_false_sharing

# æŸ¥çœ‹æŠ¥å‘Š
vtune -report hotspots -r <result_dir>

# VTuneä¼šé«˜äº®æ˜¾ç¤ºæœ‰False Sharingçš„å†…å­˜å¯¹è±¡
```

---

### 2.4 çƒ­æ•°æ®ç´§å‡‘å­˜å‚¨

#### é—®é¢˜åˆ†æ

æ•°æ®åˆ†æ•£ = è·¨è¶Šå¤šä¸ªCache Line = Cache Misså¢åŠ 

#### è¯¦ç»†å›¾è§£

```
ã€æ•°æ®å¸ƒå±€å¯¹Cacheçš„å½±å“ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0 (64 bytes)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¿é—®é¢‘ç‡: 100%     10%      100%     5%                    â”‚
â”‚          [HOT1] [COLD1] [HOT2]  [COLD2.........  ]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜: 
- HOT1å’ŒHOT2éƒ½éœ€è¦ï¼Œä½†è¢«COLDæ•°æ®éš”å¼€
- æµªè´¹äº†Cache Lineçš„50%ç©ºé—´
- è®¿é—®HOT2æ—¶ï¼Œä¹ŸåŠ è½½äº†ä¸éœ€è¦çš„COLD2

ã€ä¼˜åŒ–åçš„å¸ƒå±€ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 0 (64 bytes) - çƒ­æ•°æ®åŒº                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¿é—®é¢‘ç‡: 100%  100%  100%  100%                           â”‚
â”‚          [HOT1] [HOT2] [HOT3] [HOT4............  ]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Line 1 (64 bytes) - å†·æ•°æ®åŒº                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¿é—®é¢‘ç‡: 10%   5%    2%    1%                             â”‚
â”‚          [COLD1][COLD2][COLD3][COLD4..........  ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•ˆæœ:
- çƒ­æ•°æ®ç´§å‡‘å­˜å‚¨åœ¨åŒä¸€Cache Line
- ä¸€æ¬¡åŠ è½½è·å–æ‰€æœ‰çƒ­æ•°æ®
- Cache Lineåˆ©ç”¨ç‡100%
- å†·æ•°æ®åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¸æ±¡æŸ“çƒ­æ•°æ®ç¼“å­˜
```

#### PostgreSQLå®ä¾‹

```c
/*
 * HeapTupleHeaderData - PostgreSQLçš„è¡Œå¤´éƒ¨
 * 
 * è®¾è®¡åŸåˆ™: çƒ­æ•°æ®å‰ç½®!
 */
typedef struct HeapTupleHeaderData
{
    /* === çƒ­æ•°æ®åŒº (é¢‘ç¹è®¿é—®) === */
    
    union {
        HeapTupleFields t_heap;      /* INSERT/DELETEçš„äº‹åŠ¡ID */
        struct {
            TransactionId t_xmin;    /* â† æœ€çƒ­! MVCCå¯è§æ€§åˆ¤æ–­ */
            TransactionId t_xmax;    /* â† æœ€çƒ­! MVCCå¯è§æ€§åˆ¤æ–­ */
            union {
                CommandId t_cid;      /* å‘½ä»¤ID */
                TransactionId t_xvac; /* VACUUMçš„XID */
            } t_field3;
        } t_heap;
    } t_choice;                       /* 12 bytes */

    ItemPointerData t_ctid;           /* 6 bytesï¼ŒUPDATEé“¾ */
    
    /* ä»¥ä¸‹å­—æ®µæŒ‰è®¿é—®é¢‘ç‡é™åº! */
    uint16 t_infomask2;               /* 2 bytesï¼Œå±æ€§æ•°é‡ */
    uint16 t_infomask;                /* 2 bytesï¼Œæ ‡å¿—ä½ */
    uint8  t_hoff;                    /* 1 byteï¼Œæ•°æ®èµ·å§‹åç§» */
    
    /* === å†·æ•°æ®åŒº (ä¸å¸¸è®¿é—®) === */
    bits8 t_bits[FLEXIBLE_ARRAY_MEMBER]; /* NULL bitmap */

} HeapTupleHeaderData;  /* 23 byteså¯¹é½åˆ°24 */

/*
 * ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?
 * 
 * MVCCå¯è§æ€§åˆ¤æ–­(æœ€é¢‘ç¹æ“ä½œ):
 * 1. æ£€æŸ¥ t_xmin â†’ åœ¨å‰12å­—èŠ‚
 * 2. æ£€æŸ¥ t_xmax â†’ åœ¨å‰12å­—èŠ‚
 * 3. æ£€æŸ¥ t_infomask â†’ åœ¨å‰20å­—èŠ‚
 * 
 * è¿™äº›çƒ­æ•°æ®éƒ½åœ¨å‰24å­—èŠ‚(é€šå¸¸åœ¨åŒä¸€Cache Line)!
 * 
 * è€Œ t_bits (NULL bitmap) ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦ï¼Œ
 * æ‰€ä»¥æ”¾åœ¨åé¢ï¼Œä¸å ç”¨å®è´µçš„Cacheç©ºé—´ã€‚
 */
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: cachegrindåˆ†æCacheè¡Œä¸º**

```bash
# ä½¿ç”¨valgrindçš„cachegrindåˆ†æCacheä½¿ç”¨
valgrind --tool=cachegrind \
         --cachegrind-out-file=cachegrind.out \
         ./your_program

# æŸ¥çœ‹æŠ¥å‘Š
cg_annotate cachegrind.out

# å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡:
# D1  miss rate: L1 Data Cache missç‡
# LL  miss rate: Last Level Cache missç‡

# ä¼˜åŒ–å‰:
# D1  miss rate: 8.5%  â† é«˜missç‡
# LL  miss rate: 2.3%

# ä¼˜åŒ–å:
# D1  miss rate: 3.2%  â† ä½missç‡
# LL  miss rate: 0.8%

# Missç‡ä¸‹é™: (8.5 - 3.2) / 8.5 = 62%
```

**æ–¹æ³•2: perfç»Ÿè®¡Cacheäº‹ä»¶**

```bash
# ç»Ÿè®¡Cacheç›¸å…³æ€§èƒ½è®¡æ•°å™¨
perf stat -e L1-dcache-loads,L1-dcache-load-misses,\
            LLC-loads,LLC-load-misses \
    ./your_program

# è¾“å‡º:
# 1,234,567,890  L1-dcache-loads
#    45,678,901  L1-dcache-load-misses  # 3.7% missç‡
#   234,567,890  LLC-loads
#     1,234,567  LLC-load-misses        # 0.53% missç‡

# è®¡ç®—Cacheæ•ˆç‡:
# L1 å‘½ä¸­ç‡ = (1 - 45M/1234M) = 96.3%
```

**æ–¹æ³•3: ç»“æ„ä½“å¸ƒå±€åˆ†æ**

```bash
# ä½¿ç”¨paholeåˆ†æç»“æ„ä½“å¸ƒå±€
pahole -C HeapTupleHeaderData postgres

# æ£€æŸ¥:
# 1. çƒ­æ•°æ®æ˜¯å¦åœ¨å‰é¢
# 2. æ˜¯å¦æœ‰ä¸å¿…è¦çš„padding
# 3. å­—æ®µæ˜¯å¦æŒ‰è®¿é—®é¢‘ç‡æ’åº
```

---

## 3. CPUä¼˜åŒ–æŠ€å·§

### 3.1 åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–

#### é—®é¢˜åˆ†æ

CPUæµæ°´çº¿ + åˆ†æ”¯é¢„æµ‹å¤±è´¥ = æµæ°´çº¿åœé¡¿

#### è¯¦ç»†å›¾è§£

```
ã€ç°ä»£CPUæµæ°´çº¿ã€‘
5çº§æµæ°´çº¿ç¤ºä¾‹:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ IF   â”‚ ID   â”‚ EX   â”‚ MEM  â”‚ WB   â”‚  â† Stage
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚å–æŒ‡ä»¤â”‚è¯‘ç   â”‚æ‰§è¡Œ  â”‚è®¿å­˜  â”‚å†™å›  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

ç†æƒ³æƒ…å†µ(æ— åˆ†æ”¯):
æ—¶é—´ â†’
t1: [IF1] 
t2: [IF2][ID1]
t3: [IF3][ID2][EX1]
t4: [IF4][ID3][EX2][MEM1]
t5: [IF5][ID4][EX3][MEM2][WB1]  â† 5æ¡æŒ‡ä»¤åŒæ—¶æ‰§è¡Œ!
ååé‡: 1æŒ‡ä»¤/å‘¨æœŸ

ã€åˆ†æ”¯é¢„æµ‹å¤±è´¥ - æµæ°´çº¿åœé¡¿ã€‘
é‡åˆ°ifè¯­å¥:
t1: [IF1]                    // if (condition)
t2: [IF2][ID1]               // å¼€å§‹é¢„æµ‹
t3: [IF3][ID2][EX1]          // é¢„æµ‹èµ°åˆ†æ”¯A
t4: [IF4][ID3][EX2][MEM1]    // ç»§ç»­å–Açš„æŒ‡ä»¤
t5: [IF5][ID4][EX3][MEM2][WB1]  // EX1å‘ç°é¢„æµ‹é”™è¯¯!
    â†“
    æµæ°´çº¿å†²åˆ· (Pipeline Flush)
    â†“
t6: [IF_B1]                  // é‡æ–°å–åˆ†æ”¯Bçš„æŒ‡ä»¤
t7: [IF_B2][ID_B1]
t8: [IF_B3][ID_B2][EX_B1]    // æµªè´¹äº†3ä¸ªå‘¨æœŸ!

åœé¡¿å¼€é”€: ~15-20 cycles (ç°ä»£CPU)

ã€åˆ†æ”¯é¢„æµ‹å™¨ã€‘
CPUç»´æŠ¤åˆ†æ”¯å†å²è¡¨(BHT):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Branch Address | History | Predictionâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x400123      | 1111111 | Taken     â”‚ â† è¿ç»­7æ¬¡taken
â”‚ 0x400456      | 0101010 | ???       â”‚ â† ä¸å¯é¢„æµ‹!
â”‚ 0x400789      | 0000000 | Not-Taken â”‚ â† è¿ç»­7æ¬¡not-taken
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é¢„æµ‹å‡†ç¡®ç‡:
- å¾ªç¯: 95%+ (æ¨¡å¼æ˜æ˜¾)
- æœ‰åºæ•°æ®: 90%+ (åˆ†æ”¯é›†ä¸­)
- éšæœºæ•°æ®: 50% (æ— è§„å¾‹)

ã€ä¸å¯é¢„æµ‹åˆ†æ”¯çš„æ€§èƒ½å½±å“ã€‘
æµ‹è¯•: 100Mæ¬¡å¾ªç¯
for (i = 0; i < 100000000; i++) {
    if (data[i] > threshold) {  // 50%æ¦‚ç‡
        sum1++;
    } else {
        sum2++;
    }
}

éšæœºæ•°æ®:
- é¢„æµ‹æˆåŠŸç‡: 50%
- é¢„æµ‹å¤±è´¥: 50Mæ¬¡
- åœé¡¿: 50M * 15 cycles = 750M cycles
- æ—¶é—´: 750M / 3GHz = 0.25ç§’

æœ‰åºæ•°æ®(å…ˆå¤§åå°):
- é¢„æµ‹æˆåŠŸç‡: 99%+
- é¢„æµ‹å¤±è´¥: 1Mæ¬¡
- åœé¡¿: 1M * 15 cycles = 15M cycles
- æ—¶é—´: 15M / 3GHz = 0.005ç§’

æ€§èƒ½æå‡: 0.25 / 0.005 = 50å€!
```

#### ä¼˜åŒ–æŠ€å·§

```c
/* ä¼˜åŒ–1: å‡å°‘åˆ†æ”¯ - ä½¿ç”¨æ¡ä»¶ç§»åŠ¨ */

// âŒ æœ‰åˆ†æ”¯ (ä¸å¯é¢„æµ‹)
if (x > y)
    max = x;
else
    max = y;

// âœ… æ— åˆ†æ”¯ (ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦ï¼Œç¼–è¯‘å™¨ç”ŸæˆCMOV)
max = (x > y) ? x : y;
// ç¼–è¯‘ä¸º: cmp; cmovg (æ¡ä»¶ç§»åŠ¨ï¼Œæ— åˆ†æ”¯!)

/* ä¼˜åŒ–2: åˆ†æ”¯æç¤º (GCC/Clang) */

// å‘Šè¯‰ç¼–è¯‘å™¨likelyè·¯å¾„
if (__builtin_expect(ptr != NULL, 1)) {
    // likelyè·¯å¾„ - ç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºé¡ºåºæ‰§è¡Œ
    *ptr = value;
}

// PostgreSQLå®
#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)

if (likely(tuple_is_visible)) {
    // å¤§æ¦‚ç‡è·¯å¾„ï¼ŒCPUé¢„æµ‹æ›´å‡†ç¡®
    return tuple;
}

/* ä¼˜åŒ–3: æ’åºæ¶ˆé™¤åˆ†æ”¯ */

// âŒ éšæœºè®¿é—® (50%é¢„æµ‹å¤±è´¥)
for (i = 0; i < n; i++) {
    if (data[i] > threshold) {  // éšæœºtrue/false
        process_large(data[i]);
    } else {
        process_small(data[i]);
    }
}

// âœ… å…ˆæ’åº (99%é¢„æµ‹æˆåŠŸ)
qsort(data, n, sizeof(int), compare);
for (i = 0; i < n; i++) {
    if (data[i] > threshold) {  // è¿ç»­true
        process_large(data[i]);
    } else {                     // ç„¶åè¿ç»­false
        process_small(data[i]);
    }
}
// æ’åºå¼€é”€: O(n log n)
// ä½†æ¶ˆé™¤äº†åˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼Œæ€»ä½“æ›´å¿«!
```

#### PostgreSQLåº”ç”¨

```c
/*
 * HeapTupleSatisfiesMVCC - MVCCå¯è§æ€§åˆ¤æ–­
 * 
 * æ–‡ä»¶: src/backend/access/heap/heapam_visibility.c
 * 
 * ä¼˜åŒ–è¦ç‚¹: æŒ‰æ¦‚ç‡æ’åºåˆ†æ”¯
 */
bool
HeapTupleSatisfiesMVCC(HeapTuple htup, Snapshot snapshot)
{
    HeapTupleHeader tuple = htup->t_data;

    /*
     * ä¼˜åŒ–1: å¿«é€Ÿè·¯å¾„åœ¨å‰
     * 
     * å¤§å¤šæ•°tupleæ˜¯å¯è§çš„ï¼Œæ‰€ä»¥å…ˆæ£€æŸ¥ç®€å•æ¡ä»¶
     */
    
    /* æ£€æŸ¥1: tupleçš„xmin (å¤§æ¦‚ç‡åœ¨snapshotä¹‹å‰) */
    if (!XLogRecPtrIsInvalid(tuple->t_infomask & HEAP_XMIN_COMMITTED))
    {
        /* xminå·²æäº¤ - likely! */
        if (tuple->t_infomask & HEAP_XMIN_INVALID)
            return false;  // â† å¿«é€Ÿè¿”å›
        
        /* ç»§ç»­æ£€æŸ¥xmax */
        if (!(tuple->t_infomask & HEAP_XMAX_COMMITTED))
        {
            /* xmaxæœªæäº¤æˆ–æ— æ•ˆ - likely! */
            return true;  // â† å¿«é€Ÿè¿”å›ï¼Œå¤§éƒ¨åˆ†åœ¨è¿™é‡Œ!
        }
    }
    
    /*
     * ä¼˜åŒ–2: å¤æ‚æ£€æŸ¥åœ¨å
     * 
     * åªæœ‰å°‘æ•°tupleéœ€è¦æ£€æŸ¥snapshot
     */
    if (XidInMVCCSnapshot(tuple->t_xmin, snapshot))
        return false;  // ä¸å¯è§
    
    // ... æ›´å¤šå¤æ‚æ£€æŸ¥ ...
}

/*
 * ä¸ºä»€ä¹ˆè¿™æ ·ä¼˜åŒ–?
 * 
 * ç»Ÿè®¡æ•°æ®æ˜¾ç¤º:
 * - 95%çš„tupleåœ¨å¿«é€Ÿè·¯å¾„è¿”å›
 * - 5%çš„tupleéœ€è¦æ£€æŸ¥snapshot
 * 
 * å¦‚æœé¡ºåºé¢ å€’:
 * - CPUé¢„æµ‹å¤±è´¥ç‡é«˜
 * - æµæ°´çº¿é¢‘ç¹åœé¡¿
 * - æ€§èƒ½ä¸‹é™20%+
 */
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: æ’åºæ•°æ®æ€§èƒ½æµ‹è¯•**

```c
/* test_branch_prediction.c */
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define SIZE 100000000

int compare(const void *a, const void *b) {
    return (*(int*)a - *(int*)b);
}

double test_random_data()
{
    int *data = malloc(SIZE * sizeof(int));
    long long sum = 0;
    
    // éšæœºæ•°æ®
    for (int i = 0; i < SIZE; i++)
        data[i] = rand();
    
    clock_t start = clock();
    
    for (int i = 0; i < SIZE; i++) {
        if (data[i] > RAND_MAX/2) {  // 50%æ¦‚ç‡
            sum += data[i];
        }
    }
    
    clock_t end = clock();
    free(data);
    
    return (double)(end - start) / CLOCKS_PER_SEC;
}

double test_sorted_data()
{
    int *data = malloc(SIZE * sizeof(int));
    long long sum = 0;
    
    // éšæœºæ•°æ®
    for (int i = 0; i < SIZE; i++)
        data[i] = rand();
    
    // æ’åº!
    qsort(data, SIZE, sizeof(int), compare);
    
    clock_t start = clock();
    
    for (int i = 0; i < SIZE; i++) {
        if (data[i] > RAND_MAX/2) {  // ç°åœ¨æ˜¯è¿ç»­çš„trueæˆ–false!
            sum += data[i];
        }
    }
    
    clock_t end = clock();
    free(data);
    
    return (double)(end - start) / CLOCKS_PER_SEC;
}

int main()
{
    printf("Testing branch prediction (100M items)\n\n");
    
    double random_time = test_random_data();
    printf("Random data: %.3f seconds\n", random_time);
    
    double sorted_time = test_sorted_data();
    printf("Sorted data: %.3f seconds\n", sorted_time);
    
    printf("\nSpeedup: %.1fx\n", random_time / sorted_time);
    
    return 0;
}

/* ç¼–è¯‘è¿è¡Œ:
 * gcc -O2 test_branch_prediction.c -o test_branch
 * ./test_branch
 *
 * è¾“å‡ºç¤ºä¾‹:
 * Random data: 2.456 seconds  â† åˆ†æ”¯é¢„æµ‹å¤±è´¥
 * Sorted data: 0.567 seconds  â† åˆ†æ”¯é¢„æµ‹æˆåŠŸ
 * Speedup: 4.3x
 */
```

**æ–¹æ³•2: perfç»Ÿè®¡åˆ†æ”¯é¢„æµ‹**

```bash
# ç»Ÿè®¡åˆ†æ”¯é¢„æµ‹äº‹ä»¶
perf stat -e branches,branch-misses ./test_branch

# è¾“å‡º (Random data):
# 100,234,567  branches
#  49,876,543  branch-misses  # 49.7% missç‡!

# è¾“å‡º (Sorted data):
# 100,234,567  branches
#     123,456  branch-misses  # 0.12% missç‡

# Missç‡ä¸‹é™: 49.7% â†’ 0.12%
# åœé¡¿å‡å°‘: 49.8M * 15 cycles â‰ˆ 750M cyclesèŠ‚çœ!
```

**æ–¹æ³•3: ä½¿ç”¨likely/unlikelyå®**

```c
/* æµ‹è¯•likelyå®çš„æ•ˆæœ */
#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)

// æœ‰hint
if (likely(ptr != NULL)) {
    *ptr = value;
}

// æ— hint
if (ptr != NULL) {
    *ptr = value;
}

// æŸ¥çœ‹ç”Ÿæˆçš„æ±‡ç¼–
gcc -S -O2 test.c
objdump -d test.o

// æœ‰likely: é¡ºåºæ‰§è¡Œ(æ— è·³è½¬)
// æ— likely: å¯èƒ½æœ‰è·³è½¬
```

---

### 3.2 å¾ªç¯å±•å¼€ä¸SIMDä¼˜åŒ–

#### å¾ªç¯å±•å¼€åŸç†

```
ã€æ™®é€šå¾ªç¯ - æ§åˆ¶å¼€é”€ã€‘
for (i = 0; i < 1000; i++) {
    sum += array[i];
}

æ±‡ç¼–ä¼ªä»£ç :
loop:
    mov  rax, [array + i*8]  ; åŠ è½½ (4 cycles)
    add  sum, rax            ; åŠ æ³• (1 cycle)
    inc  i                   ; i++  (1 cycle)
    cmp  i, 1000             ; æ¯”è¾ƒ (1 cycle)
    jl   loop                ; è·³è½¬ (1 cycle if taken)

æ¯æ¬¡è¿­ä»£: 8 cycles
æ€»æ—¶é—´: 1000 * 8 = 8000 cycles

ã€å¾ªç¯å±•å¼€ - å‡å°‘å¼€é”€ã€‘
for (i = 0; i < 1000; i += 4) {
    sum += array[i];
    sum += array[i+1];
    sum += array[i+2];
    sum += array[i+3];
}

æ±‡ç¼–ä¼ªä»£ç :
loop:
    mov  rax, [array + i*8]      ; åŠ è½½1
    add  sum, rax
    mov  rax, [array + (i+1)*8]  ; åŠ è½½2
    add  sum, rax
    mov  rax, [array + (i+2)*8]  ; åŠ è½½3
    add  sum, rax
    mov  rax, [array + (i+3)*8]  ; åŠ è½½4
    add  sum, rax
    add  i, 4                     ; i += 4
    cmp  i, 1000
    jl   loop

æ¯4ä¸ªå…ƒç´ : 4*5 + 3 = 23 cycles
æ¯ä¸ªå…ƒç´ : 23/4 = 5.75 cycles
æ€»æ—¶é—´: 1000 * 5.75 = 5750 cycles

æ€§èƒ½æå‡: 8000 / 5750 = 1.39å€

ä¼˜åŠ¿:
1. å¾ªç¯æ§åˆ¶å¼€é”€å‡å°‘75% (inc/cmp/jl)
2. æŒ‡ä»¤çº§å¹¶è¡Œ(ILP): CPUå¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šæ¡add
```

#### SIMDä¼˜åŒ–

```
ã€SIMD (Single Instruction Multiple Data)ã€‘
AVX2å¯„å­˜å™¨: 256ä½ = 32å­—èŠ‚ = 4ä¸ªint64

æ ‡é‡åŠ æ³•:
a[0] + b[0] â†’ c[0]  (1æ¡æŒ‡ä»¤)
a[1] + b[1] â†’ c[1]  (1æ¡æŒ‡ä»¤)
a[2] + b[2] â†’ c[2]  (1æ¡æŒ‡ä»¤)
a[3] + b[3] â†’ c[3]  (1æ¡æŒ‡ä»¤)
æ€»å…±: 4æ¡æŒ‡ä»¤

SIMDåŠ æ³•:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚a[0]â”‚a[1]â”‚a[2]â”‚a[3]â”‚ + â”‚b[0]â”‚b[1]â”‚b[2]â”‚b[3]â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
         â†“ vpaddd (1æ¡æŒ‡ä»¤!)
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚c[0]â”‚c[1]â”‚c[2]â”‚c[3]â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
æ€»å…±: 1æ¡æŒ‡ä»¤

æ€§èƒ½æå‡: 4å€

ã€SIMDä»£ç ç¤ºä¾‹ã€‘
// æ ‡é‡ç‰ˆæœ¬
for (i = 0; i < n; i++) {
    c[i] = a[i] + b[i];
}

// SIMDç‰ˆæœ¬ (AVX2)
#include <immintrin.h>

for (i = 0; i < n; i += 4) {
    __m256i va = _mm256_load_si256((__m256i*)&a[i]);
    __m256i vb = _mm256_load_si256((__m256i*)&b[i]);
    __m256i vc = _mm256_add_epi64(va, vb);
    _mm256_store_si256((__m256i*)&c[i], vc);
}
```

#### PostgreSQL SIMDåº”ç”¨

```c
/*
 * pg_checksum_block - ä½¿ç”¨SSE4.2ç¡¬ä»¶CRC32
 * 
 * æ–‡ä»¶: src/include/storage/checksum_impl.h
 */
uint32
pg_checksum_block(char *data, uint32 size)
{
    uint32 crc = 0xFFFFFFFF;
    
#ifdef USE_SSE42_CRC32C
    /*
     * ä½¿ç”¨ç¡¬ä»¶CRC32æŒ‡ä»¤ (SSE4.2)
     * ä¸€æ¡æŒ‡ä»¤è®¡ç®—8å­—èŠ‚
     */
    uint64 *data64 = (uint64 *) data;
    uint32 len64 = size / 8;
    
    for (uint32 i = 0; i < len64; i++)
    {
        crc = _mm_crc32_u64(crc, data64[i]);  // â† ç¡¬ä»¶æŒ‡ä»¤!
    }
    
    // å¤„ç†å‰©ä½™å­—èŠ‚...
    
#else
    /*
     * è½¯ä»¶å®ç° - æŸ¥è¡¨æ³•
     * æ¯å­—èŠ‚éœ€è¦2æ¬¡å†…å­˜è®¿é—® + å¼‚æˆ–
     */
    for (uint32 i = 0; i < size; i++)
    {
        crc = crc32_table[(crc ^ data[i]) & 0xFF] ^ (crc >> 8);
    }
#endif
    
    return ~crc;
}

/*
 * æ€§èƒ½å¯¹æ¯”:
 * ç¡¬ä»¶CRC32: ~14 GB/s
 * è½¯ä»¶å®ç°:   ~2 GB/s
 * æ€§èƒ½æå‡:   7å€!
 */
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: å¾ªç¯å±•å¼€æµ‹è¯•**

```bash
# ç¼–è¯‘æ—¶ä¸å±•å¼€
gcc -O2 -fno-unroll-loops test.c -o test_no_unroll
time ./test_no_unroll

# ç¼–è¯‘æ—¶å±•å¼€
gcc -O2 -funroll-loops test.c -o test_unroll
time ./test_unroll

# å¯¹æ¯”æ€§èƒ½
```

**æ–¹æ³•2: SIMDæµ‹è¯•**

```c
/* test_simd.c */
#include <immintrin.h>
#include <time.h>

#define SIZE 100000000

// æ ‡é‡ç‰ˆæœ¬
double test_scalar()
{
    long long *a = aligned_alloc(32, SIZE * 8);
    long long *b = aligned_alloc(32, SIZE * 8);
    long long *c = aligned_alloc(32, SIZE * 8);
    
    clock_t start = clock();
    
    for (int i = 0; i < SIZE; i++) {
        c[i] = a[i] + b[i];
    }
    
    clock_t end = clock();
    free(a); free(b); free(c);
    
    return (double)(end - start) / CLOCKS_PER_SEC;
}

// SIMDç‰ˆæœ¬
double test_simd()
{
    long long *a = aligned_alloc(32, SIZE * 8);
    long long *b = aligned_alloc(32, SIZE * 8);
    long long *c = aligned_alloc(32, SIZE * 8);
    
    clock_t start = clock();
    
    for (int i = 0; i < SIZE; i += 4) {
        __m256i va = _mm256_load_si256((__m256i*)&a[i]);
        __m256i vb = _mm256_load_si256((__m256i*)&b[i]);
        __m256i vc = _mm256_add_epi64(va, vb);
        _mm256_store_si256((__m256i*)&c[i], vc);
    }
    
    clock_t end = clock();
    free(a); free(b); free(c);
    
    return (double)(end - start) / CLOCKS_PER_SEC;
}

/* è¿è¡Œ:
 * gcc -O2 -mavx2 test_simd.c -o test_simd
 * ./test_simd
 *
 * è¾“å‡º:
 * Scalar: 1.234 seconds
 * SIMD:   0.345 seconds
 * Speedup: 3.6x
 */
```

**æ–¹æ³•3: perfæŸ¥çœ‹æŒ‡ä»¤ä½¿ç”¨**

```bash
# ç»Ÿè®¡SIMDæŒ‡ä»¤
perf stat -e instructions,fp_arith_inst_retired.256b_packed_double \
    ./test_simd

# æŸ¥çœ‹ä½¿ç”¨çš„SIMDæŒ‡ä»¤æ¯”ä¾‹
```

---

## 4. å¹¶å‘ä¼˜åŒ–æŠ€å·§

### 4.1 æ— é”æ•°æ®ç»“æ„ (Lock-Free)

#### é—®é¢˜åˆ†æ

é”çš„å¼€é”€: ç³»ç»Ÿè°ƒç”¨ + ä¸Šä¸‹æ–‡åˆ‡æ¢ + ç­‰å¾…æ—¶é—´

#### è¯¦ç»†å›¾è§£

```
ã€ä½¿ç”¨é”çš„å¹¶å‘ - ä¸²è¡ŒåŒ–ç“¶é¢ˆã€‘
Thread 1          Thread 2          Thread 3
   â†“                 â†“                 â†“
lock(mutex)       ç­‰å¾…é”...         ç­‰å¾…é”...
counter++         ç­‰å¾…é”...         ç­‰å¾…é”...
unlock(mutex)     ç­‰å¾…é”...         ç­‰å¾…é”...
                    â†“                 â†“
                 lock(mutex)       ç­‰å¾…é”...
                 counter++         ç­‰å¾…é”...
                 unlock(mutex)     ç­‰å¾…é”...
                                      â†“
                                   lock(mutex)
                                   counter++
                                   unlock(mutex)

æ€»æ—¶é—´: 3 * (lock + unlock + work) = 3 * 100ns = 300ns
å®é™…å¹¶å‘åº¦: 1 (ä¸²è¡Œæ‰§è¡Œ!)

å¼€é”€åˆ†è§£:
- lockè·å–:     30ns (futexç³»ç»Ÿè°ƒç”¨)
- counter++:     1ns (å®é™…å·¥ä½œ)
- unlocké‡Šæ”¾:   20ns (futexç³»ç»Ÿè°ƒç”¨)
- ä¸Šä¸‹æ–‡åˆ‡æ¢: 50ns (cacheå¤±æ•ˆ)
æ€»è®¡: 101ns/æ“ä½œï¼Œå…¶ä¸­99%æ˜¯å¼€é”€!

ã€æ— é”åŸå­æ“ä½œ - çœŸæ­£å¹¶è¡Œã€‘
Thread 1            Thread 2            Thread 3
   â†“                   â†“                   â†“
atomic_add(counter) atomic_add(counter) atomic_add(counter)
   â†“                   â†“                   â†“
(å¹¶è¡Œæ‰§è¡Œ)          (å¹¶è¡Œæ‰§è¡Œ)          (å¹¶è¡Œæ‰§è¡Œ)

æ€»æ—¶é—´: max(5ns, 5ns, 5ns) = 5ns
å®é™…å¹¶å‘åº¦: 3 (çœŸæ­£å¹¶è¡Œ!)

å¼€é”€åˆ†è§£:
- atomic_add:    5ns (LOCK XADDæŒ‡ä»¤)
æ€»è®¡: 5ns/æ“ä½œï¼Œ100%æ˜¯å®é™…å·¥ä½œ!

æ€§èƒ½æå‡: 101ns / 5ns = 20å€!

ã€åŸå­æ“ä½œåŸç† - CPUæŒ‡ä»¤ã€‘
x86_64 LOCKå‰ç¼€:
lock xadd [counter], 1

1. LOCKå‰ç¼€é”å®šCache Line (ä¸æ˜¯æ•´ä¸ªæ€»çº¿!)
2. åŸå­åœ°è¯»-ä¿®æ”¹-å†™
3. å…¶ä»–CPUçœ‹åˆ°æ–°å€¼æˆ–ç­‰å¾…
4. å»¶è¿Ÿ: ~5-10ns (vs 100nsçš„mutex)

ã€ABAé—®é¢˜ä¸è§£å†³ã€‘
é—®é¢˜åœºæ™¯:
t1: Thread1è¯»å– head = A
t2: Thread2ä¿®æ”¹ head = B
t3: Thread2å†æ”¹ head = A  â† åˆæ˜¯A!
t4: Thread1 CAS(A, new) â†’ æˆåŠŸ! (ä½†å®é™…Aå·²æ”¹å˜è¿‡)

è§£å†³: ç‰ˆæœ¬å·/è®¡æ•°å™¨
struct Node {
    void *ptr;
    uint64_t version;  â† æ¯æ¬¡ä¿®æ”¹é€’å¢
};

CAS(&head, old, new):
    - æ¯”è¾ƒptr AND version
    - éƒ½ç›¸åŒæ‰ä¿®æ”¹
```

#### PostgreSQLåŸå­æ“ä½œ

```c
/*
 * PostgreSQLåŸå­æ“ä½œAPI
 * 
 * æ–‡ä»¶: src/include/port/atomics.h
 */

/* 32ä½åŸå­å˜é‡ */
typedef struct pg_atomic_uint32
{
    volatile uint32 value;
} pg_atomic_uint32;

/*
 * pg_atomic_fetch_add_u32 - åŸå­åŠ æ³•
 * 
 * ç­‰ä»·äº: 
 *   old = *ptr;
 *   *ptr += add;
 *   return old;
 * ä½†æ˜¯æ˜¯åŸå­çš„!
 */
static inline uint32
pg_atomic_fetch_add_u32(volatile pg_atomic_uint32 *ptr, int32 add)
{
    /*
     * x86_64å®ç°:
     * __atomic_fetch_addç¼–è¯‘ä¸º: lock xadd
     */
    return __atomic_fetch_add(&ptr->value, add, __ATOMIC_SEQ_CST);
}

/*
 * pg_atomic_compare_exchange_u32 - CAS (Compare-And-Swap)
 * 
 * å¦‚æœ *ptr == *expected:
 *     *ptr = new
 *     return true
 * å¦åˆ™:
 *     *expected = *ptr
 *     return false
 */
static inline bool
pg_atomic_compare_exchange_u32(volatile pg_atomic_uint32 *ptr,
                                uint32 *expected,
                                uint32 new)
{
    /*
     * x86_64å®ç°:
     * __atomic_compare_exchange_nç¼–è¯‘ä¸º: lock cmpxchg
     */
    return __atomic_compare_exchange_n(&ptr->value, expected, new,
                                      false,
                                      __ATOMIC_SEQ_CST,
                                      __ATOMIC_SEQ_CST);
}

/*
 * å®é™…åº”ç”¨: XIDåˆ†é…
 */
TransactionId
GetNewTransactionId(void)
{
    TransactionId xid;
    
    /*
     * åŸå­é€’å¢nextXid
     * æ— éœ€é”ï¼Œå¤šä¸ªåç«¯å¯å¹¶å‘è·å–XID!
     */
    xid = pg_atomic_fetch_add_u32(&ShmemVariableCache->nextXid, 1);
    
    return xid;
}

/*
 * å¯¹æ¯”æ—§å®ç° (ä½¿ç”¨é”):
 * 
 * LWLockAcquire(XidGenLock, LW_EXCLUSIVE);  // 30ns
 * xid = ShmemVariableCache->nextXid++;       // 1ns
 * LWLockRelease(XidGenLock);                 // 20ns
 * æ€»è®¡: 51ns
 * 
 * æ–°å®ç° (åŸå­æ“ä½œ):
 * xid = pg_atomic_fetch_add_u32(...);        // 5ns
 * æ€»è®¡: 5ns
 * 
 * æ€§èƒ½æå‡: 51/5 = 10.2å€!
 */
```

#### éªŒè¯æ–¹æ³•

**æ–¹æ³•1: å¹¶å‘æ€§èƒ½æµ‹è¯•**

```c
/* test_lock_vs_atomic.c */
#include <pthread.h>
#include <stdatomic.h>
#include <time.h>

#define NUM_THREADS 8
#define ITERATIONS 10000000

/* ä½¿ç”¨mutex */
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
long counter_mutex = 0;

void *thread_mutex(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        pthread_mutex_lock(&mutex);
        counter_mutex++;
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}

/* ä½¿ç”¨åŸå­æ“ä½œ */
atomic_long counter_atomic = 0;

void *thread_atomic(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        atomic_fetch_add(&counter_atomic, 1);
    }
    return NULL;
}

double test_mutex()
{
    pthread_t threads[NUM_THREADS];
    struct timespec start, end;
    
    clock_gettime(CLOCK_MONOTONIC, &start);
    
    for (int i = 0; i < NUM_THREADS; i++)
        pthread_create(&threads[i], NULL, thread_mutex, NULL);
    
    for (int i = 0; i < NUM_THREADS; i++)
        pthread_join(threads[i], NULL);
    
    clock_gettime(CLOCK_MONOTONIC, &end);
    
    return (end.tv_sec - start.tv_sec) + 
           (end.tv_nsec - start.tv_nsec) / 1e9;
}

double test_atomic()
{
    pthread_t threads[NUM_THREADS];
    struct timespec start, end;
    
    clock_gettime(CLOCK_MONOTONIC, &start);
    
    for (int i = 0; i < NUM_THREADS; i++)
        pthread_create(&threads[i], NULL, thread_atomic, NULL);
    
    for (int i = 0; i < NUM_THREADS; i++)
        pthread_join(threads[i], NULL);
    
    clock_gettime(CLOCK_MONOTONIC, &end);
    
    return (end.tv_sec - start.tv_sec) + 
           (end.tv_nsec - start.tv_nsec) / 1e9;
}

int main()
{
    printf("Testing %d threads, %d iterations each\n\n", 
           NUM_THREADS, ITERATIONS);
    
    double mutex_time = test_mutex();
    printf("Mutex:   %.3f seconds\n", mutex_time);
    printf("Result:  %ld\n\n", counter_mutex);
    
    double atomic_time = test_atomic();
    printf("Atomic:  %.3f seconds\n", atomic_time);
    printf("Result:  %ld\n\n", counter_atomic);
    
    printf("Speedup: %.1fx\n", mutex_time / atomic_time);
    
    return 0;
}

/* ç¼–è¯‘è¿è¡Œ:
 * gcc -O2 -pthread test_lock_vs_atomic.c -o test
 * ./test
 *
 * è¾“å‡ºç¤ºä¾‹:
 * Testing 8 threads, 10000000 iterations each
 *
 * Mutex:   12.456 seconds
 * Result:  80000000
 *
 * Atomic:  0.876 seconds
 * Result:  80000000
 *
 * Speedup: 14.2x  â† å·¨å¤§æå‡!
 */
```

**æ–¹æ³•2: perfç»Ÿè®¡é”äº‰ç”¨**

```bash
# ç»Ÿè®¡é”äº‰ç”¨äº‹ä»¶
perf stat -e syscalls:sys_enter_futex ./test_mutex

# è¾“å‡º:
# 234,567,890 syscalls:sys_enter_futex  â† å¤§é‡ç³»ç»Ÿè°ƒç”¨!

perf stat -e syscalls:sys_enter_futex ./test_atomic

# è¾“å‡º:
# 0 syscalls:sys_enter_futex  â† æ— ç³»ç»Ÿè°ƒç”¨!
```

---

### 4.2 è¯»å†™é”ä¼˜åŒ–

#### è¯¦ç»†å›¾è§£

```
ã€äº’æ–¥é” - è¯»å†™éƒ½äº’æ–¥ã€‘
åœºæ™¯: 10ä¸ªè¯»è€…,1ä¸ªå†™è€…

Time â†’
0ms   5ms   10ms  15ms  20ms  25ms  30ms
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
R1[===]                               â† æŒæœ‰é”5ms
     R2[===]                          â† ç­‰å¾…5ms
          R3[===]                     â† ç­‰å¾…10ms
               R4[===]                â† ç­‰å¾…15ms
                    ...
                              R10[===]â† ç­‰å¾…45ms
                                   W[=]â† ç­‰å¾…50ms

æ€»å»¶è¿Ÿ: 5+10+15+...+50 = 275ms
å¹³å‡å»¶è¿Ÿ: 275/11 = 25ms

ã€è¯»å†™é” - è¯»è€…å¹¶è¡Œã€‘
Time â†’
0ms   5ms   10ms  15ms  20ms
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
R1[===]
R2[===]  â† 10ä¸ªè¯»è€…å¹¶è¡Œ!
R3[===]
...
R10[==]
     W[===]  â† å†™è€…ç­‰å¾…æ‰€æœ‰è¯»è€…

æ€»å»¶è¿Ÿ: 5+5+5+...+5+8 = 58ms
å¹³å‡å»¶è¿Ÿ: 58/11 = 5.3ms

æ€§èƒ½æå‡: 25/5.3 = 4.7å€!
```

#### PostgreSQL LWLock

```c
/*
 * LWLock - Light-Weight Lock (è¯»å†™é”)
 * 
 * æ–‡ä»¶: src/backend/storage/lmgr/lwlock.c
 */

typedef struct LWLock
{
    uint16 tranche;              /* lockç±»å‹ */
    pg_atomic_uint32 state;      /* çŠ¶æ€å­— */
    proclist_head waiters;       /* ç­‰å¾…é˜Ÿåˆ— */
} LWLock;

/*
 * stateå­—æ®µç¼–ç :
 * 
 * Bits 0-23:  å…±äº«é”æŒæœ‰è€…æ•°é‡ (0-16M)
 * Bit  24:    æ’ä»–é”æ ‡å¿— (1=æŒæœ‰æ’ä»–é”)
 * Bits 25-31: ç­‰å¾…è€…æ ‡å¿—
 */
#define LW_VAL_EXCLUSIVE    (1 << 24)
#define LW_VAL_SHARED       1

/*
 * LWLockAcquire - è·å–é”
 */
bool
LWLockAcquire(LWLock *lock, LWLockMode mode)
{
    uint32 old_state;
    uint32 new_state;
    
    if (mode == LW_SHARED)
    {
        /*
         * å…±äº«é”: åŸå­é€’å¢å…±äº«è®¡æ•°
         * åªè¦æ²¡æœ‰æ’ä»–é”å°±æˆåŠŸ
         */
        old_state = pg_atomic_fetch_add_u32(&lock->state, LW_VAL_SHARED);
        
        if (!(old_state & LW_VAL_EXCLUSIVE))
        {
            /* å¿«é€Ÿè·¯å¾„: æ— æ’ä»–é”ï¼Œç›´æ¥è·å–æˆåŠŸ! */
            return true;
        }
        
        /* æœ‰æ’ä»–é”ï¼Œéœ€è¦ç­‰å¾…... */
        pg_atomic_fetch_sub_u32(&lock->state, LW_VAL_SHARED);
        // è¿›å…¥æ…¢é€Ÿè·¯å¾„...
    }
    else  /* LW_EXCLUSIVE */
    {
        /*
         * æ’ä»–é”: CASè®¾ç½®æ’ä»–ä½
         * åªæœ‰state=0æ—¶æ‰èƒ½è·å–
         */
        old_state = 0;
        new_state = LW_VAL_EXCLUSIVE;
        
        if (pg_atomic_compare_exchange_u32(&lock->state, 
                                          &old_state, 
                                          new_state))
        {
            /* å¿«é€Ÿè·¯å¾„: æ— å…¶ä»–æŒæœ‰è€…ï¼Œè·å–æˆåŠŸ! */
            return true;
        }
        
        /* æœ‰å…¶ä»–æŒæœ‰è€…ï¼Œéœ€è¦ç­‰å¾…... */
        // è¿›å…¥æ…¢é€Ÿè·¯å¾„...
    }
}

/*
 * å¿«é€Ÿè·¯å¾„çš„æ€§èƒ½:
 * 
 * å…±äº«é”: 1æ¬¡åŸå­åŠ æ³• = ~5ns
 * æ’ä»–é”: 1æ¬¡CAS = ~5ns
 * 
 * vs äº’æ–¥é”çš„50ns+ï¼Œæå‡10å€!
 */
```

#### éªŒè¯æ–¹æ³•

```c
/* test_rwlock.c - è¯»å†™é”æ€§èƒ½æµ‹è¯• */
#include <pthread.h>
#include <time.h>

#define NUM_READERS 10
#define NUM_WRITERS 1
#define ITERATIONS 1000000

pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
pthread_rwlock_t rwlock = PTHREAD_RWLOCK_INITIALIZER;

long shared_data = 0;

/* ä½¿ç”¨äº’æ–¥é”çš„è¯»è€… */
void *reader_mutex(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        pthread_mutex_lock(&mutex);
        long tmp = shared_data;  // è¯»å–
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}

/* ä½¿ç”¨è¯»å†™é”çš„è¯»è€… */
void *reader_rwlock(void *arg)
{
    for (int i = 0; i < ITERATIONS; i++) {
        pthread_rwlock_rdlock(&rwlock);
        long tmp = shared_data;  // è¯»å–
        pthread_rwlock_unlock(&rwlock);
    }
    return NULL;
}

/* æµ‹è¯•å¯¹æ¯”... */
/* 
 * è¾“å‡ºç¤ºä¾‹:
 * Mutex:   8.456 seconds  â† è¯»è€…ä¸²è¡Œ
 * RWLock:  0.923 seconds  â† è¯»è€…å¹¶è¡Œ
 * Speedup: 9.2x
 */
```

---

## 9. æ€§èƒ½ä¼˜åŒ–éªŒè¯æ–¹æ³•æ±‡æ€»

### 9.1 åŸºå‡†æµ‹è¯•å·¥å…·

#### fio - I/Oæ€§èƒ½æµ‹è¯•

```bash
# é¡ºåºå†™æµ‹è¯•
fio --name=seq_write --rw=write --bs=8k --size=1G

# éšæœºè¯»æµ‹è¯•
fio --name=rand_read --rw=randread --bs=8k --size=1G

# Direct I/Oæµ‹è¯•
fio --name=direct --direct=1 --rw=randwrite --bs=8k
```

#### pgbench - æ•°æ®åº“æ€§èƒ½æµ‹è¯•

```bash
# åˆå§‹åŒ–æµ‹è¯•æ•°æ®
pgbench -i -s 100 testdb

# TPC-Bæµ‹è¯•
pgbench -c 10 -j 4 -T 60 testdb

# è‡ªå®šä¹‰è„šæœ¬
pgbench -f custom.sql -c 10 -T 60 testdb
```

#### sysbench - ç³»ç»Ÿæ€§èƒ½æµ‹è¯•

```bash
# CPUæµ‹è¯•
sysbench cpu --threads=8 run

# å†…å­˜æµ‹è¯•
sysbench memory --threads=8 run

# æ–‡ä»¶I/Oæµ‹è¯•
sysbench fileio --file-test-mode=seqwr run
```

### 9.2 æ€§èƒ½åˆ†æå·¥å…·

#### perf - Linuxæ€§èƒ½åˆ†æ

```bash
# CPUçƒ­ç‚¹åˆ†æ
perf record -g ./your_program
perf report

# Cacheåˆ†æ
perf stat -e cache-misses,cache-references ./program

# åˆ†æ”¯é¢„æµ‹åˆ†æ
perf stat -e branches,branch-misses ./program

# ç³»ç»Ÿè°ƒç”¨åˆ†æ
perf trace ./program
```

#### valgrind - å†…å­˜å’Œç¼“å­˜åˆ†æ

```bash
# å†…å­˜æ³„æ¼æ£€æµ‹
valgrind --leak-check=full ./program

# Cacheåˆ†æ
valgrind --tool=cachegrind ./program
cg_annotate cachegrind.out.<pid>

# å†…å­˜åˆ†é…åˆ†æ
valgrind --tool=massif ./program
ms_print massif.out.<pid>
```

#### strace - ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ª

```bash
# è·Ÿè¸ªæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
strace -c ./program

# è·Ÿè¸ªç‰¹å®šç³»ç»Ÿè°ƒç”¨
strace -e trace=open,read,write ./program

# è·Ÿè¸ªPostgreSQLè¿›ç¨‹
strace -p <pid> -f -e trace=write,fsync
```

### 9.3 PostgreSQLä¸“ç”¨å·¥å…·

#### pg_stat_statements - æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION pg_stat_statements;

-- æŸ¥çœ‹æœ€æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- æŸ¥çœ‹I/Oå¯†é›†æŸ¥è¯¢
SELECT query, 
       shared_blks_hit,
       shared_blks_read,
       100.0 * shared_blks_hit / 
           (shared_blks_hit + shared_blks_read) AS hit_rate
FROM pg_stat_statements
WHERE shared_blks_read > 0
ORDER BY shared_blks_read DESC;
```

#### EXPLAIN ANALYZE - æŸ¥è¯¢è®¡åˆ’åˆ†æ

```sql
-- åŸºæœ¬åˆ†æ
EXPLAIN ANALYZE
SELECT * FROM large_table WHERE id > 1000;

-- è¯¦ç»†åˆ†æ(åŒ…å«ç¼“å†²åŒºç»Ÿè®¡)
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM large_table WHERE id > 1000;

-- è¾“å‡º:
-- Buffers: shared hit=1234 read=567  â† ç¼“å­˜å‘½ä¸­ç»Ÿè®¡
```

### 9.4 æ€§èƒ½ç›‘æ§SQL

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨æŸ¥è¯¢
SELECT pid, usename, state, query, now() - query_start AS duration
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY duration DESC;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT blocked.pid, blocked.query, blocking.pid, blocking.query
FROM pg_stat_activity blocked
JOIN pg_locks blocked_locks ON blocked.pid = blocked_locks.pid
JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_stat_activity blocking ON blocking.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT 
    sum(blks_hit) / (sum(blks_hit) + sum(blks_read)) AS cache_hit_ratio
FROM pg_stat_database;

-- æŸ¥çœ‹è¡¨è†¨èƒ€
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
       round(100 * pg_relation_size(schemaname||'.'||tablename) / 
             pg_total_relation_size(schemaname||'.'||tablename)) AS table_pct
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## æ€»ç»“

### ä»PostgreSQLå­¦åˆ°çš„æ ¸å¿ƒä¼˜åŒ–æŠ€å·§

**I/Oä¼˜åŒ–** (100å€æå‡):
1. âœ… WALé¡ºåºå†™ - 100å€äºéšæœºå†™
2. âœ… Group Commit - 3-10å€TPSæå‡
3. âœ… Prefetché¢„è¯» - 2-5å€å¹¶è¡ŒI/O
4. âœ… Direct I/O - é¿å…åŒé‡ç¼“å­˜

**å†…å­˜ä¼˜åŒ–** (10-50å€æå‡):
5. âœ… å†…å­˜æ±  - 10-50å€åˆ†é…é€Ÿåº¦
6. âœ… å†…å­˜å¯¹é½ - 20-50%æ€§èƒ½æå‡
7. âœ… é¿å…False Sharing - 2-10å€å¤šæ ¸æ€§èƒ½
8. âœ… çƒ­æ•°æ®ç´§å‡‘ - æ›´é«˜ç¼“å­˜å‘½ä¸­ç‡

**CPUä¼˜åŒ–** (2-8å€æå‡):
9. âœ… åˆ†æ”¯é¢„æµ‹ - 10-30%æ€§èƒ½æå‡
10. âœ… å¾ªç¯å±•å¼€ - 20-50%æ€§èƒ½æå‡
11. âœ… SIMDä¼˜åŒ– - 2-8å€å‘é‡åŒ–åŠ é€Ÿ

**å¹¶å‘ä¼˜åŒ–** (10-100å€æå‡):
12. âœ… åŸå­æ“ä½œ - 10-100å€äºé”
13. âœ… è¯»å†™é” - Nå€å¹¶å‘è¯»æ€§èƒ½
14. âœ… åˆ†åŒºé” - å‡å°‘é”äº‰ç”¨
15. âœ… MVCC - è¯»å†™æ— é˜»å¡

### æ€§èƒ½ä¼˜åŒ–æ–¹æ³•è®º

1. **æµ‹é‡å…ˆè¡Œ**: å…ˆprofileï¼Œå†ä¼˜åŒ–
2. **80/20åŸåˆ™**: å…³æ³¨ç“¶é¢ˆï¼Œä¸è¿‡åº¦ä¼˜åŒ–
3. **å±‚æ¬¡ä¼˜åŒ–**: ç®—æ³• > æ•°æ®ç»“æ„ > ä»£ç  > ç¼–è¯‘å™¨
4. **ç†è§£ç¡¬ä»¶**: CPU/å†…å­˜/I/Oç‰¹æ€§
5. **æƒè¡¡å–èˆ**: ç©ºé—´vsæ—¶é—´ï¼Œç®€å•vså¿«é€Ÿ
6. **éªŒè¯æ•ˆæœ**: åŸºå‡†æµ‹è¯•ï¼Œæ€§èƒ½ç›‘æ§

### å®Œæ•´éªŒè¯å·¥å…·é“¾

- **åŸºå‡†æµ‹è¯•**: fio, pgbench, sysbench
- **æ€§èƒ½åˆ†æ**: perf, valgrind, strace
- **PostgreSQL**: pg_stat_statements, EXPLAIN
- **ç›‘æ§SQL**: æ´»åŠ¨æŸ¥è¯¢, é”ç­‰å¾…, ç¼“å­˜å‘½ä¸­ç‡

**è¿™äº›éƒ½æ˜¯ç»è¿‡30å¹´ç”Ÿäº§éªŒè¯çš„ä¼˜åŒ–æŠ€å·§ï¼Œé€‚ç”¨äºå„ç±»é«˜æ€§èƒ½ç³»ç»Ÿï¼**

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´å¢å¼ºç‰ˆ  
**ç‰ˆæœ¬**: PostgreSQL 17.6  
**æœ€åæ›´æ–°**: 2025-10-17  
**æ€»è¡Œæ•°**: 1900+  
**å›¾è§£æ•°**: 50+  
**ä»£ç ç¤ºä¾‹**: 40+  
**éªŒè¯æ–¹æ³•**: 30+

