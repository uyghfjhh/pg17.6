# 一致性设计

> 从PostgreSQL学习分布式系统的一致性保证

**版本**: PostgreSQL 17.6  
**最后更新**: 2025-10-17

---

## 目录

1. [ACID事务保证](#1-acid事务保证)
2. [MVCC实现快照隔离](#2-mvcc实现快照隔离)
3. [两阶段锁协议](#3-两阶段锁协议)
4. [流复制一致性](#4-流复制一致性)
5. [一致性级别权衡](#5-一致性级别权衡)

---

## 1. ACID事务保证

### 1.1 ACID四大特性

```
A - Atomicity (原子性):
┌────────────────────────────────┐
│ 事务要么全部完成要么全部回滚    │
│ 实现: WAL + MVCC               │
└────────────────────────────────┘

C - Consistency (一致性):
┌────────────────────────────────┐
│ 事务前后数据库保持一致状态      │
│ 实现: 约束检查 + 触发器        │
└────────────────────────────────┘

I - Isolation (隔离性):
┌────────────────────────────────┐
│ 并发事务之间互不干扰           │
│ 实现: MVCC + 锁                │
└────────────────────────────────┘

D - Durability (持久性):
┌────────────────────────────────┐
│ 已提交事务永久保存             │
│ 实现: WAL                      │
└────────────────────────────────┘
```

### 1.2 事务状态机

```
事务状态转换:
              BEGIN
                ↓
        ┌───────────────┐
        │   IN_PROGRESS │
        └───────┬───────┘
                │
        ┌───────┴───────┐
        │               │
    COMMIT          ROLLBACK
        │               │
        ↓               ↓
┌───────────┐     ┌──────────┐
│ COMMITTED │     │ ABORTED  │
└───────────┘     └──────────┘
```

---

## 2. MVCC实现快照隔离

### 2.1 Snapshot Isolation

```
事务快照:
┌──────────────────────────────────┐
│ Transaction Start                │
│  ↓                               │
│ 获取Snapshot:                    │
│  xmin = 100                      │
│  xmax = 110                      │
│  xip = [102, 105, 108]           │
└──────────────────────────────────┘

可见性规则:
Tuple可见 ⟺
  (t_xmin < xmax) AND
  (t_xmin not in xip) AND
  (t_xmin committed) AND
  (t_xmax invalid OR t_xmax in xip)
```

### 2.2 隔离级别

```
PostgreSQL四种隔离级别:
┌─────────────────────────────────────┐
│ Read Uncommitted (实际=Read Committed) │
│  允许: 无                            │
│  防止: 脏读                          │
├─────────────────────────────────────┤
│ Read Committed (默认)               │
│  允许: 不可重复读                    │
│  防止: 脏读                          │
├─────────────────────────────────────┤
│ Repeatable Read                     │
│  允许: 幻读(PG通过MVCC避免)          │
│  防止: 脏读、不可重复读              │
├─────────────────────────────────────┤
│ Serializable                        │
│  允许: 无                            │
│  防止: 所有异常                      │
└─────────────────────────────────────┘
```

---

## 3. 两阶段锁协议

### 3.1 2PL (Two-Phase Locking)

```
锁的获取和释放:
┌────────────────────────────────┐
│ Growing Phase (增长阶段)        │
│  只能获取锁，不能释放锁         │
│                                │
│  BEGIN                         │
│   ↓                            │
│  LOCK(A) ✅                    │
│  LOCK(B) ✅                    │
│  LOCK(C) ✅                    │
└────────┬───────────────────────┘
         │ Lock Point
         ↓
┌────────────────────────────────┐
│ Shrinking Phase (收缩阶段)     │
│  只能释放锁，不能获取锁         │
│                                │
│  UNLOCK(A) ✅                  │
│  UNLOCK(B) ✅                  │
│  UNLOCK(C) ✅                  │
│   ↓                            │
│  COMMIT/ROLLBACK               │
└────────────────────────────────┘

保证: 可串行化 (Serializability)
```

### 3.2 锁冲突矩阵

```
PostgreSQL锁模式:
       │ AccessShare │ RowShare │ RowExcl │ Share │ ShareRowExcl │ Excl │ AccessExcl
───────┼─────────────┼──────────┼─────────┼───────┼──────────────┼──────┼───────────
Access │      ✅     │    ✅    │   ✅    │  ✅   │      ✅      │  ❌  │    ❌
Share  │      ✅     │    ✅    │   ❌    │  ✅   │      ❌      │  ❌  │    ❌
RowExcl│      ✅     │    ✅    │   ❌    │  ❌   │      ❌      │  ❌  │    ❌
Share  │      ✅     │    ✅    │   ❌    │  ✅   │      ❌      │  ❌  │    ❌
RowExcl│      ✅     │    ✅    │   ❌    │  ❌   │      ❌      │  ❌  │    ❌
```

---

## 4. 流复制一致性

### 4.1 同步复制 vs 异步复制

```
同步复制:
Primary                Standby
   │                      │
   │──WAL Record──────→   │
   │                      ↓
   │                   写入WAL
   │                      ↓
   │←───ACK──────────────│
   │                      │
   ↓                      │
COMMIT返回               │

优点: 数据强一致性
缺点: 延迟高

异步复制:
Primary                Standby
   │                      │
   │──WAL Record──────→   │
   ↓ COMMIT立即返回       ↓
                      写入WAL

优点: 延迟低
缺点: 可能丢失数据
```

### 4.2 一致性配置

```sql
-- 同步复制配置
synchronous_commit = on/remote_apply/remote_write/local/off

on:           等待WAL fsync到主库和从库
remote_apply: 等待从库应用WAL (最强一致性)
remote_write: 等待从库写入WAL
local:        只等待主库fsync
off:          不等待 (最快但可能丢数据)

synchronous_standby_names = 'standby1,standby2'
```

---

## 5. 一致性级别权衡

### 5.1 CAP定理

```
CAP三选二:
┌──────────────────────────────┐
│ C - Consistency (一致性)      │
│ A - Availability (可用性)     │
│ P - Partition Tolerance (分区容错) │
└──────────────────────────────┘

PostgreSQL选择:
┌──────────────────────────────┐
│ 单机: CA (强一致性 + 高可用)  │
│ 分布式: CP (强一致性 + 容错)  │
└──────────────────────────────┘
```

### 5.2 性能 vs 一致性权衡

```
一致性级别对比:
┌─────────────────────────────────────┐
│ Serializable                        │
│  一致性: ★★★★★                     │
│  性能:   ★☆☆☆☆                     │
├─────────────────────────────────────┤
│ Repeatable Read                     │
│  一致性: ★★★★☆                     │
│  性能:   ★★★☆☆                     │
├─────────────────────────────────────┤
│ Read Committed                      │
│  一致性: ★★★☆☆                     │
│  性能:   ★★★★☆                     │
├─────────────────────────────────────┤
│ Read Uncommitted                    │
│  一致性: ★★☆☆☆                     │
│  性能:   ★★★★★                     │
└─────────────────────────────────────┘

建议: 默认使用Read Committed
     金融场景使用Serializable
```

---

## 总结

### 一致性保证机制

1. **MVCC** - 快照隔离，读写不阻塞
2. **2PL** - 两阶段锁，保证可串行化
3. **WAL** - Write-Ahead Logging保证持久性
4. **同步复制** - 主从强一致性
5. **隔离级别** - 灵活的一致性选择

### 设计原则

- ✅ 根据业务需求选择隔离级别
- ✅ MVCC优于传统锁
- ✅ 同步复制保证数据安全
- ✅ 性能与一致性需要权衡

---

**下一步**: 阅读 [06_performance_optimization.md](06_performance_optimization.md)

**版本**: PostgreSQL 17.6  
**最后更新**: 2025-10-17

