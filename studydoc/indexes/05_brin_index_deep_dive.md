# BRINç´¢å¼•æ·±åº¦åˆ†æ - å—èŒƒå›´ç´¢å¼•

> PostgreSQLçš„å—èŒƒå›´ç´¢å¼• - æå°ç©ºé—´æ¢å–é«˜æ•ˆçš„å¤§è¡¨æŸ¥è¯¢

**é‡è¦ç¨‹åº¦**: â­â­â­â­  
**æºç ä½ç½®**: `src/backend/access/brin/`  
**ä½¿ç”¨åœºæ™¯**: æ—¶é—´åºåˆ—ã€å¤§è¡¨ã€ç‰©ç†æœ‰åºæ•°æ®

---

## ğŸ“‹ BRINç´¢å¼•æ€»è§ˆ

### ä»€ä¹ˆæ˜¯BRINï¼Ÿ

```
BRIN = Block Range INdex (å—èŒƒå›´ç´¢å¼•)

ã€æ ¸å¿ƒæ€æƒ³ã€‘
ä¸ç´¢å¼•æ¯ä¸€è¡Œï¼Œè€Œæ˜¯ç´¢å¼•ä¸€ç»„è¿ç»­çš„æ•°æ®å—!

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¨ (1000ä¸ªblocks)                      â”‚
â”‚ â”Œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â” â”Œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”           â”‚
â”‚ â”‚1 â”‚2 â”‚3 â”‚4 â”‚ â”‚5 â”‚6 â”‚7 â”‚8 â”‚ ...       â”‚
â”‚ â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”˜ â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”˜           â”‚
â”‚  â†“              â†“                      â”‚
â”‚ Range 1        Range 2                 â”‚
â”‚ (4 blocks)     (4 blocks)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BRINç´¢å¼•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Range 1: [min=1,    max=100]           â”‚
â”‚ Range 2: [min=101,  max=200]           â”‚
â”‚ Range 3: [min=201,  max=300]           â”‚
â”‚ ...                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢: WHERE id = 150
  â†’ æ£€æŸ¥Range 1: [1, 100]    âœ— è·³è¿‡!
  â†’ æ£€æŸ¥Range 2: [101, 200]  âœ“ æ‰«æè¿™4ä¸ªblocks
  â†’ æ£€æŸ¥Range 3: [201, 300]  âœ— è·³è¿‡!

ã€å…³é”®ä¼˜åŠ¿ã€‘
âœ“ ç´¢å¼•æå°: 1GBè¡¨ â†’ å‡ KBç´¢å¼•!
âœ“ ç»´æŠ¤å¿«: å¾ˆå°‘çš„ç´¢å¼•é¡µéœ€è¦æ›´æ–°
âœ“ é€‚åˆå¤§è¡¨: è¡¨è¶Šå¤§ï¼Œä¼˜åŠ¿è¶Šæ˜æ˜¾
âœ“ æ—¶é—´åºåˆ—: å¤©ç„¶æ”¯æŒæŒ‰æ—¶é—´æœ‰åºçš„æ•°æ®
```

### BRIN vs B-tree

```
ã€å¯¹æ¯”ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           B-tree         BRIN                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç´¢å¼•å¤§å°:  å¤§            æå° (1/1000)           â”‚
â”‚ ç²¾ç¡®åº¦:    ç²¾ç¡®          è¿‘ä¼¼ï¼ˆè¿‡æ»¤blocksï¼‰      â”‚
â”‚ æ’å…¥é€Ÿåº¦:  ä¸­            å¿«                      â”‚
â”‚ æŸ¥è¯¢é€Ÿåº¦:  å¿«            ä¸­ï¼ˆéœ€æ‰«æblocksï¼‰      â”‚
â”‚ é€‚åˆ:      éšæœºåˆ†å¸ƒ      ç‰©ç†æœ‰åº                â”‚
â”‚ ç»´æŠ¤:      éœ€VACUUM      å¾ˆå°‘ç»´æŠ¤                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç¤ºä¾‹ã€‘
è¡¨: 1äº¿è¡Œæ—¥å¿—ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’å…¥

B-treeç´¢å¼•:
  â€¢ ç´¢å¼•å¤§å°: ~2 GB
  â€¢ æŸ¥è¯¢æ—¶é—´: 0.1 ms (Index Scan)
  â€¢ æ’å…¥é€Ÿåº¦: ä¸­ï¼ˆéœ€ç»´æŠ¤æ ‘ç»“æ„ï¼‰

BRINç´¢å¼•:
  â€¢ ç´¢å¼•å¤§å°: ~2 MB (1000å€å°!)
  â€¢ æŸ¥è¯¢æ—¶é—´: 5-50 ms (å–å†³äºselectivity)
  â€¢ æ’å…¥é€Ÿåº¦: å¿«ï¼ˆå¾ˆå°‘ç´¢å¼•æ›´æ–°ï¼‰

ã€ä½•æ—¶é€‰æ‹©BRINã€‘
âœ… æ•°æ®ç‰©ç†æœ‰åºï¼ˆæ—¶é—´åºåˆ—ã€è‡ªå¢IDï¼‰
âœ… è¡¨å¾ˆå¤§ï¼ˆ> 1GBï¼‰
âœ… èŒƒå›´æŸ¥è¯¢ä¸ºä¸»
âœ… ç£ç›˜ç©ºé—´æœ‰é™
âœ… æ’å…¥é¢‘ç¹

âŒ æ•°æ®éšæœºåˆ†å¸ƒ
âŒ éœ€è¦ç²¾ç¡®æŸ¥æ‰¾
âŒ è¡¨å¾ˆå°ï¼ˆ< 100MBï¼‰
```

---

## ğŸ—ï¸ BRINç´¢å¼•ç»“æ„

### æ•´ä½“æ¶æ„

```
ã€BRINç´¢å¼•ç»“æ„ã€‘

1. Revmap (Range Map)
   â”œâ”€ å°†blockèŒƒå›´æ˜ å°„åˆ°ç´¢å¼•é¡µ
   â”œâ”€ Block Range ID â†’ Index Page
   â””â”€ å¿«é€Ÿå®šä½æ±‡æ€»ä¿¡æ¯

2. Summary Pages
   â”œâ”€ å­˜å‚¨æ¯ä¸ªèŒƒå›´çš„æ±‡æ€»ä¿¡æ¯
   â”œâ”€ Min/Max (å¯¹äºæ•´æ•°ã€æ—¥æœŸ)
   â”œâ”€ Bloom Filter (å¯¹äºæ–‡æœ¬)
   â””â”€ å…¶ä»–ç»Ÿè®¡ä¿¡æ¯

3. Metapage
   â”œâ”€ ç´¢å¼•å…ƒæ•°æ®
   â”œâ”€ pages_per_range: æ¯ä¸ªèŒƒå›´çš„å—æ•°
   â””â”€ ç‰ˆæœ¬ä¿¡æ¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             BRIN Index Structure                â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ Metapage â”‚                                   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚                                   â”‚
â”‚  â”‚ â”‚ppr:128â”‚ â”‚ â† pages_per_range                â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚       â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Revmap (Blockâ†’Page mapping)   â”‚             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚
â”‚  â”‚ â”‚ Range 0 â†’ Page 2          â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ Range 1 â†’ Page 2          â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ Range 2 â†’ Page 3          â”‚ â”‚             â”‚
â”‚  â”‚ â”‚ ...                       â”‚ â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Summary Pages                           â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ Page 2:                             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   Range 0: [min=1,    max=12800]    â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   Range 1: [min=12801,max=25600]    â”‚ â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚
â”‚  â”‚ â”‚ Page 3:                             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   Range 2: [min=25601,max=38400]    â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   ...                               â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç‰©ç†å¸ƒå±€ç¤ºä¾‹ã€‘
è¡¨: logs (100ä¸‡è¡Œï¼Œ800ä¸ªblocks)
pages_per_range: 128 blocks

Block ranges:
  Range 0: Blocks 0-127    â†’ ç´¢å¼•entry: [min, max]
  Range 1: Blocks 128-255  â†’ ç´¢å¼•entry: [min, max]
  Range 2: Blocks 256-383  â†’ ç´¢å¼•entry: [min, max]
  ...
  Range 6: Blocks 768-799  â†’ ç´¢å¼•entry: [min, max]

BRINç´¢å¼•å¤§å°:
  â€¢ 7ä¸ªèŒƒå›´ Ã— ~48å­—èŠ‚ â‰ˆ 336å­—èŠ‚
  â€¢ åŠ ä¸ŠRevmapå’ŒMetapage â‰ˆ 1-2 KB
  
vs B-tree:
  â€¢ ~5-10 MB

æ¯”ä¾‹: 1:5000!
```

### Range Summaryè¯¦è§£

```
ã€Range Summaryæ ¼å¼ã€‘

å¯¹äºæ•´æ•°/æ—¥æœŸåˆ—:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BrinValues                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ hasNulls: false              â”‚ â”‚ â† èŒƒå›´å†…æœ‰NULL?
â”‚ â”‚ hasnulls: false              â”‚ â”‚
â”‚ â”‚ allnulls: false              â”‚ â”‚ â† å…¨æ˜¯NULL?
â”‚ â”‚ values[0]: min = 1000        â”‚ â”‚ â† æœ€å°å€¼
â”‚ â”‚ values[1]: max = 2000        â”‚ â”‚ â† æœ€å¤§å€¼
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Range: Blocks 0-127             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢: WHERE id = 1500
  æ£€æŸ¥: 1500 åœ¨ [1000, 2000]? âœ“
  â†’ æ‰«æBlocks 0-127

æŸ¥è¯¢: WHERE id = 3000
  æ£€æŸ¥: 3000 åœ¨ [1000, 2000]? âœ—
  â†’ è·³è¿‡è¿™ä¸ªèŒƒå›´!

ã€ä¸åŒæ•°æ®ç±»å‹çš„Summaryã€‘

1. æ•´æ•°/æ—¥æœŸ: Min/Max
   Range 1: [min=100, max=200]
   
2. æ–‡æœ¬: Bloom Filter
   Range 1: Bloom(['apple', 'banana', ...])
   
3. å‡ ä½•: Bounding Box
   Range 1: Box[(x1,y1), (x2,y2)]

4. IPåœ°å€: Range
   Range 1: [192.168.0.0, 192.168.255.255]
```

---

## ğŸ” æŸ¥è¯¢æ“ä½œ

### èŒƒå›´æŸ¥è¯¢

```sql
-- æŸ¥è¯¢: æŸ¥æ‰¾ç‰¹å®šæ—¥æœŸèŒƒå›´çš„æ—¥å¿—
SELECT * FROM logs 
WHERE created_at BETWEEN '2024-01-15' AND '2024-01-20';
```

```
ã€BRINæŸ¥è¯¢æµç¨‹ã€‘

è¡¨: logs (æŒ‰created_atç‰©ç†æœ‰åº)
BRINç´¢å¼•: pages_per_range = 128

Step 1: æ‰«æBRINç´¢å¼•ï¼Œæ‰¾åˆ°åŒ¹é…çš„ranges
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BRIN Index Scan                         â”‚
â”‚                                         â”‚
â”‚ Range 0: [2024-01-01, 2024-01-07]       â”‚
â”‚   æŸ¥è¯¢: [2024-01-15, 2024-01-20]        â”‚
â”‚   é‡å ? âœ— è·³è¿‡!                         â”‚
â”‚                                         â”‚
â”‚ Range 1: [2024-01-08, 2024-01-14]       â”‚
â”‚   é‡å ? âœ— è·³è¿‡!                         â”‚
â”‚                                         â”‚
â”‚ Range 2: [2024-01-13, 2024-01-21]       â”‚
â”‚   é‡å ? âœ“ éœ€è¦æ‰«æ!                     â”‚â—€â”€
â”‚                                         â”‚
â”‚ Range 3: [2024-01-22, 2024-01-28]       â”‚
â”‚   é‡å ? âœ— è·³è¿‡!                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: æ‰«æåŒ¹é…çš„block ranges
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bitmap Heap Scan                        â”‚
â”‚                                         â”‚
â”‚ æ‰«æRange 2çš„æ‰€æœ‰blocks (256-383)       â”‚
â”‚ å¯¹æ¯è¡Œæ£€æŸ¥: created_atåœ¨èŒƒå›´å†…?         â”‚
â”‚ è¿”å›åŒ¹é…çš„è¡Œ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ€§èƒ½åˆ†æã€‘
æ€»blocks: 1000
BRINè¿‡æ»¤å: 128 blocks (12.8%)

vs å…¨è¡¨æ‰«æ: å‡å°‘87%çš„I/O!
vs B-tree: 
  â€¢ B-tree: 4-5æ¬¡I/O (ç´¢å¼•) + Næ¬¡(heap)
  â€¢ BRIN: 1æ¬¡I/O (ç´¢å¼•) + 128æ¬¡(heap)
  â€¢ å¦‚æœN < 100ï¼ŒB-treeæ›´å¿«
  â€¢ å¦‚æœN > 200ï¼ŒBRINå¯èƒ½æ›´å¿«ï¼ˆç´¢å¼•å°ï¼Œç¼“å­˜å‹å¥½ï¼‰
```

### ç›¸å…³æ€§ (Correlation)

```
ã€æ•°æ®ç›¸å…³æ€§å¯¹BRINæ€§èƒ½çš„å½±å“ã€‘

å®Œç¾ç›¸å…³ (Correlation = 1.0):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Block 1: [1, 2, 3, 4, ...]         â”‚
â”‚ Block 2: [101, 102, 103, ...]      â”‚
â”‚ Block 3: [201, 202, 203, ...]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
BRINç´¢å¼•:
  Range 1: [1, 100]
  Range 2: [101, 200]
  Range 3: [201, 300]
  
æŸ¥è¯¢ WHERE id = 150:
  â†’ åªæ‰«æRange 2 (1ä¸ªrange)
  â†’ éå¸¸é«˜æ•ˆ! âœ“

å®Œå…¨éšæœº (Correlation = 0.0):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Block 1: [5, 200, 75, 150, ...]    â”‚
â”‚ Block 2: [3, 199, 88, 145, ...]    â”‚
â”‚ Block 3: [10, 198, 90, 155, ...]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
BRINç´¢å¼•:
  Range 1: [1, 250]   â† èŒƒå›´å¤ªå¤§!
  Range 2: [1, 250]   â† æ²¡æœ‰è¿‡æ»¤æ•ˆæœ
  Range 3: [1, 250]
  
æŸ¥è¯¢ WHERE id = 150:
  â†’ éœ€è¦æ‰«ææ‰€æœ‰ranges
  â†’ BRINæ— æ•ˆ! âœ—

ã€æ£€æŸ¥æ•°æ®ç›¸å…³æ€§ã€‘
SELECT 
    tablename,
    attname,
    correlation
FROM pg_stats
WHERE tablename = 'logs' 
  AND attname = 'created_at';

/*
 tablename | attname    | correlation
-----------+------------+-------------
 logs      | created_at | 0.95        â† éå¸¸å¥½!
*/

ç›¸å…³æ€§è§£è¯»:
  1.0  : å®Œç¾æœ‰åº (ç†æƒ³)
  0.9+ : å¾ˆå¥½ (æ¨èä½¿ç”¨BRIN)
  0.5-0.9: ä¸­ç­‰ (å¯èƒ½æœ‰æ•ˆ)
  < 0.5: è¾ƒå·® (ä¸æ¨èBRIN)
  0.0  : å®Œå…¨éšæœº (BRINæ— æ•ˆ)
```

---

## â• æ’å…¥å’Œæ›´æ–°

### æ’å…¥æ“ä½œ

```
ã€BRINæ’å…¥æµç¨‹ã€‘

åœºæ™¯: æ’å…¥æ–°è¡Œåˆ°æ—¶é—´åºåˆ—è¡¨

INSERT INTO logs VALUES (next_id, now(), '...');

Step 1: ç¡®å®šæ–°è¡Œæ‰€åœ¨çš„block
  æ–°è¡Œ â†’ Block 1000

Step 2: è®¡ç®—æ‰€å±çš„range
  Block 1000 Ã· pages_per_range (128)
  = Range 7 (Blocks 896-1023)

Step 3: æ›´æ–°Range Summary (å¦‚æœéœ€è¦)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Range 7 Before:                     â”‚
â”‚   min = 2024-01-22 00:00:00         â”‚
â”‚   max = 2024-01-22 23:59:59         â”‚
â”‚                                     â”‚
â”‚ æ–°æ’å…¥: 2024-01-23 10:30:00         â”‚
â”‚                                     â”‚
â”‚ Range 7 After:                      â”‚
â”‚   min = 2024-01-22 00:00:00 (ä¸å˜) â”‚
â”‚   max = 2024-01-23 10:30:00 (æ›´æ–°) â”‚â—€â”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æˆæœ¬ã€‘
Best Case (ä¸éœ€è¦æ›´æ–°summary):
  â€¢ 0æ¬¡ç´¢å¼•I/O!
  â€¢ æ–°å€¼åœ¨ç°æœ‰min/maxèŒƒå›´å†…

Worst Case (éœ€è¦æ›´æ–°summary):
  â€¢ 1-2æ¬¡ç´¢å¼•I/O
  â€¢ æ›´æ–°Range Summaryé¡µ

vs B-tree:
  â€¢ B-treeæ¯æ¬¡æ’å…¥: 3-5æ¬¡ç´¢å¼•I/O
  â€¢ BRIN: 0-2æ¬¡ç´¢å¼•I/O
  
å¹³å‡: BRINæ’å…¥å¿«5-10å€!
```

### Autosummarize

```
ã€è‡ªåŠ¨æ±‡æ€»æ–°æ•°æ®ã€‘

é—®é¢˜: æ–°æ’å…¥çš„blockså¯èƒ½æ²¡æœ‰summary

PostgreSQL 10+: autosummarizeå‚æ•°
CREATE INDEX idx_created ON logs USING brin(created_at)
WITH (pages_per_range = 128, autosummarize = on);

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Autosummarizeå·¥ä½œåŸç†                   â”‚
â”‚                                         â”‚
â”‚ 1. INSERTäº§ç”Ÿæ–°çš„blocks                â”‚
â”‚                                         â”‚
â”‚ 2. autovacuumæ£€æµ‹åˆ°æ–°blocks             â”‚
â”‚                                         â”‚
â”‚ 3. è‡ªåŠ¨ä¸ºæ–°blocksåˆ›å»ºsummary            â”‚
â”‚                                         â”‚
â”‚ 4. æ–°æ•°æ®ç«‹å³å¯ä»¥è¢«BRINè¿‡æ»¤             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰‹åŠ¨æ±‡æ€»:
-- æ±‡æ€»æ•´ä¸ªç´¢å¼•
SELECT brin_summarize_new_values('idx_created');

-- æ±‡æ€»ç‰¹å®šèŒƒå›´
SELECT brin_summarize_range('idx_created', 0);  -- Range 0

-- æŸ¥çœ‹æœªæ±‡æ€»çš„pages
SELECT * FROM brin_page_items(
    get_raw_page('idx_created', 1), 'idx_created'
);
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### pages_per_rangeè°ƒä¼˜

```
ã€å…³é”®å‚æ•°: pages_per_rangeã€‘

å®šä¹‰: æ¯ä¸ªrangeåŒ…å«å¤šå°‘ä¸ªblocks

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pages_per_range = 32 (å°èŒƒå›´)          â”‚
â”‚                                        â”‚
â”‚ ä¼˜ç‚¹:                                  â”‚
â”‚   â€¢ æ›´ç²¾ç¡®çš„min/max                    â”‚
â”‚   â€¢ æ›´å°‘çš„false positive               â”‚
â”‚   â€¢ æ‰«ææ›´å°‘çš„blocks                   â”‚
â”‚                                        â”‚
â”‚ ç¼ºç‚¹:                                  â”‚
â”‚   â€¢ æ›´å¤§çš„ç´¢å¼•                         â”‚
â”‚   â€¢ æ›´å¤šçš„ç´¢å¼•ç»´æŠ¤                     â”‚
â”‚   â€¢ æ›´å¤šçš„èŒƒå›´éœ€è¦æ£€æŸ¥                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pages_per_range = 256 (å¤§èŒƒå›´)         â”‚
â”‚                                        â”‚
â”‚ ä¼˜ç‚¹:                                  â”‚
â”‚   â€¢ æ›´å°çš„ç´¢å¼•                         â”‚
â”‚   â€¢ æ›´å°‘çš„ç´¢å¼•ç»´æŠ¤                     â”‚
â”‚   â€¢ æ›´å¿«çš„ç´¢å¼•æ‰«æ                     â”‚
â”‚                                        â”‚
â”‚ ç¼ºç‚¹:                                  â”‚
â”‚   â€¢ ä¸å¤ªç²¾ç¡®çš„min/max                  â”‚
â”‚   â€¢ æ›´å¤šçš„false positive               â”‚
â”‚   â€¢ å¯èƒ½æ‰«ææ›´å¤šblocks                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é€‰æ‹©æŒ‡å—ã€‘
é«˜ç›¸å…³æ€§ (0.9+):
  pages_per_range = 128-256 (å¤§èŒƒå›´)
  â†’ æ•°æ®æœ‰åºï¼Œå¤§èŒƒå›´ä¹Ÿå¾ˆç²¾ç¡®

ä¸­ç­‰ç›¸å…³æ€§ (0.5-0.9):
  pages_per_range = 32-64 (å°èŒƒå›´)
  â†’ éœ€è¦æ›´ç²¾ç¡®çš„è¿‡æ»¤

ä½ç›¸å…³æ€§ (< 0.5):
  ä¸è¦ä½¿ç”¨BRIN!
  â†’ æ”¹ç”¨B-tree

ã€å®éªŒã€‘
-- åˆ›å»ºä¸åŒçš„BRINç´¢å¼•
CREATE INDEX idx_brin_32  USING brin(created_at) WITH (pages_per_range=32);
CREATE INDEX idx_brin_128 USING brin(created_at) WITH (pages_per_range=128);
CREATE INDEX idx_brin_256 USING brin(created_at) WITH (pages_per_range=256);

-- æ¯”è¾ƒå¤§å°
SELECT 
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as size
FROM pg_indexes
WHERE tablename = 'logs' AND indexdef LIKE '%brin%';

/*
 indexname   | size
-------------+-------
 idx_brin_32 | 256 KB
 idx_brin_128| 64 KB   â† æ¨è
 idx_brin_256| 32 KB
*/
```

### ç›‘æ§å’Œç»´æŠ¤

```sql
-- 1. æ£€æŸ¥BRINç´¢å¼•æ•ˆç‡
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM logs 
WHERE created_at > '2024-01-15';

/*
åˆ†ææŒ‡æ ‡:
  â€¢ Heap Blocks Scanned: å®é™…æ‰«æçš„blocks
  â€¢ Heap Blocks Filtered: BRINè¿‡æ»¤æ‰çš„blocks
  â€¢ Ratio = Filtered / Total
  
  Ratio > 0.8: BRINå¾ˆæœ‰æ•ˆ âœ“
  Ratio 0.5-0.8: è¿˜å¯ä»¥
  Ratio < 0.5: BRINæ•ˆæœä¸å¥½ âœ—
*/

-- 2. æ£€æŸ¥æ•°æ®ç›¸å…³æ€§
SELECT 
    attname,
    correlation
FROM pg_stats
WHERE tablename = 'logs';

-- 3. æ£€æŸ¥ç´¢å¼•Bloat
SELECT 
    pg_size_pretty(pg_relation_size('idx_created')) as index_size,
    (SELECT count(*) FROM brin_page_items(
        get_raw_page('idx_created', 1), 'idx_created'
    )) as num_ranges;

-- 4. å®šæœŸæ±‡æ€»æ–°æ•°æ®
SELECT brin_summarize_new_values('idx_created');

-- 5. REINDEX (å¦‚æœæ•°æ®é‡æ–°æ’åºäº†)
REINDEX INDEX CONCURRENTLY idx_created;
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: æ—¶é—´åºåˆ—æ—¥å¿—è¡¨

```sql
-- åœºæ™¯: IoTè®¾å¤‡æ—¥å¿—ï¼Œæ¯å¤©1000ä¸‡æ¡è®°å½•
CREATE TABLE device_logs (
    id bigint GENERATED ALWAYS AS IDENTITY,
    device_id int,
    created_at timestamp,
    temperature float,
    humidity float,
    data jsonb
);

-- æ’å…¥1å¹´æ•°æ® (36.5äº¿è¡Œ)
-- æ¯å¤©æŒ‰æ—¶é—´é¡ºåºæ’å…¥

-- è¡¨å¤§å°
SELECT pg_size_pretty(pg_total_relation_size('device_logs'));
-- çº¦ 500 GB

-- æµ‹è¯•1: æ— ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM device_logs
WHERE created_at >= '2024-01-15' 
  AND created_at < '2024-01-16';

/*
Seq Scan on device_logs
  Filter: ...
  Buffers: shared hit=6400000
Execution Time: 45678.234 ms  â† 45ç§’!
*/

-- åˆ›å»ºB-treeç´¢å¼•
CREATE INDEX idx_btree_created ON device_logs(created_at);
-- ç´¢å¼•å¤§å°: ~15 GB
-- åˆ›å»ºæ—¶é—´: ~30åˆ†é’Ÿ

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM device_logs
WHERE created_at >= '2024-01-15' 
  AND created_at < '2024-01-16';

/*
Index Scan using idx_btree_created
  Buffers: shared hit=156
Execution Time: 234.567 ms  â† 0.23ç§’
æé€Ÿ: 195å€
*/

-- åˆ›å»ºBRINç´¢å¼•
CREATE INDEX idx_brin_created ON device_logs 
USING brin(created_at) 
WITH (pages_per_range = 128, autosummarize = on);
-- ç´¢å¼•å¤§å°: ~5 MB (3000å€å°!)
-- åˆ›å»ºæ—¶é—´: ~30ç§’ (60å€å¿«!)

EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM device_logs
WHERE created_at >= '2024-01-15' 
  AND created_at < '2024-01-16';

/*
Bitmap Heap Scan on device_logs
  Recheck Cond: ...
  ->  Bitmap Index Scan on idx_brin_created
  Buffers: shared hit=5120
Execution Time: 1456.789 ms  â† 1.5ç§’

å¯¹æ¯”:
  æ— ç´¢å¼•:   45ç§’
  B-tree:   0.23ç§’  (æœ€å¿«)
  BRIN:     1.5ç§’   (ä¸­ç­‰ï¼Œä½†ç´¢å¼•æå°!)
  
BRINä¼˜åŠ¿:
  â€¢ ç´¢å¼•å°3000å€
  â€¢ åˆ›å»ºå¿«60å€
  â€¢ æ’å…¥æ€§èƒ½å½±å“å°
  â€¢ é€‚åˆå†å²æ•°æ®å½’æ¡£
*/
```

### æ¡ˆä¾‹2: BRIN vs B-treeæƒè¡¡

```sql
-- ä½•æ—¶é€‰æ‹©BRINï¼Ÿ

ã€åœºæ™¯1: å†å²æ—¥å¿—è¡¨ã€‘
  â€¢ æ•°æ®: æ—¶é—´æœ‰åº (correlation = 0.99)
  â€¢ å¤§å°: 100 GB+
  â€¢ æŸ¥è¯¢: æŒ‰æ—¥æœŸèŒƒå›´
  â€¢ æ’å…¥: é¢‘ç¹ (æ¯ç§’1000+)
  
  æ¨è: BRIN âœ“
  åŸå› : 
    - æå°ç´¢å¼•(KBçº§)
    - æ’å…¥å¿«
    - æŸ¥è¯¢æ€§èƒ½å¯æ¥å—

ã€åœºæ™¯2: ç”¨æˆ·è®¢å•è¡¨ã€‘
  â€¢ æ•°æ®: user_idéšæœºåˆ†å¸ƒ
  â€¢ å¤§å°: 10 GB
  â€¢ æŸ¥è¯¢: WHERE user_id = ?
  â€¢ æ’å…¥: ä¸­ç­‰ (æ¯ç§’100)
  
  æ¨è: B-tree âœ“
  åŸå› :
    - æ•°æ®éšæœº(correlationä½)
    - BRINæ— æ•ˆ
    - éœ€è¦ç²¾ç¡®æŸ¥æ‰¾

ã€åœºæ™¯3: ä¼ æ„Ÿå™¨æ•°æ®ã€‘
  â€¢ æ•°æ®: æŒ‰sensor_idå’Œæ—¶é—´æ’åº
  â€¢ å¤§å°: 500 GB
  â€¢ æŸ¥è¯¢: WHERE sensor_id = ? AND time > ?
  â€¢ æ’å…¥: éå¸¸é¢‘ç¹
  
  æ¨è: 
    - B-tree on sensor_id
    - BRIN on time
  åŸå› :
    - sensor_idéœ€è¦ç²¾ç¡®æŸ¥æ‰¾
    - timeæœ‰åºï¼ŒBRINé«˜æ•ˆ
    - ç»„åˆç´¢å¼•ä¼˜åŒ–

ã€æ··åˆç­–ç•¥ã€‘
CREATE INDEX idx_sensor ON sensors(sensor_id);  -- B-tree
CREATE INDEX idx_time ON sensors 
USING brin(created_at) 
WITH (pages_per_range = 128);  -- BRIN

æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šé€‰æ‹©æœ€ä¼˜ç´¢å¼•!
```

---

## æ€»ç»“

### BRINç´¢å¼•æ ¸å¿ƒè¦ç‚¹

1. **æ ¸å¿ƒç‰¹ç‚¹**
   - âœ… ç´¢å¼•æå° (æ¯”B-treeå°1000å€)
   - âœ… æ’å…¥å¿« (æ¯”B-treeå¿«5-10å€)
   - âœ… ç»´æŠ¤ç®€å•
   - âœ… é€‚åˆå¤§è¡¨
   - âŒ éœ€è¦ç‰©ç†æœ‰åºæ•°æ®
   - âŒ æŸ¥è¯¢ä¸å¦‚B-treeç²¾ç¡®

2. **é€‚ç”¨åœºæ™¯**
   - âœ… æ—¶é—´åºåˆ—æ•°æ®
   - âœ… è‡ªå¢IDåˆ—
   - âœ… ç‰©ç†æœ‰åºæ•°æ®
   - âœ… å¤§è¡¨ (> 1GB)
   - âœ… é¢‘ç¹æ’å…¥
   - âŒ éšæœºåˆ†å¸ƒæ•°æ®
   - âŒ éœ€è¦ç²¾ç¡®æŸ¥æ‰¾
   - âŒ å°è¡¨

3. **æ€§èƒ½å¯¹æ¯”**
   ```
   æŒ‡æ ‡          B-tree    BRIN
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ç´¢å¼•å¤§å°      2 GB      2 MB
   åˆ›å»ºæ—¶é—´      30 min    30 sec
   æ’å…¥é€Ÿåº¦      ä¸­        å¿«
   æŸ¥è¯¢é€Ÿåº¦      å¿«        ä¸­
   ç»´æŠ¤å¼€é”€      é«˜        ä½
   ```

4. **æœ€ä½³å®è·µ**
   - âœ… æ£€æŸ¥æ•°æ®ç›¸å…³æ€§ (>0.9æ¨è)
   - âœ… è°ƒæ•´pages_per_range (128æ¨è)
   - âœ… å¼€å¯autosummarize
   - âœ… å®šæœŸæ±‡æ€»æ–°æ•°æ®
   - âœ… ç›‘æ§è¿‡æ»¤æ•ˆç‡
   - âœ… è€ƒè™‘ä¸B-treeæ··åˆä½¿ç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: PostgreSQL 17.6  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**é‡è¦ç¨‹åº¦**: â­â­â­â­  
**ä¸‹ä¸€ç¯‡**: ç´¢å¼•é€‰æ‹©å’Œæ€§èƒ½ä¼˜åŒ–æŒ‡å—

