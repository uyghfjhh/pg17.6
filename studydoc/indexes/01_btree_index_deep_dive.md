# B-treeç´¢å¼•æ·±åº¦åˆ†æ

> PostgreSQLæœ€é‡è¦çš„ç´¢å¼•ç±»å‹ - å®Œæ•´çš„ç»“æ„ã€ç®—æ³•å’Œå®ç°

**é‡è¦ç¨‹åº¦**: â­â­â­â­â­  
**æºç ä½ç½®**: `src/backend/access/nbtree/`  
**ä½¿ç”¨åœºæ™¯**: 90%çš„ç´¢å¼•éœ€æ±‚

---

## ğŸ“‹ B-treeç´¢å¼•æ€»è§ˆ

### ä¸ºä»€ä¹ˆå«B-treeï¼Ÿ

```
B-tree = Balanced Tree (å¹³è¡¡æ ‘)

ã€å…³é”®ç‰¹æ€§ã€‘
âœ“ è‡ªå¹³è¡¡: æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚
âœ“ æœ‰åº: æ•°æ®æŒ‰keyæ’åºå­˜å‚¨
âœ“ é«˜æ•ˆ: O(log N)æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤
âœ“ èŒƒå›´: æ”¯æŒèŒƒå›´æ‰«æï¼ˆ<, >, BETWEENï¼‰
âœ“ æ’åº: æ”¯æŒORDER BYä¼˜åŒ–
```

### PostgreSQLä¸­çš„B-tree

```
ã€PostgreSQL B-tree = B+ treeå˜ä½“ã€‘

ä¸æ ‡å‡†B-treeçš„åŒºåˆ«:
1. æ•°æ®åªåœ¨å¶å­èŠ‚ç‚¹
   - InternalèŠ‚ç‚¹åªå­˜keyå’ŒæŒ‡é’ˆ
   - LeafèŠ‚ç‚¹å­˜key + TID (tuple identifier)

2. å¶å­èŠ‚ç‚¹é“¾è¡¨
   - Leafé¡µä¹‹é—´æœ‰åŒå‘é“¾è¡¨
   - æ”¯æŒé«˜æ•ˆèŒƒå›´æ‰«æ

3. é¡µçº§ç»“æ„
   - ä½¿ç”¨8KBé¡µ
   - é¡µå†…itemsæ’åº
   - æ”¯æŒå¹¶å‘è®¿é—®

4. é«˜åº¦é€šå¸¸å¾ˆå°
   - 3å±‚å¯æ”¯æŒæ•°ç™¾ä¸‡è¡Œ
   - 4å±‚å¯æ”¯æŒæ•°åäº¿è¡Œ
```

---

## ğŸ—ï¸ B-treeæ•´ä½“ç»“æ„

### ä¸‰å±‚B-treeç¤ºä¾‹

```
ã€å®Œæ•´çš„B-treeç»“æ„ã€‘

                        Metapage
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ magic: 0x053162â”‚
                        â”‚ version: 4     â”‚
                        â”‚ root: 3        â”‚â—€â”€ æŒ‡å‘Rooté¡µ
                        â”‚ level: 2       â”‚
                        â”‚ fastroot: 3    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
                    Root Page (Block #3)
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Level: 2                    â”‚
                    â”‚  Items: [(âˆ, 4), (50, 5)]   â”‚
                    â”‚         â†“         â†“          â”‚
                    â”‚      Block 4   Block 5       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                                     â”‚
    Internal Page (Block #4)                    Internal Page (Block #5)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Level: 1              â”‚                 â”‚  Level: 1              â”‚
    â”‚  Items: [(âˆ,10),       â”‚                 â”‚  Items: [(âˆ,15),       â”‚
    â”‚          (20,11),      â”‚                 â”‚          (70,16),      â”‚
    â”‚          (40,12)]      â”‚                 â”‚          (90,17)]      â”‚
    â”‚          â†“   â†“    â†“    â”‚                 â”‚          â†“   â†“    â†“    â”‚
    â”‚         10  11   12    â”‚                 â”‚         15  16   17    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚   â”‚    â”‚                                 â”‚   â”‚    â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”
       â”‚          â”‚           â”‚                   â”‚          â”‚           â”‚
   Leaf(#10)  Leaf(#11)  Leaf(#12)           Leaf(#15)  Leaf(#16)  Leaf(#17)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Level:0â”‚ â”‚ Level:0â”‚ â”‚ Level:0â”‚          â”‚ Level:0â”‚ â”‚ Level:0â”‚ â”‚ Level:0â”‚
   â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚          â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ â—€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚ â”‚        â”‚ â”‚        â”‚          â”‚        â”‚ â”‚        â”‚ â”‚        â”‚
   â”‚ Items: â”‚ â”‚ Items: â”‚ â”‚ Items: â”‚          â”‚ Items: â”‚ â”‚ Items: â”‚ â”‚ Items: â”‚
   â”‚ [1â†’TID]â”‚ â”‚[20â†’TID]â”‚ â”‚[40â†’TID]â”‚          â”‚[50â†’TID]â”‚ â”‚[70â†’TID]â”‚ â”‚[90â†’TID]â”‚
   â”‚ [5â†’TID]â”‚ â”‚[25â†’TID]â”‚ â”‚[42â†’TID]â”‚          â”‚[55â†’TID]â”‚ â”‚[75â†’TID]â”‚ â”‚[92â†’TID]â”‚
   â”‚[10â†’TID]â”‚ â”‚[30â†’TID]â”‚ â”‚[45â†’TID]â”‚          â”‚[60â†’TID]â”‚ â”‚[80â†’TID]â”‚ â”‚[95â†’TID]â”‚
   â”‚[15â†’TID]â”‚ â”‚[35â†’TID]â”‚ â”‚[48â†’TID]â”‚          â”‚[65â†’TID]â”‚ â”‚[85â†’TID]â”‚ â”‚[98â†’TID]â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘ â—€â”€â”€â”€â”€â”€â”€â”€â–¶ â†‘ â—€â”€â”€â”€â”€â”€â”€â”€â–¶ â†‘                â†‘ â—€â”€â”€â”€â”€â”€â”€â”€â–¶ â†‘ â—€â”€â”€â”€â”€â”€â”€â”€â–¶ â†‘
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            åŒå‘é“¾è¡¨è¿æ¥                              åŒå‘é“¾è¡¨è¿æ¥

ã€å…³é”®ç‚¹ã€‘
1. Metapage (Block 0): å­˜å‚¨å…ƒæ•°æ®
2. Root Page: æ ‘çš„æ ¹ï¼ŒæŒ‡å‘ä¸‹å±‚
3. Internal Pages: ä¸­é—´å±‚ï¼Œåªæœ‰keyå’ŒæŒ‡é’ˆ
4. Leaf Pages: å¶å­å±‚ï¼Œå­˜å‚¨keyâ†’TIDæ˜ å°„
5. Leafé“¾è¡¨: å¶å­é¡µåŒå‘é“¾æ¥ï¼Œæ”¯æŒèŒƒå›´æ‰«æ
6. é«˜åº¦: ä»Rootåˆ°Leafçš„å±‚æ•°ï¼ˆæ­¤ä¾‹ä¸º2ï¼‰
```

---

## ğŸ“„ é¡µé¢ç»“æ„è¯¦è§£

### 8KBé¡µé¢å¸ƒå±€

```
ã€B-tree Pageå¸ƒå±€ã€‘

æ¯ä¸ªB-treeé¡µé¢ = 8192 bytes (8KB)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8KB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PageHeaderData       â”‚  BTPageOpaqueDataâ”‚   Item Pointers     â”‚   Free Space     â”‚   Items         â”‚ â”‚
â”‚  â”‚   (24 bytes)           â”‚  (16 bytes)      â”‚   (Array)           â”‚   (åŠ¨æ€)         â”‚   (å˜é•¿)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â†‘                        â†‘                  â†‘                     â†‘                  â†‘                    â”‚
â”‚  0                        24                 40                    å¢é•¿â†’              â†å¢é•¿             8192â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€è¯¦ç»†ç»“æ„ã€‘

0â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PageHeaderData (24 bytes)      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ pd_lsn        (8 bytes)  â”‚â—€â”€ WAL LSN
â”‚ â”‚ pd_checksum   (2 bytes)  â”‚â—€â”€ é¡µé¢æ ¡éªŒå’Œ
â”‚ â”‚ pd_flags      (2 bytes)  â”‚â—€â”€ æ ‡å¿—ä½
â”‚ â”‚ pd_lower      (2 bytes)  â”‚â—€â”€ Free spaceèµ·å§‹
â”‚ â”‚ pd_upper      (2 bytes)  â”‚â—€â”€ Free spaceç»“æŸ
â”‚ â”‚ pd_special    (2 bytes)  â”‚â—€â”€ Special spaceåç§»
â”‚ â”‚ pd_pagesize   (2 bytes)  â”‚â—€â”€ é¡µå¤§å°(8192)
â”‚ â”‚ pd_version    (2 bytes)  â”‚â—€â”€ é¡µç‰ˆæœ¬
â”‚ â”‚ pd_prune_xid  (4 bytes)  â”‚â—€â”€ æœ€è€xid
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
24â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BTPageOpaqueData (16 bytes)    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ btpo_prev     (4 bytes)  â”‚â—€â”€ å‰ä¸€é¡µblockå·
â”‚ â”‚ btpo_next     (4 bytes)  â”‚â—€â”€ åä¸€é¡µblockå·
â”‚ â”‚ btpo_level    (2 bytes)  â”‚â—€â”€ æ ‘çš„å±‚æ¬¡(0=leaf)
â”‚ â”‚ btpo_flags    (2 bytes)  â”‚â—€â”€ é¡µç±»å‹æ ‡å¿—
â”‚ â”‚ btpo_cycleid  (4 bytes)  â”‚â—€â”€ vacuumå‘¨æœŸID
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
40â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Item Pointers (åŠ¨æ€æ•°ç»„)       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ItemIdData #1 (4 bytes)  â”‚   â”‚
â”‚ â”‚   lp_off    (15 bits)    â”‚â—€â”€ Itemåç§»
â”‚ â”‚   lp_flags  ( 2 bits)    â”‚â—€â”€ æ ‡å¿—(unused/normal/redirect/dead)
â”‚ â”‚   lp_len    (15 bits)    â”‚â—€â”€ Itemé•¿åº¦
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ItemIdData #2 (4 bytes)  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ItemIdData #3 (4 bytes)  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ...                      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Free Space (å‘ä¸‹å¢é•¿)
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Items (ä»é¡µå°¾å‘ä¸Šå¢é•¿)         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ... Item #3              â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ ... Item #2              â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ IndexTupleData #1        â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚ â”‚ â”‚ t_tid (6 bytes)    â”‚â—€â”€â”¼â”€ TID (block, offset)
â”‚ â”‚ â”‚   ip_blkid (4)     â”‚   â”‚   â”‚
â”‚ â”‚ â”‚   ip_posid (2)     â”‚   â”‚   â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚ â”‚ â”‚ t_info (2 bytes)   â”‚â—€â”€â”¼â”€ æ ‡å¿—å’Œå¤§å°
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚ â”‚ â”‚ Key data (å˜é•¿)    â”‚â—€â”€â”¼â”€ ç´¢å¼•é”®å€¼
â”‚ â”‚ â”‚ ...                â”‚   â”‚   â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
8192â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Internal Page vs Leaf Page

```
ã€Internal Page - åªå­˜æŒ‡é’ˆã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Item #1: [Key: -âˆ, Pointer: 10]     â”‚â—€â”€ æœ€å°keyï¼ŒæŒ‡å‘å­é¡µ10
â”‚ Item #2: [Key: 50, Pointer: 11]     â”‚â—€â”€ Keyâ‰¥50ï¼ŒæŒ‡å‘å­é¡µ11
â”‚ Item #3: [Key: 100, Pointer: 12]    â”‚â—€â”€ Keyâ‰¥100ï¼ŒæŒ‡å‘å­é¡µ12
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Leaf Page - å­˜æ•°æ®æŒ‡é’ˆã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Item #1: [Key: 1, TID: (5, 10)]     â”‚â—€â”€ key=1, æŒ‡å‘heap(block5,off10)
â”‚ Item #2: [Key: 5, TID: (5, 15)]     â”‚â—€â”€ key=5, æŒ‡å‘heap(block5,off15)
â”‚ Item #3: [Key: 10, TID: (8, 3)]     â”‚â—€â”€ key=10, æŒ‡å‘heap(block8,off3)
â”‚ ...                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æŸ¥æ‰¾æ“ä½œè¯¦è§£

### å•ç‚¹æŸ¥æ‰¾æµç¨‹

```sql
-- æŸ¥è¯¢: æŸ¥æ‰¾key=75çš„è®°å½•
SELECT * FROM users WHERE id = 75;
```

```
ã€B-treeæŸ¥æ‰¾æµç¨‹ã€‘

Step 1: ä»Rootå¼€å§‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Root (Level 2)      â”‚
â”‚ Items:              â”‚
â”‚   (-âˆ, 4)  â†’ <50    â”‚
â”‚   (50, 5)  â†’ â‰¥50    â”‚â—€â”€ 75 â‰¥ 50ï¼Œé€‰æ‹©é¡µ5
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ è¯»å–Block 5
         
Step 2: éå†Internalé¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal (Level 1)  â”‚
â”‚ Block 5             â”‚
â”‚ Items:              â”‚
â”‚   (-âˆ, 15) â†’ <50    â”‚
â”‚   (70, 16) â†’ â‰¥70    â”‚â—€â”€ 75 â‰¥ 70ï¼Œé€‰æ‹©é¡µ16
â”‚   (90, 17) â†’ â‰¥90    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ è¯»å–Block 16
         
Step 3: éå†Leafé¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf (Level 0)      â”‚
â”‚ Block 16            â”‚
â”‚ Items:              â”‚
â”‚   [70 â†’ (100, 5)]   â”‚
â”‚   [75 â†’ (100, 8)]   â”‚â—€â”€ æ‰¾åˆ°! TID=(100, 8)
â”‚   [80 â†’ (102, 3)]   â”‚
â”‚   [85 â†’ (105, 1)]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ æ ¹æ®TIDè®¿é—®heap
         
Step 4: è®¿é—®Heapè¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heap Block 100      â”‚
â”‚ Offset 8:           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ id: 75          â”‚ â”‚â—€â”€ è¿”å›è¿™ä¸ªtuple
â”‚ â”‚ name: "Alice"   â”‚ â”‚
â”‚ â”‚ ...             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€I/Oç»Ÿè®¡ã€‘
æ€»I/O: 4æ¬¡
  1. Root page
  2. Internal page
  3. Leaf page
  4. Heap page

æ—¶é—´å¤æ‚åº¦: O(log N) + O(1)
  log N: æ ‘éå†
  1: heapè®¿é—®
```

### èŒƒå›´æ‰«ææµç¨‹

```sql
-- æŸ¥è¯¢: èŒƒå›´æŸ¥æ‰¾
SELECT * FROM users WHERE id BETWEEN 70 AND 85;
```

```
ã€B-treeèŒƒå›´æ‰«æã€‘

Step 1-3: å®šä½åˆ°èµ·å§‹Leafé¡µï¼ˆåŒå•ç‚¹æŸ¥æ‰¾ï¼‰
æ‰¾åˆ°key=70çš„Leafé¡µ

Step 4: é¡ºåºæ‰«æLeafé¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚â—€â”€â”€â”€â”€â–¶â”‚ Leaf Block 17       â”‚
â”‚ Items:              â”‚ next â”‚ Items:              â”‚
â”‚   [70 â†’ (100, 5)] âœ“â”‚      â”‚   [90 â†’ (110, 2)]   â”‚
â”‚   [75 â†’ (100, 8)] âœ“â”‚      â”‚   [92 â†’ (111, 5)]   â”‚
â”‚   [80 â†’ (102, 3)] âœ“â”‚      â”‚   [95 â†’ (112, 8)]   â”‚
â”‚   [85 â†’ (105, 1)] âœ“â”‚      â”‚   [98 â†’ (113, 3)]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â†‘
         â”‚                            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              é€šè¿‡nextæŒ‡é’ˆå‰è¿›
              ç›´åˆ°key > 85åœæ­¢

ã€å…³é”®ä¼˜åŠ¿ã€‘
âœ“ åˆ©ç”¨Leafé“¾è¡¨ï¼Œæ— éœ€å›åˆ°ä¸Šå±‚
âœ“ é¡ºåºI/Oï¼Œç£ç›˜å‹å¥½
âœ“ é¢„è¯»ä¼˜åŒ–ï¼ˆOS levelï¼‰
âœ“ é«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢

ã€I/Oç»Ÿè®¡ã€‘
èŒƒå›´[70, 85]ï¼Œå‡è®¾è·¨2ä¸ªLeafé¡µ:
  I/O: Root(1) + Internal(1) + Leaf(2) = 4æ¬¡
  vs å…¨è¡¨æ‰«æ: å¯èƒ½éœ€è¦æ‰«ææ•´ä¸ªè¡¨
```

---

## â• æ’å…¥æ“ä½œè¯¦è§£

### ç®€å•æ’å…¥ï¼ˆé¡µæœªæ»¡ï¼‰

```
ã€æ’å…¥key=73åˆ°B-treeã€‘

Beforeæ’å…¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚
â”‚ Items: (4ä¸ª)        â”‚
â”‚   [70 â†’ TID1]       â”‚
â”‚   [75 â†’ TID2]       â”‚
â”‚   [80 â†’ TID3]       â”‚
â”‚   [85 â†’ TID4]       â”‚
â”‚ Free Space: 7KB     â”‚â—€â”€ è¿˜æœ‰å¾ˆå¤šç©ºé—´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Afteræ’å…¥key=73:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚
â”‚ Items: (5ä¸ª)        â”‚
â”‚   [70 â†’ TID1]       â”‚
â”‚   [73 â†’ TID_new]    â”‚â—€â”€ æ–°æ’å…¥ï¼Œä¿æŒæœ‰åº
â”‚   [75 â†’ TID2]       â”‚
â”‚   [80 â†’ TID3]       â”‚
â”‚   [85 â†’ TID4]       â”‚
â”‚ Free Space: 6.9KB   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ“ä½œæ­¥éª¤ã€‘
1. å®šä½åˆ°Leafé¡µ (é€šè¿‡æ ‘éå†)
2. åœ¨é¡µå†…äºŒåˆ†æŸ¥æ‰¾æ’å…¥ä½ç½®
3. æ’å…¥æ–°Item (ä¿æŒæœ‰åº)
4. æ›´æ–°é¡µå¤´ä¿¡æ¯ (pd_lower)

æ—¶é—´: O(log N)æ ‘éå† + O(M)é¡µå†…æ’å…¥
M = é¡µå†…Itemæ•°é‡ï¼Œé€šå¸¸<100
```

### é¡µåˆ†è£‚ï¼ˆPage Splitï¼‰

```
ã€é¡µæ»¡æ—¶çš„åˆ†è£‚ã€‘

åœºæ™¯: Leafé¡µå·²æ»¡ï¼Œæ’å…¥key=73

Step 1: Beforeæ’å…¥ï¼ˆé¡µå·²æ»¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16 (FULL!)               â”‚
â”‚ Free Space: 100 bytes (ä¸å¤Ÿ)        â”‚
â”‚ Items: (367ä¸ªitemsï¼Œå¡«æ»¡8KB)        â”‚
â”‚   [70 â†’ TID]                        â”‚
â”‚   [71 â†’ TID]                        â”‚
â”‚   [72 â†’ TID]                        â”‚
â”‚   [74 â†’ TID]                        â”‚â—€â”€ è¦åœ¨è¿™é‡Œæ’å…¥73
â”‚   [75 â†’ TID]                        â”‚
â”‚   ...                               â”‚
â”‚   [89 â†’ TID]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: åˆ†é…æ–°é¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ New Leaf Block 20   â”‚â—€â”€ ä»ç£ç›˜åˆ†é…æ–°é¡µ
â”‚ (ç©ºç™½)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: åˆ†è£‚ç‚¹é€‰æ‹©ï¼ˆé€šå¸¸ä¸­ç‚¹ï¼‰
æ‰¾åˆ°ä¸­é—´key = 80

Step 4: ç§»åŠ¨Items
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Left Half (Block 16)   â”‚â—€â”€â”€â”€â”€â”€â”€â–¶â”‚ Right Half (Block 20)  â”‚
â”‚ Items:                 â”‚  next  â”‚ Items:                 â”‚
â”‚   [70 â†’ TID]           â”‚        â”‚   [80 â†’ TID]           â”‚
â”‚   [71 â†’ TID]           â”‚        â”‚   [81 â†’ TID]           â”‚
â”‚   [72 â†’ TID]           â”‚        â”‚   [82 â†’ TID]           â”‚
â”‚   [73 â†’ TID_new]       â”‚â—€â”€æ’å…¥  â”‚   ...                  â”‚
â”‚   [74 â†’ TID]           â”‚        â”‚   [89 â†’ TID]           â”‚
â”‚   [75 â†’ TID]           â”‚        â”‚                        â”‚
â”‚   ...                  â”‚        â”‚ Free Space: ~4KB       â”‚
â”‚   [79 â†’ TID]           â”‚        â”‚                        â”‚
â”‚ Free Space: ~4KB       â”‚        â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 5: æ›´æ–°çˆ¶é¡µï¼ˆInsertåˆ†éš”keyï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parent Internal Page            â”‚
â”‚ Before:                         â”‚
â”‚   [(-âˆ, 16), (90, 17)]          â”‚
â”‚                                 â”‚
â”‚ After:                          â”‚
â”‚   [(-âˆ, 16), (80, 20), (90, 17)]â”‚â—€â”€ æ·»åŠ æ–°çš„åˆ†éš”key=80
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¦‚æœçˆ¶é¡µä¹Ÿæ»¡äº†?                 â”‚
â”‚ â†’ é€’å½’åˆ†è£‚çˆ¶é¡µ!                 â”‚
â”‚ â†’ æœ€åæƒ…å†µ: åˆ†è£‚åˆ°Root          â”‚
â”‚ â†’ Rootåˆ†è£‚ â†’ æ ‘é«˜åº¦+1           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€åˆ†è£‚ä»£ä»·ã€‘
I/O:
  - è¯»: 1 (åŸé¡µ)
  - å†™: 2 (åŸé¡µ + æ–°é¡µ)
  - çˆ¶é¡µæ›´æ–°: 1å†™ (å¯èƒ½é€’å½’)
  
æ—¶é—´: O(log N) + O(M)
  log N: å®šä½
  M: é¡µå†…ç§»åŠ¨

ã€ä¼˜åŒ–ã€‘
âœ“ åˆ†è£‚ç‚¹é€‰æ‹©: å°½é‡å¹³è¡¡
âœ“ Fillfactor: é¢„ç•™ç©ºé—´ï¼Œå‡å°‘åˆ†è£‚
âœ“ HOTæ›´æ–°: é¿å…ç´¢å¼•æ›´æ–°
```

### Rootåˆ†è£‚ï¼ˆæ ‘é«˜åº¦å¢é•¿ï¼‰

```
ã€Rooté¡µåˆ†è£‚ - å”¯ä¸€å¢åŠ æ ‘é«˜åº¦çš„æ“ä½œã€‘

åœºæ™¯: Rooté¡µä¹Ÿæ»¡äº†

Before: 2å±‚æ ‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Root (Full!)        â”‚
â”‚ Level: 1            â”‚
â”‚ Items: (367ä¸ª)      â”‚
â”‚ æŒ‡å‘å¾ˆå¤šLeafé¡µ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    Many Leafs

After: 3å±‚æ ‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ New Root            â”‚â—€â”€ æ–°Rooté¡µ
â”‚ Level: 2            â”‚
â”‚ Items: (2ä¸ª)        â”‚
â”‚   [(-âˆ, old_root)]  â”‚
â”‚   [(split_key, new)]â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚       â”‚
   â”Œâ”€â”€â”€â”˜       â””â”€â”€â”€â”
   â”‚               â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Old Root    â”‚ â”‚ New Page    â”‚â—€â”€ å˜æˆInternalé¡µ
â”‚ Level: 1    â”‚ â”‚ Level: 1    â”‚
â”‚ (ä¸€åŠitems) â”‚ â”‚ (å¦ä¸€åŠ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚    â”‚           â”‚    â”‚
  Leafs ...       Leafs ...

ã€å…³é”®ç‚¹ã€‘
âœ“ Rootåˆ†è£‚æ˜¯æ ‘é«˜åº¦å¢åŠ çš„å”¯ä¸€æ–¹å¼
âœ“ æ—§Rootå˜æˆInternalé¡µ
âœ“ æ–°Rootåªæœ‰2ä¸ªitems (åˆ†éš”ç‚¹)
âœ“ æ‰€æœ‰Leafä»åœ¨åŒä¸€å±‚ (å¹³è¡¡æ€§)
```

---

## â– åˆ é™¤æ“ä½œè¯¦è§£

### ç®€å•åˆ é™¤

```
ã€åˆ é™¤key=73ã€‘

Before:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚
â”‚ Items:              â”‚
â”‚   [70 â†’ TID1]       â”‚
â”‚   [73 â†’ TID2]       â”‚â—€â”€ è¦åˆ é™¤
â”‚   [75 â†’ TID3]       â”‚
â”‚   [80 â†’ TID4]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: æ ‡è®°ä¸ºDead (ä¸ç«‹å³åˆ é™¤)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚
â”‚ Items:              â”‚
â”‚   [70 â†’ TID1]       â”‚
â”‚   [73 â†’ DEAD]       â”‚â—€â”€ æ ‡è®°ä¸ºDead
â”‚   [75 â†’ TID3]       â”‚
â”‚   [80 â†’ TID4]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: VACUUMæ¸…ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16       â”‚
â”‚ Items:              â”‚
â”‚   [70 â†’ TID1]       â”‚
â”‚   [75 â†’ TID3]       â”‚â—€â”€ Dead itemè¢«ç§»é™¤
â”‚   [80 â†’ TID4]       â”‚
â”‚ Free Space: +20B    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ä¸ºä»€ä¹ˆä¸ç«‹å³åˆ é™¤ï¼Ÿã€‘
âœ“ å¹¶å‘: å¯èƒ½æœ‰äº‹åŠ¡æ­£åœ¨è¯»å–
âœ“ MVCC: éœ€è¦ä¿ç•™å¯è§æ€§ä¿¡æ¯
âœ“ æ€§èƒ½: æ‰¹é‡æ¸…ç†æ›´é«˜æ•ˆ
```

### é¡µåˆå¹¶ï¼ˆPage Mergeï¼‰

```
ã€é¡µåˆ©ç”¨ç‡è¿‡ä½æ—¶åˆå¹¶ã€‘

åœºæ™¯: Leafé¡µåˆ é™¤å¾ˆå¤šitemsåï¼Œåˆ©ç”¨ç‡<30%

Beforeåˆå¹¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16    â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚ Leaf Block 17    â”‚
â”‚ Items: (å¾ˆå°‘)    â”‚  next â”‚ Items: (å¾ˆå°‘)    â”‚
â”‚   [70 â†’ TID]     â”‚       â”‚   [90 â†’ TID]     â”‚
â”‚   [75 â†’ TID]     â”‚       â”‚   [95 â†’ TID]     â”‚
â”‚ Free: 7KB (87%)  â”‚       â”‚ Free: 7KB (87%)  â”‚
â”‚ åˆ©ç”¨ç‡å¤ªä½!      â”‚       â”‚ åˆ©ç”¨ç‡å¤ªä½!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Afteråˆå¹¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Block 16    â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚ Leaf Block 18    â”‚
â”‚ Items: (åˆå¹¶)    â”‚  next â”‚ (17è¢«åˆ é™¤)       â”‚
â”‚   [70 â†’ TID]     â”‚       â”‚                  â”‚
â”‚   [75 â†’ TID]     â”‚       â”‚ (å¯è¢«é‡ç”¨)       â”‚
â”‚   [90 â†’ TID]     â”‚       â”‚                  â”‚
â”‚   [95 â†’ TID]     â”‚       â”‚                  â”‚
â”‚ Free: 6KB (75%)  â”‚       â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ›´æ–°çˆ¶é¡µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parent                          â”‚
â”‚ Before: [16, 17, 18]            â”‚
â”‚ After:  [16, 18]                â”‚â—€â”€ ç§»é™¤17çš„å¼•ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€è§¦å‘æ¡ä»¶ã€‘
âœ“ é¡µåˆ©ç”¨ç‡ < 30% (å¯é…ç½®)
âœ“ VACUUMæ—¶æ£€æŸ¥
âœ“ ç›¸é‚»é¡µéƒ½åˆ©ç”¨ç‡ä½

ã€ä¼˜åŒ–ã€‘
âœ“ Fillfactor: 90% (é¢„ç•™ç©ºé—´ç»™æ›´æ–°)
âœ“ å»¶è¿Ÿåˆå¹¶: é¿å…é¢‘ç¹split/mergeå¾ªç¯
```

---

## ğŸ” å¹¶å‘æ§åˆ¶

### Latchæœºåˆ¶

```
ã€B-treeä½¿ç”¨Latchä¿æŠ¤å¹¶å‘è®¿é—®ã€‘

Latch vs Lock:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Latch          Lock     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¿æŠ¤å¯¹è±¡:   å†…å­˜ç»“æ„      æ•°æ®è¡Œ       â”‚
â”‚ æŒæœ‰æ—¶é—´:   å¾®ç§’çº§        äº‹åŠ¡çº§       â”‚
â”‚ æ­»é”æ£€æµ‹:   ä¸éœ€è¦        éœ€è¦         â”‚
â”‚ ç±»å‹:       å…±äº«/æ’ä»–      å¤šç§        â”‚
â”‚ ä½¿ç”¨åœºæ™¯:   é¡µè®¿é—®        MVCC        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€è¯»å–æ—¶çš„Latchåè®®ã€‘
æŸ¥æ‰¾key=75:

Step 1: Lock Root (Shared)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Root           â”‚ â† S-Latch
â”‚ æ‰¾åˆ°ä¸‹ä¸€é¡µ=5   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ é‡Šæ”¾S-Latchï¼Œè·å–å­é¡µLatch

Step 2: Lock Internal (Shared)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal #5    â”‚ â† S-Latch
â”‚ æ‰¾åˆ°ä¸‹ä¸€é¡µ=16  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ é‡Šæ”¾S-Latchï¼Œè·å–å­é¡µLatch

Step 3: Lock Leaf (Shared)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf #16       â”‚ â† S-Latch
â”‚ è¯»å–key=75     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ è¯»å–å®Œæˆï¼Œé‡Šæ”¾S-Latch

ã€å…³é”®: è‡ªé¡¶å‘ä¸‹ï¼Œé€å±‚é‡Šæ”¾ã€‘
âœ“ ä¸ä¼šæ­»é”ï¼ˆå•å‘åŠ é”ï¼‰
âœ“ å¹¶å‘åº¦é«˜ï¼ˆå¿«é€Ÿé‡Šæ”¾ï¼‰
âœ“ è¯»ä¸é˜»å¡å†™ï¼ˆMVCCï¼‰
```

### æ’å…¥æ—¶çš„Latchåè®®

```
ã€æ’å…¥key=73çš„Latchåè®®ã€‘

Optimisticæ–¹æ³•:
Step 1: S-Latchå‘ä¸‹éå†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Root           â”‚ â† S-Latch (è¯»å–)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ é‡Šæ”¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal       â”‚ â† S-Latch (è¯»å–)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ é‡Šæ”¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf           â”‚ â† S-Latch (è¯»å–)
â”‚ æ£€æŸ¥: æœ‰ç©ºé—´ï¼Ÿ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: å¦‚æœæœ‰ç©ºé—´ï¼Œå‡çº§ä¸ºX-Latch
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf           â”‚ â† X-Latch (å†™å…¥)
â”‚ æ’å…¥key=73     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ å®Œæˆï¼Œé‡Šæ”¾

ã€å¦‚æœé¡µæ»¡ï¼Œéœ€è¦åˆ†è£‚ã€‘
Pessimisticæ–¹æ³•:
é‡æ–°éå†ï¼Œä½†è¿™æ¬¡ä½¿ç”¨X-Latch

Step 1: X-Latchå‘ä¸‹éå†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Root           â”‚ â† X-Latch
â”‚ æ£€æŸ¥: ä¼šåˆ†è£‚ï¼Ÿ  â”‚
â”‚ ä¸ä¼š â†’ å¯ä»¥é‡Šæ”¾â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ å¯ä»¥é‡Šæ”¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal       â”‚ â† X-Latch
â”‚ æ£€æŸ¥: ä¼šåˆ†è£‚ï¼Ÿ  â”‚
â”‚ ä¸ä¼š â†’ å¯ä»¥é‡Šæ”¾â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ å¯ä»¥é‡Šæ”¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf           â”‚ â† X-Latch (ä¿æŒåˆ°æ“ä½œå®Œæˆ)
â”‚ åˆ†è£‚é¡µ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ New Leaf       â”‚ â† X-Latch
â”‚ ç§»åŠ¨items      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Right-LinkæŠ€æœ¯ã€‘
å¦‚æœéœ€è¦æ›´æ–°çˆ¶é¡µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parent         â”‚ â† éœ€è¦X-Latch
â”‚ æ·»åŠ æ–°åˆ†éš”key  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨Right-Linké¿å…å›æº¯:
- åˆ†è£‚é¡µè®¾ç½®right-linkæŒ‡å‘æ–°é¡µ
- è¯»è€…é‡åˆ°right-linkæ—¶è·Ÿéš
- çˆ¶é¡µæ›´æ–°å¯ä»¥å¼‚æ­¥å®Œæˆ
```

---

## ğŸ§¹ VACUUMå¤„ç†

### Dead Tuplesæ¸…ç†

```
ã€VACUUMæ¸…ç†B-treeã€‘

åœºæ™¯: è¡¨DELETEäº†å¾ˆå¤šè¡Œï¼Œç´¢å¼•æœ‰dead tuples

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heap Table                      â”‚
â”‚ Block 100: [Deleted rows]       â”‚
â”‚ Block 101: [Deleted rows]       â”‚
â”‚ ...                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
         â”‚ è¿™äº›è¡Œçš„TIDåœ¨ç´¢å¼•ä¸­
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B-tree Index                    â”‚
â”‚ Leafé¡µåŒ…å«dead tuples:          â”‚
â”‚   [70 â†’ (100, 5)] â† Dead!      â”‚
â”‚   [71 â†’ (101, 3)] â† Dead!      â”‚
â”‚   [72 â†’ (102, 1)] â† Live       â”‚
â”‚   ...                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VACUUMæ­¥éª¤:
Step 1: æ‰«æHeapï¼Œæ”¶é›†dead TIDs
dead_tids = [(100,5), (101,3), ...]

Step 2: æ‰«æIndexï¼Œæ ‡è®°dead items
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éå†æ‰€æœ‰Leafé¡µ                  â”‚
â”‚ å¯¹æ¯ä¸ªitem:                     â”‚
â”‚   if item.tid in dead_tids:     â”‚
â”‚     mark_dead(item)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: æ¸…ç†dead items
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leafé¡µ (Before)                 â”‚
â”‚   [70 â†’ DEAD]                   â”‚
â”‚   [71 â†’ DEAD]                   â”‚
â”‚   [72 â†’ (102, 1)]               â”‚
â”‚   [73 â†’ DEAD]                   â”‚
â”‚   [74 â†’ (103, 5)]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ å‹ç¼©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leafé¡µ (After)                  â”‚
â”‚   [72 â†’ (102, 1)]               â”‚
â”‚   [74 â†’ (103, 5)]               â”‚
â”‚   Free Space: +60 bytes         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€VACUUMä¼˜åŒ–ã€‘
âœ“ æ‰¹é‡å¤„ç†: ä¸€æ¬¡VACUUMå¤„ç†å¤šä¸ªdead tuples
âœ“ ç´¢å¼•æ‰«æ: æŒ‰ç‰©ç†é¡ºåºæ‰«æï¼ˆé¡ºåºI/Oï¼‰
âœ“ é¡µåˆå¹¶: åˆ©ç”¨ç‡è¿‡ä½çš„é¡µä¼šåˆå¹¶
```

### Index Bloat

```
ã€ç´¢å¼•è†¨èƒ€é—®é¢˜ã€‘

åŸå› :
1. é¢‘ç¹INSERT/DELETE
2. é¡µåˆ†è£‚äº§ç”ŸåŠç©ºé¡µ
3. Dead tuplesæœªåŠæ—¶æ¸…ç†

ç¤ºä¾‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¥åº·çš„ç´¢å¼•                      â”‚
â”‚ é¡µåˆ©ç”¨ç‡: 80-90%                â”‚
â”‚ å¤§å°: 100MB                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bloatedç´¢å¼•                     â”‚
â”‚ é¡µåˆ©ç”¨ç‡: 30-40%                â”‚
â”‚ å¤§å°: 250MB (2.5å€!)            â”‚
â”‚ å¾ˆå¤šåŠç©ºé¡µå’Œdead space          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ£€æµ‹Bloatã€‘
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) as size,
    idx_scan,
    pg_size_pretty(
        pg_relation_size(indexrelid) - 
        pg_relation_size(indexrelid) * 
        (SELECT sum(relpages) FROM pg_class WHERE oid = indexrelid) / 
        (SELECT sum(relpages) FROM pg_class WHERE relname = tablename)
    ) as bloat
FROM pg_stat_user_indexes;

ã€è§£å†³Bloatã€‘
-- æ–¹æ³•1: VACUUM (æ¸…ç†dead tuples)
VACUUM table_name;

-- æ–¹æ³•2: REINDEX (é‡å»ºç´¢å¼•)
REINDEX INDEX CONCURRENTLY index_name;  -- ä¸é˜»å¡æŸ¥è¯¢

-- æ–¹æ³•3: CREATE INDEX + DROP OLD (é›¶åœæœº)
CREATE INDEX CONCURRENTLY new_index ON ...;
DROP INDEX CONCURRENTLY old_index;
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### Fillfactor

```
ã€Fillfactor - é¢„ç•™æ›´æ–°ç©ºé—´ã€‘

é»˜è®¤: fillfactor = 90 (Leafé¡µ)
           fillfactor = 70 (Internalé¡µ)

å«ä¹‰: é¡µåªå¡«å……åˆ°90%ï¼Œç•™10%ç»™æ›´æ–°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaf Page (Fillfactor=90)       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Used: 7.2KB (90%)   â”‚         â”‚
â”‚ â”‚ Items: [...]        â”‚         â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚ â”‚ Reserved: 0.8KB     â”‚â—€â”€ é¢„ç•™  â”‚
â”‚ â”‚ (10%)               â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚ Total: 8KB                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ä¼˜åŠ¿ã€‘
âœ“ UPDATEæ—¶: å¯èƒ½ä¸éœ€è¦åˆ†è£‚
âœ“ HOTæ›´æ–°: åœ¨åŒä¸€é¡µæ›´æ–°
âœ“ å‡å°‘ç´¢å¼•ç»´æŠ¤å¼€é”€

ã€é…ç½®ã€‘
-- é¢‘ç¹UPDATEçš„è¡¨
CREATE INDEX ON orders(user_id) 
WITH (fillfactor = 70);  -- é¢„ç•™30%

-- åªINSERTçš„è¡¨ (æ—¥å¿—)
CREATE INDEX ON logs(created_at) 
WITH (fillfactor = 100);  -- æ— éœ€é¢„ç•™

ã€æƒè¡¡ã€‘
fillfactorä½: 
  âœ“ æ›´å°‘åˆ†è£‚
  âœ— ç´¢å¼•æ›´å¤§
  âœ— æ‰«ææ›´æ…¢

fillfactoré«˜:
  âœ“ ç´¢å¼•æ›´å°
  âœ“ æ‰«ææ›´å¿«
  âœ— æ›´å¤šåˆ†è£‚
```

### å¤šåˆ—ç´¢å¼•é¡ºåº

```
ã€å¤šåˆ—ç´¢å¼•çš„åˆ—é¡ºåºå¾ˆé‡è¦ï¼ã€‘

ç¤ºä¾‹: (user_id, status, created_at)

æœ€å·¦å‰ç¼€åŸåˆ™:
CREATE INDEX ON orders(user_id, status, created_at);

å¯ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢:
âœ… WHERE user_id = 1
âœ… WHERE user_id = 1 AND status = 'pending'
âœ… WHERE user_id = 1 AND status = 'pending' AND created_at > '2024-01-01'
âœ… WHERE user_id = 1 ORDER BY status, created_at

ä¸èƒ½ä½¿ç”¨ç´¢å¼•:
âŒ WHERE status = 'pending'  (ä¸æ˜¯æœ€å·¦åˆ—)
âŒ WHERE created_at > '2024-01-01'  (ä¸æ˜¯æœ€å·¦åˆ—)

ã€é€‰æ‹©é¡ºåºåŸåˆ™ã€‘
1. ç­‰å€¼æ¡ä»¶ > èŒƒå›´æ¡ä»¶
   (user_id = ?, created_at > ?)
   â†’ (user_id, created_at) âœ“

2. é€‰æ‹©æ€§é«˜ > é€‰æ‹©æ€§ä½
   user_id (1M values) vs status (3 values)
   â†’ (user_id, status) âœ“

3. å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼
   åˆ†æWHEREå­å¥çš„å¸¸è§ç»„åˆ
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### B-tree vs å…¨è¡¨æ‰«æ

```sql
-- æµ‹è¯•è¡¨: 1000ä¸‡è¡Œ
CREATE TABLE test_table (
    id bigint PRIMARY KEY,
    value text
);

INSERT INTO test_table 
SELECT i, md5(i::text) 
FROM generate_series(1, 10000000) i;

-- æµ‹è¯•1: å•ç‚¹æŸ¥è¯¢
-- æ— ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM test_table WHERE id = 5000000;
/*
Seq Scan on test_table
  (actual time=1234.567..2345.678 rows=1 loops=1)
  Filter: (id = 5000000)
  Rows Removed by Filter: 9999999
  Buffers: shared hit=54321
Planning Time: 0.123 ms
Execution Time: 2345.789 ms  â† 2.3ç§’!
*/

-- æœ‰ç´¢å¼• (PRIMARY KEY)
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM test_table WHERE id = 5000000;
/*
Index Scan using test_table_pkey on test_table
  (actual time=0.025..0.026 rows=1 loops=1)
  Index Cond: (id = 5000000)
  Buffers: shared hit=4
Planning Time: 0.123 ms
Execution Time: 0.045 ms  â† 0.045ms!

æé€Ÿ: 52,000å€!
*/

-- æµ‹è¯•2: èŒƒå›´æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM test_table 
WHERE id BETWEEN 5000000 AND 5001000;

/*
Index Scan using test_table_pkey on test_table
  (actual time=0.034..0.567 rows=1001 loops=1)
  Index Cond: ((id >= 5000000) AND (id <= 5001000))
  Buffers: shared hit=15
Execution Time: 0.678 ms

vs å…¨è¡¨æ‰«æ: ~2500ms
æé€Ÿ: 3,700å€!
*/
```

---

## æ€»ç»“

### B-treeæ ¸å¿ƒè¦ç‚¹

1. **ç»“æ„ç‰¹ç‚¹**
   - âœ… è‡ªå¹³è¡¡: æ‰€æœ‰å¶å­åŒå±‚
   - âœ… æœ‰åº: æ”¯æŒèŒƒå›´æ‰«æ
   - âœ… é«˜æ•ˆ: O(log N)æ“ä½œ
   - âœ… é€šç”¨: é€‚ç”¨90%åœºæ™¯

2. **å…³é”®æ“ä½œ**
   - **æŸ¥æ‰¾**: O(log N)æ ‘éå†
   - **æ’å…¥**: å¯èƒ½è§¦å‘åˆ†è£‚
   - **åˆ é™¤**: æ ‡è®°dead + VACUUM
   - **åˆ†è£‚**: ä¿æŒå¹³è¡¡

3. **å¹¶å‘æ§åˆ¶**
   - Latchä¿æŠ¤é¡µè®¿é—®
   - è‡ªé¡¶å‘ä¸‹åŠ é”
   - Right-Linkä¼˜åŒ–

4. **æ€§èƒ½ä¼˜åŒ–**
   - Fillfactoré¢„ç•™ç©ºé—´
   - å¤šåˆ—ç´¢å¼•é¡ºåº
   - å®šæœŸVACUUM
   - ç›‘æ§Bloat

---

**æ–‡æ¡£ç‰ˆæœ¬**: PostgreSQL 17.6  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**é‡è¦ç¨‹åº¦**: â­â­â­â­â­  
**ä¸‹ä¸€ç¯‡**: Hashç´¢å¼•æ·±åº¦åˆ†æ

