# GINç´¢å¼•æ·±åº¦åˆ†æ - å€’æ’ç´¢å¼•

> PostgreSQLçš„å€’æ’ç´¢å¼• - æ•°ç»„ã€JSONBã€å…¨æ–‡æœç´¢çš„åˆ©å™¨

**é‡è¦ç¨‹åº¦**: â­â­â­â­â­  
**æºç ä½ç½®**: `src/backend/access/gin/`  
**ä½¿ç”¨åœºæ™¯**: æ•°ç»„ã€JSONBã€å…¨æ–‡æœç´¢ã€å¤šå€¼åˆ—

---

## ğŸ“‹ GINç´¢å¼•æ€»è§ˆ

### ä»€ä¹ˆæ˜¯GINï¼Ÿ

```
GIN = Generalized Inverted Index (é€šç”¨å€’æ’ç´¢å¼•)

ã€å€’æ’ç´¢å¼•æ¦‚å¿µã€‘
æ­£æ’ç´¢å¼• (B-tree):
  Document ID â†’ Content
  1 â†’ "PostgreSQL database"
  2 â†’ "PostgreSQL index"
  3 â†’ "Database index"

å€’æ’ç´¢å¼• (GIN):
  Word â†’ Document IDs
  "PostgreSQL" â†’ [1, 2]
  "database"   â†’ [1, 3]
  "index"      â†’ [2, 3]

ã€æ ¸å¿ƒæ€æƒ³ã€‘
âœ“ å°†å¤åˆå€¼åˆ†è§£ä¸ºå…ƒç´ 
âœ“ ä¸ºæ¯ä¸ªå…ƒç´ å»ºç«‹ å…ƒç´ â†’æ–‡æ¡£ çš„æ˜ å°„
âœ“ æŸ¥è¯¢æ—¶å¿«é€Ÿå®šä½åŒ…å«å…ƒç´ çš„æ–‡æ¡£
```

### GIN vs B-tree

```
ã€å¯¹æ¯”ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          B-tree         GIN                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç´¢å¼•:    å•å€¼åˆ—         å¤šå€¼åˆ—                   â”‚
â”‚ æŸ¥æ‰¾:    ç²¾ç¡®å€¼         åŒ…å«å…³ç³»                 â”‚
â”‚ ç¤ºä¾‹:    id=1           tags @> ARRAY['pg']     â”‚
â”‚ æ’å…¥:    å¿«             æ…¢                       â”‚
â”‚ æŸ¥è¯¢:    å¿«             å¿«                       â”‚
â”‚ å¤§å°:    å°             å¤§                       â”‚
â”‚ æ›´æ–°:    å¿«             æ…¢                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€é€‚ç”¨åœºæ™¯ã€‘
B-tree:
  SELECT * FROM users WHERE id = 1
  SELECT * FROM orders WHERE created_at > '2024-01-01'

GIN:
  SELECT * FROM posts WHERE tags @> ARRAY['postgresql']
  SELECT * FROM docs WHERE data @> '{"type":"article"}'
  SELECT * FROM articles WHERE to_tsvector(content) @@ 'database'
```

---

## ğŸ—ï¸ GINç´¢å¼•ç»“æ„

### æ•´ä½“æ¶æ„

```
ã€GINç´¢å¼•ä¸‰å±‚ç»“æ„ã€‘

1. Entry Tree (B-treeç»“æ„)
   â”œâ”€ å­˜å‚¨æ‰€æœ‰å”¯ä¸€çš„å…ƒç´ ï¼ˆkeysï¼‰
   â”œâ”€ ä½¿ç”¨B-treeç»„ç»‡
   â””â”€ æ¯ä¸ªentryæŒ‡å‘Posting Tree/List

2. Posting Tree (å¤§é‡æ–‡æ¡£æ—¶)
   â”œâ”€ B-treeå­˜å‚¨TIDåˆ—è¡¨
   â”œâ”€ å½“TIDæ•°é‡å¾ˆå¤§æ—¶ä½¿ç”¨
   â””â”€ æ”¯æŒé«˜æ•ˆèŒƒå›´æ‰«æ

3. Posting List (å°‘é‡æ–‡æ¡£æ—¶)
   â”œâ”€ ç®€å•çš„å‹ç¼©TIDæ•°ç»„
   â”œâ”€ å½“TIDæ•°é‡è¾ƒå°‘æ—¶ä½¿ç”¨
   â””â”€ æ›´èŠ‚çœç©ºé—´

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Entry Tree (B-tree)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Root                                 â”‚       â”‚
â”‚  â”‚  [key range]                         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚          â”‚                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ "database"  â”‚ "postgresql" â”‚               â”‚
â”‚    â”‚ â†“         â”‚ â†“             â”‚               â”‚
â”‚    â”‚ Posting   â”‚ Posting       â”‚               â”‚
â”‚    â”‚ List      â”‚ Tree          â”‚               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç¤ºä¾‹ã€‘
è¡¨æ•°æ®:
  id | tags
  â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1  | {postgresql, database, index}
  2  | {postgresql, sql}
  3  | {database, mysql}
  4  | {postgresql, index, performance}

GINç´¢å¼•:
  Entry Tree:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ "database"    â†’ Posting: [1, 3]    â”‚
  â”‚ "index"       â†’ Posting: [1, 4]    â”‚
  â”‚ "mysql"       â†’ Posting: [3]       â”‚
  â”‚ "performance" â†’ Posting: [4]       â”‚
  â”‚ "postgresql"  â†’ Posting: [1, 2, 4] â”‚
  â”‚ "sql"         â†’ Posting: [2]       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢: WHERE tags @> ARRAY['postgresql', 'index']
  æ­¥éª¤1: æŸ¥æ‰¾"postgresql" â†’ [1, 2, 4]
  æ­¥éª¤2: æŸ¥æ‰¾"index"      â†’ [1, 4]
  æ­¥éª¤3: äº¤é›†            â†’ [1, 4]
  ç»“æœ: è¿”å›tuple 1å’Œ4
```

### Entry Treeè¯¦è§£

```
ã€Entry Tree - å­˜å‚¨æ‰€æœ‰å”¯ä¸€å…ƒç´ ã€‘

ç»“æ„: æ ‡å‡†B-tree
å†…å®¹: æ¯ä¸ªentry = (key, posting_pointer)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Entry Tree Page                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ Entry 1: ["database", ptrâ†’posting]      â”‚     â”‚
â”‚ â”‚ Entry 2: ["index", ptrâ†’posting]         â”‚     â”‚
â”‚ â”‚ Entry 3: ["mysql", ptrâ†’posting]         â”‚     â”‚
â”‚ â”‚ Entry 4: ["performance", ptrâ†’posting]   â”‚     â”‚
â”‚ â”‚ Entry 5: ["postgresql", ptrâ†’posting]    â”‚     â”‚
â”‚ â”‚ Entry 6: ["sql", ptrâ†’posting]           â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Entryæ ¼å¼ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IndexTuple           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Key (variable)   â”‚ â”‚ â† å…ƒç´ å€¼ï¼ˆå¦‚"postgresql"ï¼‰
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Posting Pointer  â”‚ â”‚ â† æŒ‡å‘Posting Tree/List
â”‚ â”‚ (BlockNumber +   â”‚ â”‚
â”‚ â”‚  Offset)         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Posting List vs Posting Tree

```
ã€Posting List - å°‘é‡TIDæ—¶ã€‘
å½“TIDæ•°é‡ < gin_pending_list_limitæ—¶ä½¿ç”¨

æ ¼å¼: å‹ç¼©çš„TIDæ•°ç»„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Posting List                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ nposting: 3                  â”‚ â”‚
â”‚ â”‚ TIDs: [                      â”‚ â”‚
â”‚ â”‚   (100, 5),  â† Block 100, Offset 5
â”‚ â”‚   (100, 8),  â† åŒä¸€blockï¼Œå‹ç¼©å­˜å‚¨
â”‚ â”‚   (105, 2)   â† Block 105     â”‚ â”‚
â”‚ â”‚ ]                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‹ç¼©æŠ€æœ¯:
  â€¢ Deltaç¼–ç : å­˜å‚¨å·®å€¼è€Œéç»å¯¹å€¼
  â€¢ å˜é•¿ç¼–ç : å°æ•°å­—ç”¨æ›´å°‘å­—èŠ‚
  
  ç¤ºä¾‹: TIDs [100, 101, 102, 105, 106]
  åŸå§‹: 5 Ã— 6å­—èŠ‚ = 30å­—èŠ‚
  å‹ç¼©: 100 (6B) + [1,1,3,1] (4Ã—1B) = 10å­—èŠ‚
  èŠ‚çœ: 67%!

ã€Posting Tree - å¤§é‡TIDæ—¶ã€‘
å½“TIDæ•°é‡å¾ˆå¤§æ—¶ï¼ˆæ•°åƒæˆ–æ›´å¤šï¼‰

ç»“æ„: å®Œæ•´çš„B-tree
ä¼˜åŠ¿: æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€é«˜æ•ˆmerge

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Posting Tree                            â”‚
â”‚                                         â”‚
â”‚           Root                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚      â”‚ [500]    â”‚                       â”‚
â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                       â”‚
â”‚      â”‚          â”‚                       â”‚
â”‚   Internal   Internal                   â”‚
â”‚   [1-499]    [500-999]                  â”‚
â”‚      â”‚          â”‚                       â”‚
â”‚   â”Œâ”€â”€â”´â”€â”€â”    â”Œâ”€â”€â”´â”€â”€â”                   â”‚
â”‚  Leaf  Leaf  Leaf  Leaf                 â”‚
â”‚  [TIDs] [TIDs] [TIDs] [TIDs]            â”‚
â”‚                                         â”‚
â”‚ æ¯ä¸ªLeafå­˜å‚¨å‹ç¼©çš„TIDæ®µ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æŸ¥è¯¢æ“ä½œ

### æ•°ç»„åŒ…å«æŸ¥è¯¢

```sql
-- æŸ¥è¯¢: åŒ…å«ç‰¹å®šæ ‡ç­¾çš„æ–‡ç« 
SELECT * FROM posts 
WHERE tags @> ARRAY['postgresql', 'performance'];
```

```
ã€GINæŸ¥è¯¢æµç¨‹ã€‘

Step 1: æå–æŸ¥è¯¢å…ƒç´ 
  è¦æŸ¥æ‰¾: ['postgresql', 'performance']

Step 2: åœ¨Entry Treeä¸­æŸ¥æ‰¾æ¯ä¸ªå…ƒç´ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Entry TreeæŸ¥æ‰¾                      â”‚
â”‚                                     â”‚
â”‚ æŸ¥æ‰¾ "postgresql":                  â”‚
â”‚   Entry Tree â†’ "postgresql"         â”‚
â”‚   â†’ Posting: [1, 2, 4, 7, 10, ...]  â”‚
â”‚                                     â”‚
â”‚ æŸ¥æ‰¾ "performance":                 â”‚
â”‚   Entry Tree â†’ "performance"        â”‚
â”‚   â†’ Posting: [4, 7, 15, 23, ...]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: è®¡ç®—äº¤é›†ï¼ˆANDè¯­ä¹‰ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bitmap Intersection                 â”‚
â”‚                                     â”‚
â”‚ "postgresql"   â†’ [1, 2, 4, 7, 10]   â”‚
â”‚ "performance"  â†’ [4, 7, 15, 23]     â”‚
â”‚                     â†“ äº¤é›†          â”‚
â”‚ Result         â†’ [4, 7]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: è®¿é—®Heapè·å–tuples
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Heap Access                         â”‚
â”‚                                     â”‚
â”‚ TID (4) â†’ Tuple 4: {postgresql, performance, ...}
â”‚ TID (7) â†’ Tuple 7: {postgresql, performance, ...}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ€§èƒ½åˆ†æã€‘
Entry TreeæŸ¥æ‰¾: O(log N) Ã— M (Mä¸ªå…ƒç´ )
Bitmapæ“ä½œ: O(K) (Kä¸ªTID)
Heapè®¿é—®: O(K)

æ€»è®¡: O(M Ã— log N + K)
é€šå¸¸K << è¡¨æ€»è¡Œæ•°ï¼Œæ‰€ä»¥å¾ˆå¿«!
```

### JSONBæŸ¥è¯¢

```sql
-- æŸ¥è¯¢: JSONBåŒ…å«ç‰¹å®šé”®å€¼
SELECT * FROM documents 
WHERE data @> '{"type": "article", "status": "published"}';
```

```
ã€JSONBç´¢å¼•ç»“æ„ã€‘

JSONBæ•°æ®:
  id | data
  â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1  | {"type":"article","status":"published","tags":["tech"]}
  2  | {"type":"article","status":"draft"}
  3  | {"type":"page","status":"published"}

GINç´¢å¼•åˆ†è§£:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Entry Tree (jsonb_ops)                 â”‚
  â”‚                                        â”‚
  â”‚ é”®å€¼å¯¹åˆ†è§£:                            â”‚
  â”‚ "type:article"       â†’ [1, 2]          â”‚
  â”‚ "type:page"          â†’ [3]             â”‚
  â”‚ "status:published"   â†’ [1, 3]          â”‚
  â”‚ "status:draft"       â†’ [2]             â”‚
  â”‚ "tags:[\"tech\"]"    â†’ [1]             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢: data @> '{"type":"article","status":"published"}'
  æ­¥éª¤1: æŸ¥æ‰¾"type:article"    â†’ [1, 2]
  æ­¥éª¤2: æŸ¥æ‰¾"status:published"â†’ [1, 3]
  æ­¥éª¤3: äº¤é›†                  â†’ [1]
  ç»“æœ: è¿”å›document 1

ã€jsonb_ops vs jsonb_path_opsã€‘

jsonb_ops (é»˜è®¤):
  â€¢ ç´¢å¼•æ‰€æœ‰é”®å’Œå€¼
  â€¢ æ”¯æŒæ‰€æœ‰JSONBæ“ä½œç¬¦
  â€¢ ç´¢å¼•æ›´å¤§
  
jsonb_path_ops:
  â€¢ åªç´¢å¼•è·¯å¾„â†’å€¼
  â€¢ åªæ”¯æŒ @> æ“ä½œç¬¦
  â€¢ ç´¢å¼•æ›´å°ï¼ˆçº¦30%ï¼‰
  â€¢ æŸ¥è¯¢é€šå¸¸æ›´å¿«

æ¨è: å¤§å¤šæ•°æƒ…å†µä½¿ç”¨jsonb_path_ops
```

### å…¨æ–‡æœç´¢

```sql
-- å…¨æ–‡æœç´¢æŸ¥è¯¢
SELECT * FROM articles 
WHERE to_tsvector('english', content) @@ to_tsquery('postgresql & database');
```

```
ã€å…¨æ–‡æœç´¢ç´¢å¼•ã€‘

æ–‡ç« å†…å®¹:
  id | content
  â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1  | "PostgreSQL is a powerful database"
  2  | "PostgreSQL supports GIN indexes"
  3  | "MySQL is also a database system"

åˆ†è¯å’Œç´¢å¼•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ to_tsvector('english', content)        â”‚
â”‚                                        â”‚
â”‚ Article 1:                             â”‚
â”‚   "postgresql" (æƒé‡ A)                â”‚
â”‚   "powerful"                           â”‚
â”‚   "database"                           â”‚
â”‚                                        â”‚
â”‚ Article 2:                             â”‚
â”‚   "postgresql"                         â”‚
â”‚   "support"                            â”‚
â”‚   "gin"                                â”‚
â”‚   "index"                              â”‚
â”‚                                        â”‚
â”‚ Article 3:                             â”‚
â”‚   "mysql"                              â”‚
â”‚   "database"                           â”‚
â”‚   "system"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GINç´¢å¼•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Entry Tree                             â”‚
â”‚                                        â”‚
â”‚ "database"    â†’ [1, 3]                 â”‚
â”‚ "gin"         â†’ [2]                    â”‚
â”‚ "index"       â†’ [2]                    â”‚
â”‚ "mysql"       â†’ [3]                    â”‚
â”‚ "postgresql"  â†’ [1, 2]                 â”‚
â”‚ "powerful"    â†’ [1]                    â”‚
â”‚ "support"     â†’ [2]                    â”‚
â”‚ "system"      â†’ [3]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢: to_tsquery('postgresql & database')
  æ­¥éª¤1: æŸ¥æ‰¾"postgresql" â†’ [1, 2]
  æ­¥éª¤2: æŸ¥æ‰¾"database"   â†’ [1, 3]
  æ­¥éª¤3: äº¤é›† (&)         â†’ [1]
  ç»“æœ: Article 1

ã€æƒé‡å’Œæ’åºã€‘
tsvectorå¯ä»¥åŒ…å«ä½ç½®å’Œæƒé‡:
  'postgresql':1A,5B 'database':3

å¯ä»¥ç”¨äº:
  â€¢ ç›¸å…³æ€§æ’åº (ts_rank)
  â€¢ çŸ­è¯­æŸ¥è¯¢ (è¯è·ç¦»)
  â€¢ æƒé‡è¿‡æ»¤
```

---

## â• æ’å…¥æ“ä½œ

### åŸºæœ¬æ’å…¥

```
ã€æ’å…¥æ–°è¡Œåˆ°GINç´¢å¼•ã€‘

æ’å…¥: INSERT INTO posts VALUES (5, ARRAY['postgresql', 'gin', 'index']);

Step 1: åˆ†è§£æ•°ç»„å…ƒç´ 
  Elements: ['postgresql', 'gin', 'index']

Step 2: å¯¹æ¯ä¸ªå…ƒç´ æ›´æ–°Entry Tree
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Entry Treeæ›´æ–°                      â”‚
â”‚                                     â”‚
â”‚ "postgresql":                       â”‚
â”‚   Before: Posting [1, 2, 4]         â”‚
â”‚   After:  Posting [1, 2, 4, 5]      â”‚â—€â”€ æ·»åŠ 5
â”‚                                     â”‚
â”‚ "gin":                              â”‚
â”‚   Before: Posting [6, 8]            â”‚
â”‚   After:  Posting [5, 6, 8]         â”‚â—€â”€ æ·»åŠ 5(æ’åº)
â”‚                                     â”‚
â”‚ "index":                            â”‚
â”‚   Before: Posting [1, 4]            â”‚
â”‚   After:  Posting [1, 4, 5]         â”‚â—€â”€ æ·»åŠ 5
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æˆæœ¬åˆ†æã€‘
å¯¹äºNä¸ªå…ƒç´ çš„æ•°ç»„:
  â€¢ Entry TreeæŸ¥æ‰¾: O(N Ã— log M) (M=å”¯ä¸€å…ƒç´ æ•°)
  â€¢ Postingæ›´æ–°: O(N Ã— K) (K=æ¯ä¸ªå…ƒç´ çš„æ–‡æ¡£æ•°)
  
ç¤ºä¾‹: 10ä¸ªæ ‡ç­¾çš„æ–‡ç« 
  æ¯ä¸ªæ ‡ç­¾å¹³å‡100ç¯‡æ–‡ç« 
  æˆæœ¬: 10 Ã— log(10000) + 10 Ã— 100 = çº¦1000æ“ä½œ

vs B-treeæ’å…¥:
  B-tree: O(log M) â‰ˆ 13æ“ä½œ
  GIN: ~1000æ“ä½œ

ç»“è®º: GINæ’å…¥æ¯”B-treeæ…¢å¾ˆå¤š!
```

### Fast Updateæœºåˆ¶

```
ã€Fast Update - ä¼˜åŒ–æ’å…¥æ€§èƒ½ã€‘

é—®é¢˜: ç›´æ¥æ›´æ–°Entry Treeå’ŒPostingå¾ˆæ…¢

è§£å†³: Pending List (å¾…å¤„ç†åˆ—è¡¨)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GIN Index with Fast Update              â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Entry Tree    â”‚   â”‚ Pending List â”‚ â”‚
â”‚  â”‚  (ä¸»ç´¢å¼•)      â”‚   â”‚ (ç¼“å†²åŒº)     â”‚ â”‚
â”‚  â”‚                â”‚   â”‚              â”‚ â”‚
â”‚  â”‚ Stable entries â”‚   â”‚ New entries  â”‚ â”‚
â”‚  â”‚                â”‚   â”‚ (unsorted)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†‘                     â†“         â”‚
â”‚         â”‚                     â”‚         â”‚
â”‚         â””â”€â”€â”€â”€ VACUUM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚              æˆ–è¾¾åˆ°é™åˆ¶ååˆå¹¶            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ’å…¥æµç¨‹:
Step 1: æ–°æ’å…¥å…ˆå†™å…¥Pending List
  â€¢ éå¸¸å¿«ï¼ˆappend-onlyï¼‰
  â€¢ ä¸éœ€è¦B-treeæ“ä½œ
  â€¢ ä¸éœ€è¦æ›´æ–°Posting

Step 2: æŸ¥è¯¢æ—¶åˆå¹¶
  â€¢ æœç´¢Entry Tree
  â€¢ åŒæ—¶æœç´¢Pending List
  â€¢ åˆå¹¶ç»“æœ

Step 3: å®šæœŸæ¸…ç†Pending List
  è§¦å‘æ¡ä»¶:
  â€¢ Pending Listå¤§å° > gin_pending_list_limit (é»˜è®¤4MB)
  â€¢ VACUUMè¿è¡Œ
  â€¢ æ‰‹åŠ¨è§¦å‘: gin_clean_pending_list()

ã€é…ç½®å‚æ•°ã€‘
-- è°ƒæ•´Pending Listå¤§å°
ALTER INDEX idx_tags SET (fastupdate = on);
ALTER INDEX idx_tags SET (gin_pending_list_limit = 8192);  -- 8MB

-- æŸ¥çœ‹Pending Listå¤§å°
SELECT pg_size_pretty(
    pg_relation_size('idx_tags', 'init')
);

ã€æƒè¡¡ã€‘
Fast Update ON:
  âœ“ æ’å…¥å¿«
  âœ— æŸ¥è¯¢ç•¥æ…¢ (éœ€è¦åˆå¹¶Pending List)
  âœ— ç´¢å¼•ç•¥å¤§

Fast Update OFF:
  âœ— æ’å…¥æ…¢
  âœ“ æŸ¥è¯¢å¿«
  âœ“ ç´¢å¼•å°

æ¨è: å†™å¤šè¯»å°‘æ—¶å¼€å¯Fast Update
```

---

## æ€§èƒ½ä¼˜åŒ–

### å‚æ•°è°ƒä¼˜

```sql
-- 1. gin_pending_list_limit
-- æ§åˆ¶Pending Listæœ€å¤§å¤§å°
ALTER INDEX idx_tags SET (gin_pending_list_limit = 8192);  -- 8MB

-- å°å€¼: æ›´é¢‘ç¹åˆå¹¶ï¼ŒæŸ¥è¯¢å¿«ï¼Œæ’å…¥æ…¢
-- å¤§å€¼: è¾ƒå°‘åˆå¹¶ï¼Œæ’å…¥å¿«ï¼ŒæŸ¥è¯¢ç•¥æ…¢
-- æ¨è: 4-16MB

-- 2. fastupdate
-- æ˜¯å¦ä½¿ç”¨Fast Update
ALTER INDEX idx_tags SET (fastupdate = on);

-- on:  æ’å…¥å¿«ï¼ŒæŸ¥è¯¢ç•¥æ…¢
-- off: æ’å…¥æ…¢ï¼ŒæŸ¥è¯¢å¿«
-- æ¨è: å¤§å¤šæ•°æƒ…å†µå¼€å¯

-- 3. å®šæœŸæ¸…ç†Pending List
SELECT gin_clean_pending_list('idx_tags');

-- æˆ–é€šè¿‡VACUUM
VACUUM table_name;

-- 4. ä½¿ç”¨jsonb_path_ops (JSONB)
CREATE INDEX ON documents USING gin(data jsonb_path_ops);
-- æ¯”jsonb_opså°30%ï¼ŒæŸ¥è¯¢å¿«20-30%
-- ä½†åªæ”¯æŒ @> æ“ä½œç¬¦
```

### ç´¢å¼•å¤§å°ä¼˜åŒ–

```
ã€GINç´¢å¼•é€šå¸¸å¾ˆå¤§ã€‘

ç¤ºä¾‹: 100ä¸‡è¡Œè¡¨ï¼Œæ¯è¡Œ10ä¸ªæ ‡ç­¾
B-treeå¤§å°: ~50MB
GINå¤§å°:   ~500MB (10å€!)

åŸå› :
1. Entry Tree: æ¯ä¸ªå”¯ä¸€å…ƒç´ ä¸€ä¸ªentry
2. Posting: æ¯ä¸ªå…ƒç´ â†’æ–‡æ¡£çš„æ˜ å°„
3. ä¸åƒB-treeåªæœ‰ä¸€ä¸ªå€¼â†’æ–‡æ¡£

ä¼˜åŒ–ç­–ç•¥:
1. ä½¿ç”¨jsonb_path_ops
   CREATE INDEX ON docs USING gin(data jsonb_path_ops);
   èŠ‚çœ: ~30%

2. éƒ¨åˆ†ç´¢å¼•
   CREATE INDEX ON posts USING gin(tags)
   WHERE status = 'published';
   åªç´¢å¼•å‘å¸ƒçš„æ–‡ç« ï¼Œå‡å°ç´¢å¼•

3. å®šæœŸREINDEX
   REINDEX INDEX CONCURRENTLY idx_tags;
   æ¸…ç†bloat

4. å‹ç¼©å­˜å‚¨
   -- GINè‡ªåŠ¨ä½¿ç”¨å‹ç¼©TID
   -- æ— éœ€é¢å¤–é…ç½®
```

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- 1. ä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX ON posts USING gin(tags) INCLUDE (title, created_at);
-- å¯èƒ½æ”¯æŒIndex-Only Scan

-- 2. é¿å…ORæŸ¥è¯¢ï¼ˆæ”¹ç”¨UNIONï¼‰
-- æ…¢:
SELECT * FROM posts 
WHERE tags @> ARRAY['postgresql'] 
   OR tags @> ARRAY['database'];

-- å¿«:
SELECT * FROM posts WHERE tags @> ARRAY['postgresql']
UNION
SELECT * FROM posts WHERE tags @> ARRAY['database'];

-- 3. ä½¿ç”¨æ•°ç»„overlapä»£æ›¿å¤šä¸ªOR
-- æ…¢:
WHERE tags @> ARRAY['a'] OR tags @> ARRAY['b'] OR tags @> ARRAY['c']

-- å¿«:
WHERE tags && ARRAY['a','b','c']  -- overlapæ“ä½œç¬¦

-- 4. å…¨æ–‡æœç´¢ä½¿ç”¨çŸ­è¯­å‡å°‘ç»“æœ
-- æ…¢: 'database | system'  (å¾ˆå¤šç»“æœ)
-- å¿«: 'database & system'  (æ›´ç²¾ç¡®)
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: æ ‡ç­¾æœç´¢ä¼˜åŒ–

```sql
-- åœºæ™¯: æ–‡ç« æ ‡ç­¾æœç´¢
CREATE TABLE posts (
    id bigint PRIMARY KEY,
    title text,
    tags text[],
    created_at timestamp
);

-- æ’å…¥100ä¸‡ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡5-10ä¸ªæ ‡ç­¾
INSERT INTO posts 
SELECT i, 
       'Post ' || i,
       ARRAY(SELECT 'tag_' || (random() * 1000)::int 
             FROM generate_series(1, 5 + (random() * 5)::int)),
       now() - (random() * interval '365 days')
FROM generate_series(1, 1000000) i;

-- æµ‹è¯•1: æ— ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM posts 
WHERE tags @> ARRAY['tag_42'];

/*
Seq Scan on posts
  Filter: (tags @> '{tag_42}')
  Rows Removed by Filter: 999500
  Buffers: shared hit=54321
Execution Time: 2345.678 ms  â† 2.3ç§’!
*/

-- åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_tags ON posts USING gin(tags);

-- æµ‹è¯•2: æœ‰GINç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM posts 
WHERE tags @> ARRAY['tag_42'];

/*
Bitmap Heap Scan on posts
  Recheck Cond: (tags @> '{tag_42}')
  ->  Bitmap Index Scan on idx_tags
        Index Cond: (tags @> '{tag_42}')
  Buffers: shared hit=25
Execution Time: 15.234 ms  â† 15ms!

æé€Ÿ: 154å€!
*/
```

### æ¡ˆä¾‹2: JSONBæ–‡æ¡£æœç´¢

```sql
-- åœºæ™¯: æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ
CREATE TABLE documents (
    id bigint PRIMARY KEY,
    data jsonb
);

-- æ’å…¥50ä¸‡æ–‡æ¡£
INSERT INTO documents
SELECT i, jsonb_build_object(
    'type', CASE (random() * 3)::int
            WHEN 0 THEN 'article'
            WHEN 1 THEN 'page'
            ELSE 'post'
            END,
    'status', CASE (random() * 2)::int
              WHEN 0 THEN 'published'
              ELSE 'draft'
              END,
    'tags', (SELECT jsonb_agg('tag_' || t)
             FROM generate_series(1, 3 + (random() * 3)::int) t),
    'author_id', (random() * 1000)::int
)
FROM generate_series(1, 500000) i;

-- åˆ›å»ºjsonb_path_opsç´¢å¼•ï¼ˆæ›´å°æ›´å¿«ï¼‰
CREATE INDEX idx_data ON documents 
USING gin(data jsonb_path_ops);

-- æŸ¥è¯¢: æŸ¥æ‰¾ç‰¹å®šç±»å‹çš„å·²å‘å¸ƒæ–‡æ¡£
EXPLAIN (ANALYZE)
SELECT * FROM documents
WHERE data @> '{"type":"article","status":"published"}';

/*
Bitmap Heap Scan on documents
  Recheck Cond: (data @> '{"type": "article", "status": "published"}')
  ->  Bitmap Index Scan on idx_data
        Index Cond: (data @> '{"type": "article", "status": "published"}')
Execution Time: 8.456 ms

vs æ— ç´¢å¼•: ~1500ms
æé€Ÿ: 177å€!

ç´¢å¼•å¤§å°å¯¹æ¯”:
  jsonb_ops:      156 MB
  jsonb_path_ops: 108 MB (èŠ‚çœ31%)
*/
```

---

## æ€»ç»“

### GINç´¢å¼•æ ¸å¿ƒè¦ç‚¹

1. **é€‚ç”¨åœºæ™¯**
   - âœ… æ•°ç»„åˆ—ï¼ˆtags, categoriesï¼‰
   - âœ… JSONBåˆ—ï¼ˆæ–‡æ¡£å­˜å‚¨ï¼‰
   - âœ… å…¨æ–‡æœç´¢ï¼ˆtsvectorï¼‰
   - âœ… å¤šå€¼åˆ—æŸ¥è¯¢
   - âŒ ç®€å•ç­‰å€¼æŸ¥è¯¢ï¼ˆç”¨B-treeï¼‰
   - âŒ èŒƒå›´æŸ¥è¯¢ï¼ˆç”¨B-treeï¼‰

2. **æ€§èƒ½ç‰¹ç‚¹**
   - âœ… æŸ¥è¯¢å¿«ï¼ˆO(M Ã— log N + K)ï¼‰
   - âœ… å¤æ‚æŸ¥è¯¢æ”¯æŒï¼ˆAND, ORï¼‰
   - âŒ æ’å…¥æ…¢ï¼ˆéœ€æ›´æ–°å¤šä¸ªentryï¼‰
   - âŒ ç´¢å¼•å¤§ï¼ˆæ¯”B-treeå¤§5-10å€ï¼‰

3. **ä¼˜åŒ–å»ºè®®**
   - âœ… ä½¿ç”¨Fast Update
   - âœ… è°ƒæ•´gin_pending_list_limit
   - âœ… JSONBç”¨jsonb_path_ops
   - âœ… å®šæœŸVACUUMæ¸…ç†Pending List
   - âœ… å®šæœŸREINDEXæ¸…ç†bloat

4. **æœ€ä½³å®è·µ**
   - è¯»å¤šå†™å°‘: å…³é—­Fast Update
   - å†™å¤šè¯»å°‘: å¼€å¯Fast Update
   - JSONB: ä¼˜å…ˆjsonb_path_ops
   - å…¨æ–‡æœç´¢: åˆ›å»ºå•ç‹¬çš„tsvectoråˆ—
   - ç›‘æ§: æ£€æŸ¥Pending Listå¤§å°

---

**æ–‡æ¡£ç‰ˆæœ¬**: PostgreSQL 17.6  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**é‡è¦ç¨‹åº¦**: â­â­â­â­â­  
**ä¸‹ä¸€ç¯‡**: BRINç´¢å¼•æ·±åº¦åˆ†æ

