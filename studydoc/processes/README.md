# PostgreSQL è¿›ç¨‹æ¶æ„åˆ†æ

> PostgreSQL æ ¸å¿ƒè¿›ç¨‹çš„æ·±åº¦æºç åˆ†æ

**æ¨¡å—çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-16  
**åŸºäºç‰ˆæœ¬**: PostgreSQL 17.6

---

## ğŸ“š æ¨¡å—å¯¼èˆª

| æ–‡æ¡£ | è¿›ç¨‹ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|---------|
| [01_overview.md](01_overview.md) | å…¨å±€æ¶æ„ | æ‰€æœ‰è¿›ç¨‹æ€»è§ˆã€è¿›ç¨‹é—´å…³ç³» |
| [02_postmaster.md](02_postmaster.md) | Postmaster | ä¸»è¿›ç¨‹ã€å¯åŠ¨ã€forkã€ä¿¡å·å¤„ç† |
| [03_backend.md](03_backend.md) | Backend | æŸ¥è¯¢æ‰§è¡Œã€ä¼šè¯ç®¡ç† |
| [04_bgwriter.md](04_bgwriter.md) | BGWriter | åå°å†™å…¥ã€è„é¡µåˆ·æ–° |
| [05_checkpointer.md](05_checkpointer.md) | Checkpointer | æ£€æŸ¥ç‚¹æ‰§è¡Œ |
| [06_walwriter.md](06_walwriter.md) | WAL Writer | WALç¼“å†²åŒºåˆ·ç›˜ |
| [07_autovacuum.md](07_autovacuum.md) | Autovacuum | è‡ªåŠ¨æ¸…ç†æ­»å…ƒç»„ |
| [08_auxiliary.md](08_auxiliary.md) | è¾…åŠ©è¿›ç¨‹ | Statsã€Loggerç­‰ |

---

## ğŸ¯ PostgreSQL è¿›ç¨‹æ¶æ„æ€»è§ˆ

```
                    Operating System
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 Postmaster (ä¸»è¿›ç¨‹)                     â”‚ â”‚
â”‚  â”‚  pid: 1234                                             â”‚ â”‚
â”‚  â”‚  â€¢ ç›‘å¬ç«¯å£ 5432                                        â”‚ â”‚
â”‚  â”‚  â€¢ fork æ‰€æœ‰å­è¿›ç¨‹                                      â”‚ â”‚
â”‚  â”‚  â€¢ å¤„ç†ä¿¡å·å’Œå´©æºƒæ¢å¤                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚ fork()                                          â”‚
â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚            â”‚              â”‚              â”‚             â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Backend    â”‚  â”‚  Backend    â”‚ â”‚  Backend  â”‚ â”‚Backend â”‚â”‚
â”‚  â”‚   Process    â”‚  â”‚  Process    â”‚ â”‚  Process  â”‚ â”‚Process â”‚â”‚
â”‚  â”‚  (å®¢æˆ·ç«¯1)    â”‚  â”‚  (å®¢æˆ·ç«¯2)   â”‚ â”‚ (å®¢æˆ·ç«¯3) â”‚ â”‚  ...   â”‚â”‚
â”‚  â”‚  æ‰§è¡ŒSQL      â”‚  â”‚  æ‰§è¡ŒSQL     â”‚ â”‚  æ‰§è¡ŒSQL  â”‚ â”‚        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              åå°è¾…åŠ©è¿›ç¨‹                             â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ BGWriter    â”‚  â”‚ Checkpointer â”‚  â”‚ WAL Writer  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ åå°å†™å…¥å™¨   â”‚  â”‚ æ£€æŸ¥ç‚¹è¿›ç¨‹    â”‚  â”‚ WALå†™å…¥å™¨   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ åˆ·æ–°è„é¡µ    â”‚  â”‚ æ‰§è¡Œæ£€æŸ¥ç‚¹    â”‚  â”‚ WALåˆ·ç›˜     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Autovacuum  â”‚  â”‚Stats Collectorâ”‚ â”‚SysLogger   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Launcher    â”‚  â”‚ ç»Ÿè®¡æ”¶é›†å™¨    â”‚  â”‚ æ—¥å¿—è¿›ç¨‹    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚         â”‚ fork workers                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚ Autovacuum  â”‚  â”‚ Autovacuum   â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚ Worker 1    â”‚  â”‚ Worker 2     â”‚  ...             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                å…±äº«å†…å­˜æ®µ                             â”‚  â”‚
â”‚  â”‚  â€¢ Shared Buffers (ç¼“å†²æ± )                           â”‚  â”‚
â”‚  â”‚  â€¢ WAL Buffers (WALç¼“å†²åŒº)                          â”‚  â”‚
â”‚  â”‚  â€¢ Lock Tables (é”è¡¨)                               â”‚  â”‚
â”‚  â”‚  â€¢ PGPROC Array (è¿›ç¨‹æ•°ç»„)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æ ¸å¿ƒè¿›ç¨‹èŒè´£

### 1. Postmaster (ä¸»è¿›ç¨‹)

**æºç **: `src/backend/postmaster/postmaster.c`

**èŒè´£**:
- âœ… å¯åŠ¨æ•°æ®åº“ç³»ç»Ÿ
- âœ… ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ (ç«¯å£5432)
- âœ… Fork backendè¿›ç¨‹å¤„ç†è¿æ¥
- âœ… Forkå¹¶ç®¡ç†æ‰€æœ‰è¾…åŠ©è¿›ç¨‹
- âœ… å¤„ç†ä¿¡å· (SIGHUP, SIGTERM, SIGQUITç­‰)
- âœ… å´©æºƒæ¢å¤åè°ƒ

**å…³é”®å‡½æ•°**: `PostmasterMain()`, `ServerLoop()`, `BackendStartup()`

---

### 2. Backend Process (åç«¯è¿›ç¨‹)

**æºç **: `src/backend/tcop/postgres.c`

**èŒè´£**:
- âœ… ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥æœåŠ¡
- âœ… è§£æSQLè¯­å¥
- âœ… æ‰§è¡ŒæŸ¥è¯¢
- âœ… è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
- âœ… ç®¡ç†ä¼šè¯çŠ¶æ€å’Œäº‹åŠ¡

**å…³é”®å‡½æ•°**: `PostgresMain()`, `exec_simple_query()`, `PortalRun()`

---

### 3. Checkpointer (æ£€æŸ¥ç‚¹è¿›ç¨‹)

**æºç **: `src/backend/postmaster/checkpointer.c`

**èŒè´£**:
- âœ… å®šæœŸæ‰§è¡Œæ£€æŸ¥ç‚¹
- âœ… åˆ·æ–°æ‰€æœ‰è„é¡µåˆ°ç£ç›˜
- âœ… æ¨è¿›WALé‡æ”¾ç‚¹
- âœ… ç®¡ç†WALæ–‡ä»¶å›æ”¶

**å…³é”®å‡½æ•°**: `CheckpointerMain()`, `CheckPointGuts()`, `BufferSync()`

---

### 4. Background Writer (åå°å†™å…¥å™¨)

**æºç **: `src/backend/postmaster/bgwriter.c`

**èŒè´£**:
- âœ… æŒç»­æ‰«æç¼“å†²æ± 
- âœ… ä¸»åŠ¨åˆ·æ–°è„é¡µ (åˆ†æ•£I/O)
- âœ… å‡å°‘æ£€æŸ¥ç‚¹å‹åŠ›
- âœ… é˜²æ­¢ç¼“å†²æ± ç”¨å°½

**å…³é”®å‡½æ•°**: `BackgroundWriterMain()`, `BgBufferSync()`

---

### 5. WAL Writer (WALå†™å…¥å™¨)

**æºç **: `src/backend/postmaster/walwriter.c`

**èŒè´£**:
- âœ… å®šæœŸåˆ·æ–°WALç¼“å†²åŒºåˆ°ç£ç›˜
- âœ… å‡å°‘backendè¿›ç¨‹çš„åˆ·ç›˜å»¶è¿Ÿ
- âœ… æé«˜äº‹åŠ¡æäº¤ååé‡

**å…³é”®å‡½æ•°**: `WalWriterMain()`, `XLogBackgroundFlush()`

---

### 6. Autovacuum Launcher/Workers

**æºç **: `src/backend/postmaster/autovacuum.c`

**èŒè´£**:
- âœ… Launcher: å®šæœŸæ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯
- âœ… Launcher: Fork workerè¿›ç¨‹æ‰§è¡Œæ¸…ç†
- âœ… Workers: æ‰§è¡ŒVACUUMå’ŒANALYZE
- âœ… æ¸…ç†æ­»å…ƒç»„ï¼Œé˜²æ­¢è¡¨è†¨èƒ€

**å…³é”®å‡½æ•°**: `AutoVacLauncherMain()`, `AutoVacWorkerMain()`, `do_autovacuum()`

---

## ğŸ“Š è¿›ç¨‹é—´é€šä¿¡

### 1. å…±äº«å†…å­˜

```
æ‰€æœ‰è¿›ç¨‹é€šè¿‡å…±äº«å†…å­˜é€šä¿¡:
- Shared Buffers: ç¼“å†²æ± 
- Lock Tables: é”ç®¡ç†
- PGPROC Array: è¿›ç¨‹çŠ¶æ€
- WAL Buffers: WALç¼“å†²
- CLOG Buffers: äº‹åŠ¡çŠ¶æ€
```

### 2. ä¿¡å·

```
è¿›ç¨‹é—´é€šè¿‡ä¿¡å·åè°ƒ:
- SIGUSR1: é€šç”¨å”¤é†’ä¿¡å·
- SIGTERM: ä¼˜é›…é€€å‡º
- SIGQUIT: ç«‹å³é€€å‡º
- SIGHUP: é‡æ–°åŠ è½½é…ç½®
```

### 3. Latch (é—©é”)

```c
// é«˜æ•ˆçš„è¿›ç¨‹é—´å”¤é†’æœºåˆ¶
WaitLatch(&MyProc->procLatch, WL_LATCH_SET | WL_TIMEOUT, timeout);
SetLatch(&proc->procLatch);  // å”¤é†’å¦ä¸€ä¸ªè¿›ç¨‹
```

---

## ğŸ”„ å…¸å‹å·¥ä½œæµç¨‹

### å®¢æˆ·ç«¯è¿æ¥æµç¨‹

```
1. å®¢æˆ·ç«¯è¿æ¥åˆ°ç«¯å£5432
   â†“
2. Postmaster æ¥å—è¿æ¥
   â†“
3. Postmaster fork() æ–°çš„ Backend è¿›ç¨‹
   â†“
4. Backend è¿›ç¨‹ç»§æ‰¿è¿æ¥socket
   â†“
5. Backend è¿›ç¨‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
   â†“
6. å®¢æˆ·ç«¯æ–­å¼€ â†’ Backend è¿›ç¨‹é€€å‡º
```

### æŸ¥è¯¢æ‰§è¡Œæµç¨‹

```
Backendè¿›ç¨‹ä¸­:
1. æ¥æ”¶SQLè¯­å¥
   â†“
2. Parser: è¯æ³•åˆ†æã€è¯­æ³•åˆ†æ â†’ è§£ææ ‘
   â†“
3. Analyzer: è¯­ä¹‰åˆ†æ â†’ æŸ¥è¯¢æ ‘
   â†“
4. Rewriter: é‡å†™è§„åˆ™ â†’ é‡å†™åçš„æŸ¥è¯¢æ ‘
   â†“
5. Planner: æŸ¥è¯¢ä¼˜åŒ– â†’ æ‰§è¡Œè®¡åˆ’
   â†“
6. Executor: æ‰§è¡ŒæŸ¥è¯¢ â†’ ç»“æœé›†
   â†“
7. è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
```

---

## ğŸš€ å¿«é€Ÿç›‘æ§

### æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹

```sql
-- æŸ¥çœ‹æ‰€æœ‰PostgreSQLè¿›ç¨‹
SELECT 
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    query
FROM pg_stat_activity
ORDER BY backend_start;

-- æŸ¥çœ‹åå°è¿›ç¨‹
SELECT pid, backend_type 
FROM pg_stat_activity 
WHERE backend_type LIKE '%ground%' OR backend_type LIKE '%checkpoint%';
```

### ç³»ç»Ÿå±‚é¢

```bash
# æŸ¥çœ‹è¿›ç¨‹æ ‘
ps auxf | grep postgres

# ç¤ºä¾‹è¾“å‡º:
# postgres  1234  Ss   postmaster -D /data
# postgres  1235  S     \_ postgres: checkpointer
# postgres  1236  S     \_ postgres: background writer
# postgres  1237  S     \_ postgres: walwriter
# postgres  1238  S     \_ postgres: autovacuum launcher
# postgres  1239  Ss    \_ postgres: user db [local] idle
```

---

## ğŸ“– å­¦ä¹ è·¯å¾„

### åŸºç¡€ (1-2å¤©)
1. ç†è§£è¿›ç¨‹æ¶æ„æ€»è§ˆ
2. äº†è§£Postmasterçš„èŒè´£
3. ç†è§£Backendè¿›ç¨‹æ‰§è¡Œæµç¨‹

### è¿›é˜¶ (3-5å¤©)
4. æ·±å…¥Checkpointerå’ŒBGWriter
5. ç†è§£WAL Writerå·¥ä½œæœºåˆ¶
6. å­¦ä¹ Autovacuumè°ƒä¼˜

### ä¸“å®¶ (1-2å‘¨)
7. æºç é˜…è¯»: `src/backend/postmaster/`
8. åˆ†æè¿›ç¨‹é—´åŒæ­¥æœºåˆ¶
9. è°ƒä¼˜å„è¿›ç¨‹å‚æ•°

---

**ä¸‹ä¸€æ­¥**: é˜…è¯» [01_overview.md](01_overview.md) æ·±å…¥äº†è§£è¿›ç¨‹æ¶æ„

**æºç ç‰ˆæœ¬**: PostgreSQL 17.6  
**æœ€åæ›´æ–°**: 2025-10-16

