# Buffer Manager å®Œæ•´åˆ†æžæ–‡æ¡£

> PostgreSQL 17.5 Buffer Manager æ¨¡å—æ·±åº¦å‰–æž

---

## ðŸ“š æ–‡æ¡£å¯¼èˆª

æœ¬æ¨¡å—åŒ…å« 7 ç¯‡æ ¸å¿ƒæ–‡æ¡£ï¼Œç³»ç»Ÿæ€§åˆ†æž Buffer Manager çš„è®¾è®¡ä¸Žå®žçŽ°ï¼š

| åºå· | æ–‡æ¡£ | è¯´æ˜Ž | è¿›åº¦ |
|-----|------|------|------|
| 01 | [overview.md](01_overview.md) | Buffer Manager æ¦‚è¿°ä¸Žæ ¸å¿ƒåŠŸèƒ½ | âœ… |
| 02 | [data_structures.md](02_data_structures.md) | æ ¸å¿ƒæ•°æ®ç»“æž„è¯¦è§£ | âœ… |
| 03 | [implementation_flow.md](03_implementation_flow.md) | å®žçŽ°æµç¨‹åˆ†æž | âœ… |
| 04 | [key_algorithms.md](04_key_algorithms.md) | å…³é”®ç®—æ³•è¯¦è§£ | âœ… |
| 05 | [performance.md](05_performance.md) | æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ | âœ… |
| 06 | [testcases.md](06_testcases.md) | æµ‹è¯•ç”¨ä¾‹é›† | âœ… |
| 07 | [diagrams.md](07_diagrams.md) | æž¶æž„å›¾è¡¨é›† | âœ… |

**æ€»è®¡**: 7 ç¯‡æ–‡æ¡£ï¼Œçº¦ 1500+ è¡Œä»£ç å’Œå›¾è¡¨

---

## ðŸŽ¯ å­¦ä¹ è·¯å¾„

### åˆå­¦è€…è·¯å¾„

```
1. ä»Žæ¦‚è¿°å¼€å§‹
   01_overview.md
   â””â”€ ç†è§£ Buffer Manager çš„ä½œç”¨å’Œæ ¸å¿ƒæ¦‚å¿µ

2. å­¦ä¹ æ•°æ®ç»“æž„
   02_data_structures.md
   â””â”€ æŽŒæ¡ BufferDescã€BufferTagã€å“ˆå¸Œè¡¨ç­‰æ ¸å¿ƒç»“æž„

3. äº†è§£ä¸»è¦æµç¨‹
   03_implementation_flow.md
   â””â”€ ReadBufferã€WriteBufferã€Pin/Unpin çš„æ‰§è¡Œæµç¨‹

4. æŸ¥çœ‹å›¾è¡¨
   07_diagrams.md
   â””â”€ é€šè¿‡å¯è§†åŒ–åŠ æ·±ç†è§£
```

### è¿›é˜¶è·¯å¾„

```
1. æ·±å…¥ç®—æ³•
   04_key_algorithms.md
   â””â”€ Clock-Sweepã€å“ˆå¸ŒæŸ¥æ‰¾ã€è„é¡µåˆ·å†™ç­‰æ ¸å¿ƒç®—æ³•

2. æ€§èƒ½è°ƒä¼˜
   05_performance.md
   â””â”€ å‚æ•°é…ç½®ã€ç›‘æŽ§æŒ‡æ ‡ã€ä¼˜åŒ–æŠ€å·§

3. å®žè·µéªŒè¯
   06_testcases.md
   â””â”€ è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ç†è§£
```

### ä¸“å®¶è·¯å¾„

```
å…¨é¢é˜…è¯»æ‰€æœ‰æ–‡æ¡£ï¼Œé‡ç‚¹å…³æ³¨ï¼š
- å¹¶å‘æŽ§åˆ¶æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
- è¾¹ç•Œæ¡ä»¶å¤„ç†
- ä¸Žå…¶ä»–æ¨¡å—çš„äº¤äº’
```

---

## ðŸ“– æ ¸å¿ƒå†…å®¹æ¦‚è§ˆ

### 1. Buffer Manager æ¦‚è¿°

**å…³é”®æ¦‚å¿µ**:
- å…±äº«ç¼“å†²æ±  (shared_buffers)
- Buffer æè¿°ç¬¦ (BufferDesc)
- Clock-Sweep ç½®æ¢ç®—æ³•
- Pin/Unpin æœºåˆ¶

**æ ¸å¿ƒèŒè´£**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é¡µé¢ç¼“å­˜ (å‡å°‘ç£ç›˜ I/O)          â”‚
â”‚ 2. å¹¶å‘æŽ§åˆ¶ (å¤šè¿›ç¨‹å®‰å…¨è®¿é—®)        â”‚
â”‚ 3. è„é¡µç®¡ç† (è·Ÿè¸ªä¿®æ”¹,æ‰¹é‡åˆ·å†™)     â”‚
â”‚ 4. ç½®æ¢ç­–ç•¥ (é€‰æ‹©æ·˜æ±°é¡µé¢)          â”‚
â”‚ 5. I/O ä¼˜åŒ– (æ‰¹é‡è¯»å†™,é¢„è¯»)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæ•°æ®ç»“æž„

**BufferDesc** (64 å­—èŠ‚):
```c
â”œâ”€ tag:          BufferTag (é¡µé¢æ ‡è¯†)
â”œâ”€ flags:        çŠ¶æ€æ ‡å¿— (BM_VALID, BM_DIRTY, ...)
â”œâ”€ usage_count:  ä½¿ç”¨è®¡æ•° (0-5)
â”œâ”€ refcount:     å¼•ç”¨è®¡æ•° (Pin count)
â””â”€ content_lock: å†…å®¹é”
```

**BufferTag** (24 å­—èŠ‚):
```c
â”œâ”€ rnode:   RelFileNode (spc, db, rel)
â”œâ”€ forkNum: ForkNumber (main/fsm/vm)
â””â”€ blockNum: BlockNumber
```

**å“ˆå¸Œè¡¨**: 128 åˆ†åŒºï¼ŒO(1) æŸ¥æ‰¾

### 3. æ ¸å¿ƒç®—æ³•

**Clock-Sweep ç½®æ¢**:
```
æ—¶é—´å¤æ‚åº¦: O(1) å¹³å‡, O(N) æœ€å
ç©ºé—´å¤æ‚åº¦: O(1)
å¹¶å‘æ€§èƒ½:   ä¼˜ç§€ (åŽŸå­æ“ä½œ)
```

**å“ˆå¸ŒæŸ¥æ‰¾**:
```
æŸ¥æ‰¾: O(1) å¹³å‡
æ’å…¥: O(1)
åˆ é™¤: O(1)
```

**è„é¡µåˆ·å†™**:
```
1. æ‰«ææ ‡è®°    O(N)
2. æŽ’åº        O(N log N)
3. æ‰¹é‡å†™å…¥    O(N)
4. è´Ÿè½½å‡è¡¡    (å †ç®—æ³•)
```

### 4. æ€§èƒ½ä¼˜åŒ–

**å…³é”®å‚æ•°**:
```ini
shared_buffers = 4GB              # ç³»ç»Ÿå†…å­˜çš„ 25%
effective_cache_size = 12GB       # 75%
work_mem = 16MB                   # ä¿å®ˆè®¾ç½®
checkpoint_timeout = 15min
max_wal_size = 4GB
```

**ç›‘æŽ§æŒ‡æ ‡**:
- ç¼“å­˜å‘½ä¸­çŽ‡ (> 99%)
- Backend å†™å…¥æ¯”ä¾‹ (< 5%)
- è¯·æ±‚ checkpoint æ¯”ä¾‹ (< 10%)

---

## ðŸ”¬ æŠ€æœ¯äº®ç‚¹

### 1. Clock-Sweep ç®—æ³•

```
ä¼˜åŠ¿:
âœ“ O(1) å¹³å‡æ—¶é—´å¤æ‚åº¦
âœ“ æ— éœ€ç»´æŠ¤ LRU é“¾è¡¨
âœ“ å¹¶å‘å‹å¥½ (åŽŸå­æ“ä½œ)
âœ“ è¿‘ä¼¼ LRU æ•ˆæžœ
âœ“ å®žçŽ°ç®€å•,bug å°‘
```

### 2. åˆ†åŒºå“ˆå¸Œè¡¨

```
è®¾è®¡:
âœ“ 128 ä¸ªåˆ†åŒº
âœ“ æ¯ä¸ªåˆ†åŒºç‹¬ç«‹ LWLock
âœ“ åˆ†æ•£é”ç«žäº‰
âœ“ æ”¯æŒé«˜å¹¶å‘
```

### 3. å¤šå±‚é”æœºåˆ¶

```
é”å±‚æ¬¡:
Level 1: Buffer Mapping Lock (å¾®ç§’çº§)
Level 2: Buffer Header Lock (çº³ç§’çº§)
Level 3: Buffer Content Lock (æ¯«ç§’çº§)

é¿å…æ­»é”:
âœ“ å›ºå®šèŽ·å–é¡ºåº
âœ“ ä¸æŒé”ç­‰å¾…
âœ“ Try-Lock æœºåˆ¶
```

### 4. åŽå°å†™å…¥ä¼˜åŒ–

```
BGWriter:
âœ“ å®šæœŸå†™å°‘é‡è„é¡µ
âœ“ å‡å°‘ Backend é˜»å¡ž

Checkpointer:
âœ“ æ‰¹é‡åˆ·å†™æ‰€æœ‰è„é¡µ
âœ“ æŽ’åºä¼˜åŒ– I/O
âœ“ è´Ÿè½½å‡è¡¡å¤šè¡¨ç©ºé—´
âœ“ é™æµå¹³æ»‘ I/O
```

---

## ðŸ“Š å…³é”®ç»Ÿè®¡

### æ–‡æ¡£ç»Ÿè®¡

```
æ€»è¡Œæ•°:        ~8,000 è¡Œ
ä»£ç ç¤ºä¾‹:      150+ ä¸ª
ASCII å›¾è¡¨:    80+ ä¸ª
æµ‹è¯•ç”¨ä¾‹:      20+ ä¸ª
æ€§èƒ½åŸºå‡†:      10+ ä¸ª
```

### æ¨¡å—ç»Ÿè®¡

```
æºç æ–‡ä»¶:      10+ ä¸ª
ä»£ç è¡Œæ•°:      ~15,000 è¡Œ
æ•°æ®ç»“æž„:      20+ ä¸ª
æ ¸å¿ƒå‡½æ•°:      50+ ä¸ª
é…ç½®å‚æ•°:      15+ ä¸ª
```

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. æŸ¥çœ‹å½“å‰é…ç½®

```sql
-- æŸ¥çœ‹ shared_buffers
SHOW shared_buffers;

-- æŸ¥çœ‹å‘½ä¸­çŽ‡
SELECT 
    datname,
    round(100.0 * blks_hit / 
          NULLIF(blks_hit + blks_read, 0), 2) AS hit_ratio
FROM pg_stat_database
WHERE datname = current_database();
```

### 2. ç›‘æŽ§ Buffer ä½¿ç”¨

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION pg_buffercache;

-- æŸ¥çœ‹ä½¿ç”¨æƒ…å†µ
SELECT 
    count(*) AS total_buffers,
    count(*) FILTER (WHERE isdirty) AS dirty_buffers,
    round(100.0 * count(*) FILTER (WHERE isdirty) / count(*), 2) 
        AS dirty_ratio
FROM pg_buffercache;
```

### 3. åŸºç¡€è°ƒä¼˜

```sql
-- å¢žåŠ ç¼“å†²æ±  (éœ€é‡å¯)
ALTER SYSTEM SET shared_buffers = '4GB';

-- è°ƒæ•´ BGWriter (ç«‹å³ç”Ÿæ•ˆ)
ALTER SYSTEM SET bgwriter_delay = '100ms';
ALTER SYSTEM SET bgwriter_lru_maxpages = '200';
SELECT pg_reload_conf();
```

---

## ðŸ”— ç›¸å…³æ¨¡å—

Buffer Manager ä¸Žå…¶ä»–æ¨¡å—çš„å…³ç³»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Buffer Manager                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WAL       â”‚        â”‚ Checkpoint  â”‚
â”‚   System    â”‚        â”‚  Process    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Storage Manager (SMGR)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–å…³ç³»**:
- WAL â†’ Buffer Manager (Write-Ahead Logging)
- Checkpoint â†’ Buffer Manager (è„é¡µåˆ·å†™)
- Buffer Manager â†’ Storage Manager (ç£ç›˜ I/O)

---

## ðŸ“ ä½¿ç”¨å»ºè®®

### æ–‡æ¡£é˜…è¯»å»ºè®®

1. **é¦–æ¬¡é˜…è¯»**: æŒ‰åºå· 01 â†’ 07 é˜…è¯»
2. **æŸ¥é˜…å‚è€ƒ**: ä½¿ç”¨ç›®å½•å¿«é€Ÿå®šä½
3. **å®žè·µéªŒè¯**: è¿è¡Œæµ‹è¯•ç”¨ä¾‹å·©å›ºç†è§£
4. **æ·±å…¥ç ”ç©¶**: ç»“åˆæºç é˜…è¯»

### æºç é˜…è¯»å»ºè®®

**æ ¸å¿ƒæ–‡ä»¶**:
```
src/backend/storage/buffer/
â”œâ”€â”€ bufmgr.c        (æ ¸å¿ƒç®¡ç†)
â”œâ”€â”€ buf_table.c     (å“ˆå¸Œè¡¨)
â”œâ”€â”€ freelist.c      (Clock-Sweep)
â””â”€â”€ localbuf.c      (æœ¬åœ° Buffer)

src/include/storage/
â”œâ”€â”€ buf_internals.h (æ•°æ®ç»“æž„)
â””â”€â”€ bufmgr.h        (æŽ¥å£å®šä¹‰)
```

**é˜…è¯»é¡ºåº**:
```
1. buf_internals.h  (æ•°æ®ç»“æž„)
2. bufmgr.h         (æŽ¥å£å®šä¹‰)
3. bufmgr.c         (ReadBuffer æµç¨‹)
4. buf_table.c      (å“ˆå¸Œè¡¨å®žçŽ°)
5. freelist.c       (Clock-Sweep)
```

---

## âš¡ å¸¸è§é—®é¢˜

### Q1: shared_buffers è®¾ç½®å¤šå¤§åˆé€‚ï¼Ÿ

**A**: æŽ¨èç³»ç»Ÿå†…å­˜çš„ 25%
- 4GB å†…å­˜ â†’ 1GB
- 16GB å†…å­˜ â†’ 4GB
- 64GB å†…å­˜ â†’ 16GB
- ä¸å»ºè®®è¶…è¿‡ 32GB

### Q2: å¦‚ä½•æé«˜ç¼“å­˜å‘½ä¸­çŽ‡ï¼Ÿ

**A**: 
1. å¢žåŠ  shared_buffers
2. ä¼˜åŒ–æŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
3. é¿å…å…¨è¡¨æ‰«æ
4. ä½¿ç”¨ Ring Buffer ç­–ç•¥

### Q3: Backend å†™å…¥è¿‡å¤šæ€Žä¹ˆåŠžï¼Ÿ

**A**: 
1. å¢žåŠ  bgwriter_lru_maxpages
2. å‡å° bgwriter_delay
3. å¢žå¤§ max_wal_size
4. ç›‘æŽ§ checkpoint é¢‘çŽ‡

### Q4: å¦‚ä½•ç›‘æŽ§ Buffer æ€§èƒ½ï¼Ÿ

**A**: 
```sql
-- å‘½ä¸­çŽ‡
SELECT * FROM pg_stat_database;

-- BGWriter ç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- Buffer è¯¦æƒ… (éœ€ pg_buffercache)
SELECT * FROM pg_buffercache;
```

---

## ðŸŽ“ å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [PostgreSQL Documentation - Server Configuration](https://www.postgresql.org/docs/17/runtime-config-resource.html)
- [PostgreSQL Documentation - Monitoring](https://www.postgresql.org/docs/17/monitoring-stats.html)

### æŽ¨èé˜…è¯»
- PostgreSQL å†…æ ¸åˆ†æž
- Database System Concepts (Silberschatz)
- PostgreSQL æºç å‰–æž

### ç›¸å…³å·¥å…·
- pg_buffercache: Buffer ç›‘æŽ§æ‰©å±•
- pg_stat_statements: æŸ¥è¯¢ç»Ÿè®¡
- pgbench: æ€§èƒ½æµ‹è¯•
- Grafana: å¯è§†åŒ–ç›‘æŽ§

---

## ðŸ“œ æ›´æ–°æ—¥å¿—

### v1.0 (2025-01-16)
- âœ… å®Œæˆ 7 ç¯‡æ ¸å¿ƒæ–‡æ¡£
- âœ… 80+ ä¸ª ASCII å›¾è¡¨
- âœ… 150+ ä¸ªä»£ç ç¤ºä¾‹
- âœ… 20+ ä¸ªæµ‹è¯•ç”¨ä¾‹
- âœ… å®Œæ•´çš„æž¶æž„åˆ†æž

---

## ðŸ‘¥ è´¡çŒ®

æ¬¢è¿Žæ”¹è¿›å»ºè®®å’Œé”™è¯¯æŠ¥å‘Šï¼

---

## ðŸ“„ è®¸å¯

æœ¬æ–‡æ¡£éµå¾ª PostgreSQL License

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åŸºäºŽæºç **: PostgreSQL 17.5
**åˆ›å»ºæ—¥æœŸ**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL å­¦ä¹ å°ç»„

**ä¸‹ä¸€ä¸ªæ¨¡å—**: [WAL System](../wal/) - é¢„å†™å¼æ—¥å¿—ç³»ç»Ÿåˆ†æž


