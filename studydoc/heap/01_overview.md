# HEAP å †è¡¨æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»PostgreSQLå †è¡¨çš„åŸºæœ¬æ¦‚å¿µã€æ¶æ„å’Œæ ¸å¿ƒç‰¹æ€§ã€‚

---

## 1. å †è¡¨æ˜¯ä»€ä¹ˆï¼Ÿ

### 1.1 å®šä¹‰

**Heap (å †è¡¨)** æ˜¯PostgreSQLçš„é»˜è®¤è¡¨å­˜å‚¨æ ¼å¼ï¼Œé‡‡ç”¨**æ— åºå †å­˜å‚¨**ç»“æ„ï¼š

```
ç‰¹ç‚¹:
- ğŸ“ æ— åºå­˜å‚¨: æ•°æ®æŒ‰æ’å…¥é¡ºåºå­˜å‚¨ï¼Œä¸ä¿è¯ç‰©ç†é¡ºåº
- â• è¿½åŠ ä¼˜å…ˆ: æ–°æ•°æ®ä¼˜å…ˆä½¿ç”¨FSMè®°å½•çš„ç©ºé—²ç©ºé—´
- ğŸ”„ MVCCæ”¯æŒ: é€šè¿‡å…ƒç»„ç‰ˆæœ¬å®ç°å¤šç‰ˆæœ¬å¹¶å‘
- ğŸš€ HOT Update: åŒé¡µæ›´æ–°ä¼˜åŒ–
```

### 1.2 å¯¹æ¯”å…¶ä»–å­˜å‚¨æ ¼å¼

| ç‰¹æ€§ | Heap (å †è¡¨) | Index-Organized Table | Columnar |
|------|-------------|----------------------|----------|
| æ•°æ®é¡ºåº | æ— åº | æŒ‰ä¸»é”®æ’åº | åˆ—å­˜å‚¨ |
| æ’å…¥é€Ÿåº¦ | âš¡ å¿« | æ…¢ | å¿« |
| èŒƒå›´æŸ¥è¯¢ | éœ€ç´¢å¼• | âš¡ å¿« | æ…¢ |
| æ›´æ–°ä»£ä»· | ä¸­ç­‰ | é«˜ | é«˜ |
| ç©ºé—´æ•ˆç‡ | ä¸­ç­‰ | ä½ | âš¡ é«˜ |
| MVCC | âœ… åŸç”Ÿæ”¯æŒ | å¤æ‚ | å¤æ‚ |

**PostgreSQLåªæ”¯æŒHeapå­˜å‚¨**ï¼ˆä¸»è¡¨ï¼‰ï¼Œä½†é€šè¿‡ç´¢å¼•å®ç°æ’åºè®¿é—®ã€‚

---

## 2. é¡µé¢ç»“æ„ (8KB)

### 2.1 å®Œæ•´é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  0
â”‚                   PageHeaderData (24 Bytes)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ pd_lsn (8B)         - WALæ—¥å¿—åºåˆ—å·                â”‚  â”‚
â”‚  â”‚ pd_checksum (2B)    - é¡µé¢æ ¡éªŒå’Œ                   â”‚  â”‚
â”‚  â”‚ pd_flags (2B)       - æ ‡å¿—ä½                       â”‚  â”‚
â”‚  â”‚ pd_lower (2B)       - ç©ºé—²ç©ºé—´èµ·å§‹åç§»             â”‚  â”‚
â”‚  â”‚ pd_upper (2B)       - ç©ºé—²ç©ºé—´ç»“æŸåç§»             â”‚  â”‚
â”‚  â”‚ pd_special (2B)     - ç‰¹æ®Šç©ºé—´èµ·å§‹åç§»             â”‚  â”‚
â”‚  â”‚ pd_pagesize_version (2B) - é¡µå¤§å°å’Œç‰ˆæœ¬å·         â”‚  â”‚
â”‚  â”‚ pd_prune_xid (4B)   - å‰ªæäº‹åŠ¡ID                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  24
â”‚              ItemIdData Array (è¡ŒæŒ‡é’ˆæ•°ç»„)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ItemId[0]: (lp_off, lp_flags, lp_len)  4 Bytes    â”‚  â”‚
â”‚  â”‚ ItemId[1]: ...                          4 Bytes    â”‚  â”‚
â”‚  â”‚ ItemId[2]: ...                          4 Bytes    â”‚  â”‚
â”‚  â”‚ ...                                                 â”‚  â”‚
â”‚  â”‚ ItemId[N]: ...                          4 Bytes    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“ pd_lower                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚                   Free Space (ç©ºé—²ç©ºé—´)                   â”‚
â”‚                   å¯ä»¥å‘ä¸Šæˆ–å‘ä¸‹å¢é•¿                       â”‚
â”‚                                                           â”‚
â”‚                          â†‘ pd_upper                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Tuples (å…ƒç»„æ•°æ®ï¼Œä»åº•éƒ¨å‘ä¸Š)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tuple N: HeapTupleHeader + user data               â”‚  â”‚
â”‚  â”‚ ...                                                 â”‚  â”‚
â”‚  â”‚ Tuple 2: HeapTupleHeader + user data               â”‚  â”‚
â”‚  â”‚ Tuple 1: HeapTupleHeader + user data               â”‚  â”‚
â”‚  â”‚ Tuple 0: HeapTupleHeader + user data               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             Special Space (ç‰¹æ®Šç©ºé—´ï¼Œå¯é€‰)                â”‚
â”‚             (ç´¢å¼•é¡µä½¿ç”¨ï¼Œå †è¡¨é¡µé€šå¸¸ä¸ºç©º)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  8192
```

### 2.2 å…³é”®å­—æ®µè¯´æ˜

**pd_lower / pd_upper**: æ ‡è®°ç©ºé—²ç©ºé—´è¾¹ç•Œ
```
ç©ºé—²ç©ºé—´å¤§å° = pd_upper - pd_lower

æ’å…¥æ–°å…ƒç»„:
  1. åœ¨ ItemIdData æ•°ç»„æœ«å°¾æ·»åŠ æ–°çš„è¡ŒæŒ‡é’ˆ (pd_lower += 4)
  2. åœ¨é¡µé¢åº•éƒ¨å†™å…¥å…ƒç»„æ•°æ® (pd_upper -= tuple_size)
  3. å¦‚æœ pd_lower > pd_upper â†’ é¡µé¢æ»¡
```

**pd_prune_xid**: é¡µé¢å‰ªæä¼˜åŒ–
```
è®°å½•æœ€å°çš„å¯èƒ½éœ€è¦å‰ªæçš„äº‹åŠ¡ID
ç”¨äºå¿«é€Ÿåˆ¤æ–­é¡µé¢æ˜¯å¦éœ€è¦å‰ªæ
```

---

## 3. å…ƒç»„ç»“æ„

### 3.1 HeapTupleHeader

```c
// src/include/access/htup_details.h:116
typedef struct HeapTupleHeaderData
{
    union {
        HeapTupleFields t_heap;      // å¸¸è§„å…ƒç»„å­—æ®µ
        DatumTupleFields t_datum;    // TOASTå…ƒç»„å­—æ®µ
    } t_choice;
    
    ItemPointerData t_ctid;          // å½“å‰æˆ–æ–°ç‰ˆæœ¬çš„TID (6B)
    
    uint16 t_infomask2;              // åˆ—æ•°å’Œæ ‡å¿—ä½ (2B)
    uint16 t_infomask;               // å„ç§æ ‡å¿—ä½ (2B)
    uint8  t_hoff;                   // å¤´éƒ¨é•¿åº¦ (1B)
    
    bits8  t_bits[FLEXIBLE_ARRAY_MEMBER];  // NULLä½å›¾ï¼ˆå¯å˜ï¼‰
    
    /* ä¹‹åæ˜¯å®é™…çš„åˆ—æ•°æ® */
} HeapTupleHeaderData;

// HeapTupleFields (å¸¸è§„å­—æ®µ)
typedef struct HeapTupleFields
{
    TransactionId t_xmin;   // æ’å…¥äº‹åŠ¡ID (4B)
    TransactionId t_xmax;   // åˆ é™¤/é”å®šäº‹åŠ¡ID (4B)
    
    union {
        CommandId t_cid;    // æ’å…¥å’Œåˆ é™¤å‘½ä»¤ID (4B)
        TransactionId t_xvac; // VACUUMäº‹åŠ¡ID
    } t_field3;
} HeapTupleFields;
```

### 3.2 å…ƒç»„å¤§å°è®¡ç®—

```
å…ƒç»„æ€»å¤§å° = HeapTupleHeader + NULLä½å›¾ + ç”¨æˆ·æ•°æ® + å¯¹é½

ç¤ºä¾‹: CREATE TABLE t (a INT, b TEXT, c TIMESTAMP);

HeapTupleHeader: 23B (å›ºå®šéƒ¨åˆ†)
NULLä½å›¾: CEIL(3åˆ— / 8) = 1B
å¯¹é½: è‡³å°‘å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œ

å®é™…æ•°æ®:
  a (INT4): 4B
  b (TEXT): varlenaå¤´(4B) + å®é™…å­—ç¬¦ä¸²
  c (TIMESTAMP): 8B

æœ€å°å…ƒç»„: 23 + 1 + å¯¹é½ + 4 + 4 + 8 â‰ˆ 48B (å«å¯¹é½)
```

---

## 4. TID (Tuple Identifier)

### 4.1 ç»“æ„

```c
typedef struct ItemPointerData
{
    BlockIdData ip_blkid;   // é¡µå· (4B)
    OffsetNumber ip_posid;  // é¡µå†…åç§» (2B)
} ItemPointerData;

// æ€»å…± 6 å­—èŠ‚
// æ ¼å¼: (blockNumber, offsetNumber)
// ç¤ºä¾‹: (0, 1) è¡¨ç¤ºç¬¬0é¡µçš„ç¬¬1ä¸ªå…ƒç»„
```

### 4.2 ä½œç”¨

```
1. å”¯ä¸€æ ‡è¯†: æ¯ä¸ªå…ƒç»„çš„ç‰©ç†ä½ç½®
2. ç´¢å¼•å¼•ç”¨: ç´¢å¼•å­˜å‚¨TIDæŒ‡å‘å †è¡¨å…ƒç»„
3. t_ctidé“¾: å…ƒç»„æ›´æ–°é“¾
   - æ—§ç‰ˆæœ¬çš„ t_ctid æŒ‡å‘æ–°ç‰ˆæœ¬
   - æœ€æ–°ç‰ˆæœ¬çš„ t_ctid æŒ‡å‘è‡ªå·±

ç¤ºä¾‹æ›´æ–°é“¾:
  (0,1) [t_ctid=(0,5)] â†’ (0,5) [t_ctid=(1,3)] â†’ (1,3) [t_ctid=(1,3)]
  æ—§ç‰ˆæœ¬                  æ—§ç‰ˆæœ¬                   æœ€æ–°ç‰ˆæœ¬
```

---

## 5. HOT Update (å…³é”®ä¼˜åŒ–)

### 5.1 åŸç†

**HOT (Heap-Only Tuple)** æ˜¯åŒé¡µæ›´æ–°ä¼˜åŒ–ï¼š

```
ä¼ ç»ŸUPDATE:
  1. åˆ›å»ºæ–°å…ƒç»„ (å¯èƒ½åœ¨ä¸åŒé¡µ)
  2. æ›´æ–°æ‰€æœ‰ç´¢å¼•æŒ‡å‘æ–°å…ƒç»„
  3. æ ‡è®°æ—§å…ƒç»„ä¸ºåˆ é™¤
  
  ä»£ä»·: Nä¸ªç´¢å¼• Ã— ç´¢å¼•æ›´æ–°ä»£ä»·

HOT UPDATE:
  1. åœ¨åŒä¸€é¡µåˆ›å»ºæ–°å…ƒç»„
  2. æ—§å…ƒç»„ t_ctid æŒ‡å‘æ–°å…ƒç»„
  3. ç´¢å¼•ä¸å˜ (ä»æŒ‡å‘æ—§å…ƒç»„)
  4. æŸ¥è¯¢æ—¶æ²¿ç€ HOT é“¾æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬
  
  ä»£ä»·: 0 Ã— ç´¢å¼•æ›´æ–° (å·¨å¤§èŠ‚çœ!)
```

### 5.2 HOT Update æ¡ä»¶

```
âœ… å¿…é¡»æ»¡è¶³:
  1. æ›´æ–°ä¸æ”¹å˜ä»»ä½•ç´¢å¼•åˆ—
  2. æ–°å…ƒç»„åœ¨åŒä¸€é¡µæœ‰ç©ºé—´
  3. é¡µé¢æœªæ»¡ (éœ€è¦ fillfactor < 100)

ç¤ºä¾‹:
  è¡¨: CREATE TABLE users (
        id SERIAL PRIMARY KEY,  -- ç´¢å¼•åˆ—
        status TEXT,            -- éç´¢å¼•åˆ—
        last_login TIMESTAMP
      );
  
  HOT Update âœ…:
    UPDATE users SET last_login = now() WHERE id = 1;
    (ä¸æ”¹å˜ç´¢å¼•åˆ— id)
  
  éHOT âœ—:
    UPDATE users SET id = 999 WHERE id = 1;
    (æ”¹å˜äº†ç´¢å¼•åˆ—ï¼Œå¿…é¡»æ›´æ–°ç´¢å¼•)
```

### 5.3 ç›‘æ§HOT Update

```sql
-- æŸ¥çœ‹HOT Updateæ¯”ä¾‹
SELECT 
    schemaname,
    relname,
    n_tup_upd AS total_updates,
    n_tup_hot_upd AS hot_updates,
    CASE 
        WHEN n_tup_upd > 0 
        THEN round(100.0 * n_tup_hot_upd / n_tup_upd, 2)
        ELSE 0
    END AS hot_ratio
FROM pg_stat_user_tables
WHERE n_tup_upd > 0
ORDER BY n_tup_upd DESC;

-- ç›®æ ‡: hot_ratio > 80%
```

---

## 6. TOAST (è¶…å¤§å­—æ®µå­˜å‚¨)

### 6.1 è§¦å‘æ¡ä»¶

```
TOAST è§¦å‘é˜ˆå€¼: 
  - å…ƒç»„å¤§å° > TOAST_TUPLE_THRESHOLD (~2KB)
  - æˆ–å•ä¸ªå­—æ®µ > TOAST_TUPLE_TARGET (~2KB)

è‡ªåŠ¨è¡Œä¸º:
  1. å°è¯•å‹ç¼©å­—æ®µ (EXTENDEDç­–ç•¥)
  2. å¦‚æœä»å¤ªå¤§ï¼Œç§»åˆ°TOASTè¡¨ (pg_toast.pg_toast_xxxxx)
  3. ä¸»è¡¨åªä¿ç•™æŒ‡é’ˆ
```

### 6.2 TOAST ç­–ç•¥

```c
#define TYPSTORAGE_PLAIN    'p'  // ä¸å‹ç¼©ï¼Œä¸TOAST
#define TYPSTORAGE_EXTERNAL 'e'  // ä¸å‹ç¼©ï¼Œå¤–éƒ¨å­˜å‚¨
#define TYPSTORAGE_EXTENDED 'x'  // å‹ç¼©ï¼Œå¤–éƒ¨å­˜å‚¨ (é»˜è®¤)
#define TYPSTORAGE_MAIN     'm'  // å‹ç¼©ï¼Œä¼˜å…ˆä¸»è¡¨
```

```sql
-- æŸ¥çœ‹åˆ—çš„TOASTç­–ç•¥
SELECT attname, atttypid::regtype, attstorage
FROM pg_attribute
WHERE attrelid = 'your_table'::regclass AND attnum > 0;

-- ä¿®æ”¹TOASTç­–ç•¥
ALTER TABLE your_table ALTER COLUMN large_col SET STORAGE EXTERNAL;
```

### 6.3 TOASTè¡¨ç»“æ„

```sql
-- TOASTè¡¨è‡ªåŠ¨åˆ›å»º
-- pg_toast.pg_toast_<oid>

-- TOASTè®°å½•ç»“æ„:
-- (chunk_id, chunk_seq, chunk_data)
--   chunk_id: åŸè¡Œçš„OID
--   chunk_seq: å—åºå· (0, 1, 2, ...)
--   chunk_data: 2KBæ•°æ®å—
```

---

## 7. å¡«å……å› å­ (Fillfactor)

### 7.1 ä½œç”¨

```
fillfactor: æ§åˆ¶é¡µé¢å¡«å……ç¨‹åº¦ï¼Œä¸ºHOT Updateé¢„ç•™ç©ºé—´

é»˜è®¤: 100 (å¡«æ»¡æ•´é¡µ)
æ¨è:
  - é¢‘ç¹UPDATE: 70-80 (é¢„ç•™20-30%ç©ºé—´)
  - åªè¯»/è¿½åŠ : 100 (èŠ‚çœç©ºé—´)
```

### 7.2 è®¾ç½®æ–¹æ³•

```sql
-- åˆ›å»ºè¡¨æ—¶è®¾ç½®
CREATE TABLE hot_table (
    id INT PRIMARY KEY,
    status TEXT
) WITH (fillfactor = 70);

-- ä¿®æ”¹ç°æœ‰è¡¨
ALTER TABLE hot_table SET (fillfactor = 70);

-- é‡å»ºè¡¨ä½¿è®¾ç½®ç”Ÿæ•ˆ
VACUUM FULL hot_table;  -- æˆ– REINDEX + CLUSTER

-- æŸ¥çœ‹è®¾ç½®
SELECT relname, reloptions
FROM pg_class
WHERE relname = 'hot_table';
```

---

## 8. FSM å’Œ VM

### 8.1 FSM (Free Space Map)

```
ä½œç”¨: è®°å½•æ¯ä¸ªé¡µé¢çš„ç©ºé—²ç©ºé—´å¤§å°
æ–‡ä»¶: <table_oid>_fsm

ç»“æ„: 3å±‚Bæ ‘
  - æ ¹èŠ‚ç‚¹: è®°å½•å„åˆ†æ”¯çš„æœ€å¤§ç©ºé—²ç©ºé—´
  - ä¸­é—´èŠ‚ç‚¹: è®°å½•å„å¶å­çš„æœ€å¤§ç©ºé—²ç©ºé—´
  - å¶å­èŠ‚ç‚¹: è®°å½•æ¯ä¸ªé¡µé¢çš„ç©ºé—²ç©ºé—´ (1å­—èŠ‚ç²¾åº¦ ~32B)

INSERTæµç¨‹:
  1. æŸ¥è¯¢FSMæ‰¾åˆ°æœ‰è¶³å¤Ÿç©ºé—´çš„é¡µ
  2. åœ¨è¯¥é¡µæ’å…¥å…ƒç»„
  3. æ›´æ–°FSMè®°å½•
```

### 8.2 VM (Visibility Map)

```
ä½œç”¨: è®°å½•å“ªäº›é¡µé¢çš„æ‰€æœ‰å…ƒç»„å¯¹æ‰€æœ‰äº‹åŠ¡å¯è§
æ–‡ä»¶: <table_oid>_vm

ç»“æ„: ä½å›¾ (æ¯é¡µ2ä½)
  - Bit 0: all-visible (æ‰€æœ‰å…ƒç»„å¯è§)
  - Bit 1: all-frozen (æ‰€æœ‰å…ƒç»„å·²å†»ç»“)

VACUUMä¼˜åŒ–:
  - è·³è¿‡ all-visible é¡µé¢ (Index-Only Scanä¹Ÿä¾èµ–VM)
  - åªæ‰«æå¯èƒ½æœ‰æ­»å…ƒç»„çš„é¡µé¢
```

```sql
-- æŸ¥çœ‹VMç»Ÿè®¡
SELECT 
    relname,
    pg_size_pretty(pg_relation_size(oid)) AS size,
    pg_stat_get_blocks_fetched(oid) - pg_stat_get_blocks_hit(oid) AS disk_reads
FROM pg_class
WHERE relkind = 'r' AND relnamespace = 'public'::regnamespace;
```

---

## 9. é¡µé¢å‰ªæ (Page Pruning)

### 9.1 è§¦å‘æ—¶æœº

```
é¡µé¢å‰ªæ vs VACUUM:
  - é¡µé¢å‰ªæ: å•é¡µå±€éƒ¨æ¸…ç† (è½»é‡çº§)
  - VACUUM: å…¨è¡¨æ‰«ææ¸…ç† (é‡é‡çº§)

è§¦å‘æ¡ä»¶:
  1. UPDATE/SELECT è®¿é—®é¡µé¢
  2. é¡µé¢æœ‰æ­»å…ƒç»„ (æ£€æŸ¥ pd_prune_xid)
  3. äº‹åŠ¡ >= pd_prune_xid (æ­»å…ƒç»„å¯èƒ½å¯è§)

æ“ä½œ:
  - æ¸…ç†æ­»å…ƒç»„å ç”¨çš„ç©ºé—´
  - ä¸å›æ”¶ç©ºé—´ç»™æ“ä½œç³»ç»Ÿ
  - ç©ºé—´å¯ä¾›åŒé¡µçš„æ–°INSERTä½¿ç”¨
```

### 9.2 HOTé“¾å‰ªæ

```
åœºæ™¯: HOT Updateé“¾ä¸­çš„æ—§ç‰ˆæœ¬å·²å¯¹æ‰€æœ‰äº‹åŠ¡ä¸å¯è§

å‰ªæå‰:
  ItemId[1] â†’ Tuple (v1, t_ctid=(0,5))  [dead]
  ItemId[5] â†’ Tuple (v2, t_ctid=(0,9))  [dead]
  ItemId[9] â†’ Tuple (v3, t_ctid=(0,9))  [current]

å‰ªæå:
  ItemId[1] â†’ (redirect to 9)
  ItemId[5] â†’ (dead)
  ItemId[9] â†’ Tuple (v3)  [current]

æ•ˆæœ:
  - å›æ”¶v1, v2å ç”¨çš„ç©ºé—´
  - ItemId[1] é‡å®šå‘åˆ°æœ€æ–°ç‰ˆæœ¬ (ç´¢å¼•ä»æœ‰æ•ˆ)
```

---

## 10. æ€§èƒ½ç›‘æ§

### 10.1 å…³é”®æŒ‡æ ‡

```sql
-- è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT 
    schemaname,
    relname,
    n_tup_ins,      -- æ’å…¥æ•°
    n_tup_upd,      -- æ›´æ–°æ•°
    n_tup_del,      -- åˆ é™¤æ•°
    n_tup_hot_upd,  -- HOTæ›´æ–°æ•°
    n_live_tup,     -- æ´»å…ƒç»„æ•°
    n_dead_tup,     -- æ­»å…ƒç»„æ•°
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables;
```

### 10.2 é¡µé¢ç»Ÿè®¡

```sql
-- ä½¿ç”¨ pgstattuple æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgstattuple;

-- æŸ¥çœ‹è¡¨ç»Ÿè®¡
SELECT * FROM pgstattuple('your_table');
-- table_len: è¡¨å¤§å°
-- tuple_count: å…ƒç»„æ•°
-- tuple_len: å…ƒç»„æ•°æ®æ€»å¤§å°
-- dead_tuple_count: æ­»å…ƒç»„æ•°
-- free_space: ç©ºé—²ç©ºé—´
-- avg_leaf_density: å¹³å‡å¡«å……å¯†åº¦

-- å¿«é€Ÿä¼°ç®— (ä¸ç²¾ç¡®ä½†å¿«)
SELECT * FROM pgstattuple_approx('your_table');
```

---

## æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µ

1. **å †è¡¨**: æ— åºè¿½åŠ å­˜å‚¨
2. **é¡µé¢**: 8KBåŸºæœ¬å•ä½ï¼ŒåŒ…å«PageHeader + ItemIdæ•°ç»„ + å…ƒç»„
3. **å…ƒç»„**: HeapTupleHeader + ç”¨æˆ·æ•°æ®
4. **TID**: (blockNumber, offsetNumber) ç‰©ç†ä½ç½®æ ‡è¯†
5. **HOT Update**: åŒé¡µæ›´æ–°ä¼˜åŒ–ï¼Œé¿å…ç´¢å¼•æ›´æ–°
6. **TOAST**: è¶…å¤§å­—æ®µå¤–éƒ¨å­˜å‚¨
7. **FSM/VM**: ç©ºé—´ç®¡ç†å’Œå¯è§æ€§ä¼˜åŒ–
8. **é¡µé¢å‰ªæ**: è½»é‡çº§å±€éƒ¨æ¸…ç†

### æ€§èƒ½è¦ç‚¹

- âœ… åˆç†è®¾ç½® fillfactor (é¢‘ç¹UPDATEçš„è¡¨è®¾ä¸º70-80)
- âœ… ç›‘æ§ HOT Update æ¯”ä¾‹ (ç›®æ ‡ > 80%)
- âœ… å®šæœŸ VACUUM æ¸…ç†æ­»å…ƒç»„
- âœ… é¿å…æ›´æ–°ç´¢å¼•åˆ— (ä»¥åˆ©ç”¨HOT Update)
- âœ… åˆç†è®¾è®¡TOASTç­–ç•¥

---

**ä¸‹ä¸€æ­¥**: é˜…è¯» [02_data_structures.md](02_data_structures.md) æ·±å…¥äº†è§£æ•°æ®ç»“æ„

**æºç ç‰ˆæœ¬**: PostgreSQL 17.6  
**æœ€åæ›´æ–°**: 2025-10-16
