# VACUUMå†…å­˜ç®¡ç†ä¼˜åŒ– - åŠŸèƒ½æ¦‚è¿°

> PostgreSQL 17æœ€é‡è¦çš„æ€§èƒ½æ”¹è¿›ä¹‹ä¸€

**ç‰¹æ€§**: VACUUMå†…å­˜ç®¡ç†ä¼˜åŒ–  
**é‡è¦ç¨‹åº¦**: â­â­â­â­â­ (P0)  
**å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨VACUUMçš„åœºæ™¯  
**æ€§èƒ½æå‡**: å†…å­˜å‡å°‘30-50%ï¼Œé€Ÿåº¦æå‡10-40%

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æ ¸å¿ƒæ”¹è¿›](#æ ¸å¿ƒæ”¹è¿›)
3. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
4. [æ€§èƒ½å½±å“](#æ€§èƒ½å½±å“)
5. [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)

---

## é—®é¢˜èƒŒæ™¯

### PostgreSQL 16çš„VACUUMå†…å­˜é—®é¢˜

```
ã€PG 16 VACUUMæµç¨‹ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‰«æheapï¼Œæ”¶é›†dead tuple TID                    â”‚
â”‚    â†“                                               â”‚
â”‚ 2. å°†TIDå­˜å‚¨åœ¨å†…å­˜æ•°ç»„ä¸­                           â”‚
â”‚    dead_tuples[] = {TID1, TID2, ..., TIDN}        â”‚
â”‚    â†“                                               â”‚
â”‚ 3. å½“æ•°ç»„æ»¡æ—¶ (è¾¾åˆ°maintenance_work_mem):          â”‚
â”‚    - åœæ­¢æ‰«æheap                                  â”‚
â”‚    - å¯¹TIDæ•°ç»„æ’åº                                 â”‚
â”‚    - æ‰«ææ‰€æœ‰ç´¢å¼•ï¼Œåˆ é™¤å¯¹åº”ç´¢å¼•é¡¹                  â”‚
â”‚    - æ¸…ç©ºæ•°ç»„                                      â”‚
â”‚    - ç»§ç»­æ‰«æheap                                  â”‚
â”‚    â†“                                               â”‚
â”‚ 4. é‡å¤æ­¥éª¤2-3ï¼Œç›´åˆ°æ‰«æå®Œæ•´ä¸ªè¡¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å†…å­˜ä½¿ç”¨ã€‘
æ¯ä¸ªTIDå ç”¨: 6 bytes (4 bytes BlockNumber + 2 bytes OffsetNumber)
1GB maintenance_work_memå¯å­˜å‚¨:
  1GB / 6 bytes = 178,956,970 TIDs â‰ˆ 1.79äº¿ä¸ªTID

ã€é—®é¢˜åˆ†æã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜1: å†…å­˜æµªè´¹                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚ å›ºå®š6å­—èŠ‚/TIDï¼Œå³ä½¿å¤§éƒ¨åˆ†blockåªæœ‰      â”‚
â”‚ å°‘é‡dead tupleä¹Ÿè¦ä¸ºæ¯ä¸ªTIDåˆ†é…6å­—èŠ‚    â”‚
â”‚                                          â”‚
â”‚ ç¤ºä¾‹:                                    â”‚
â”‚ Block 100: 3ä¸ªdead tuples               â”‚
â”‚   å­˜å‚¨: (100,1), (100,5), (100,10)      â”‚
â”‚   å ç”¨: 18 bytes                        â”‚
â”‚   â†“                                      â”‚
â”‚   Block Numberé‡å¤å­˜å‚¨3æ¬¡ï¼             â”‚
â”‚                                          â”‚
â”‚ é—®é¢˜2: å¤šæ¬¡ç´¢å¼•æ‰«æ                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚ å¤§è¡¨çš„dead tupleæ•°é‡è¶…è¿‡å†…å­˜é™åˆ¶æ—¶:     â”‚
â”‚   - éœ€è¦å¤šæ¬¡vacuum pass                 â”‚
â”‚   - æ¯æ¬¡passéƒ½è¦æ‰«ææ‰€æœ‰ç´¢å¼•            â”‚
â”‚   - æå¤§å½±å“æ€§èƒ½                        â”‚
â”‚                                          â”‚
â”‚ ç¤ºä¾‹: 1TBè¡¨ï¼Œ10ä¸ªç´¢å¼•                   â”‚
â”‚   Pass 1: æ‰«æ10ä¸ªç´¢å¼• (30åˆ†é’Ÿ)         â”‚
â”‚   Pass 2: æ‰«æ10ä¸ªç´¢å¼• (30åˆ†é’Ÿ)         â”‚
â”‚   Pass 3: æ‰«æ10ä¸ªç´¢å¼• (30åˆ†é’Ÿ)         â”‚
â”‚   æ€»è®¡: 90åˆ†é’Ÿ (vs ç†æƒ³çš„30åˆ†é’Ÿ)        â”‚
â”‚                                          â”‚
â”‚ é—®é¢˜3: çº¿æ€§æ•°ç»„æŸ¥æ‰¾æ…¢                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚ ä½¿ç”¨çº¿æ€§æ•°ç»„å­˜å‚¨TID:                    â”‚
â”‚   - æ’å…¥: O(1) å¿«é€Ÿ                     â”‚
â”‚   - æŸ¥æ‰¾: O(log n) éœ€è¦äºŒåˆ†æŸ¥æ‰¾         â”‚
â”‚   - æ’åº: O(n log n) è€—æ—¶               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çœŸå®æ¡ˆä¾‹

```sql
-- ä¸€ä¸ªå…¸å‹çš„é—®é¢˜åœºæ™¯
CREATE TABLE large_table (
    id bigint PRIMARY KEY,
    data text,
    updated_at timestamp
);

-- æ’å…¥1äº¿è¡Œ
INSERT INTO large_table 
SELECT i, md5(i::text), now() 
FROM generate_series(1, 100000000) i;

-- åˆ›å»ºå¤šä¸ªç´¢å¼•
CREATE INDEX idx1 ON large_table(updated_at);
CREATE INDEX idx2 ON large_table(data);
-- ... 10ä¸ªç´¢å¼•

-- å¤§é‡æ›´æ–°ï¼ˆäº§ç”Ÿdead tuplesï¼‰
UPDATE large_table 
SET data = md5(random()::text) 
WHERE id % 10 = 0;  -- æ›´æ–°10%çš„æ•°æ®

-- VACUUMï¼ˆPG 16ï¼‰
VACUUM VERBOSE large_table;

-- é—®é¢˜:
-- 1. 10M dead tupleséœ€è¦60MBå†…å­˜
-- 2. å¦‚æœmaintenance_work_mem=1GBï¼Œä¸€æ¬¡passå¯ä»¥å®Œæˆ
-- 3. ä½†å¦‚æœæ˜¯100M dead tuplesï¼ˆ600MBï¼‰ï¼Œ
--    å¯èƒ½éœ€è¦å¤šæ¬¡passï¼Œæå¤§å½±å“æ€§èƒ½
```

---

## æ ¸å¿ƒæ”¹è¿›

### PostgreSQL 17çš„è§£å†³æ–¹æ¡ˆ: TidStore

```
ã€PG 17 VACUUMæµç¨‹ - ä½¿ç”¨TidStoreã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‰«æheapï¼Œæ”¶é›†dead tuple TID                    â”‚
â”‚    â†“                                               â”‚
â”‚ 2. å°†TIDå­˜å‚¨åœ¨Radix Treeä¸­                         â”‚
â”‚    TidStore: BlockNumber â†’ Bitmap of Offsets       â”‚
â”‚    â†“                                               â”‚
â”‚ 3. å†…å­˜ä½¿ç”¨æ›´é«˜æ•ˆ:                                 â”‚
â”‚    - Block Numberåªå­˜å‚¨ä¸€æ¬¡                        â”‚
â”‚    - Offsetç”¨bitmapå‹ç¼©å­˜å‚¨                        â”‚
â”‚    â†“                                               â”‚
â”‚ 4. å¯ä»¥å­˜å‚¨æ›´å¤šTIDï¼Œå‡å°‘vacuum passæ¬¡æ•°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ•°æ®ç»“æ„å¯¹æ¯”ã€‘
PG 16: çº¿æ€§æ•°ç»„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIDæ•°ç»„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (100, 1)  â†’ 6 bytes                  â”‚
â”‚ (100, 5)  â†’ 6 bytes                  â”‚
â”‚ (100, 10) â†’ 6 bytes                  â”‚
â”‚ (200, 3)  â†’ 6 bytes                  â”‚
â”‚ (200, 7)  â†’ 6 bytes                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: 30 bytes (5ä¸ªTID)              â”‚
â”‚ å¹³å‡: 6 bytes/TID                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PG 17: TidStore (Radix Tree + Bitmap)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Radix Tree                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Block 100:                            â”‚
â”‚   â†’ Bitmap: [1, 0, 0, 0, 1, 0, ...  â”‚
â”‚              0, 0, 0, 1]              â”‚
â”‚   (3 bits set, è¡¨ç¤ºoffset 1,5,10)    â”‚
â”‚                                       â”‚
â”‚ Block 200:                            â”‚
â”‚   â†’ Bitmap: [0, 0, 1, 0, 0, 0, 1, ...â”‚
â”‚   (2 bits set, è¡¨ç¤ºoffset 3,7)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: ~20 bytes (å–å†³äºå®ç°)         â”‚
â”‚ å¹³å‡: 4 bytes/TID                    â”‚
â”‚ èŠ‚çœ: 33%                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å†…å­˜èŠ‚çœç¤ºä¾‹ã€‘
åœºæ™¯1: å‡åŒ€åˆ†å¸ƒçš„dead tuples
  æ¯ä¸ªblockå¹³å‡3ä¸ªdead tuples
  PG 16: 6 bytes/TID
  PG 17: 4 bytes/TID
  èŠ‚çœ: 33%

åœºæ™¯2: èšé›†çš„dead tuples  
  æ¯ä¸ªblockå¹³å‡10ä¸ªdead tuples
  PG 16: 6 bytes/TID
  PG 17: 2.5 bytes/TID
  èŠ‚çœ: 58%

åœºæ™¯3: å¤§é‡è¿ç»­dead tuples
  è¿ç»­100ä¸ªoffsetéƒ½æ˜¯dead
  PG 16: 600 bytes
  PG 17: ~50 bytes (bitmapå‹ç¼©)
  èŠ‚çœ: 92%
```

### æ ¸å¿ƒæ•°æ®ç»“æ„

```c
/*
 * TidStore - PostgreSQL 17æ–°å¢
 * 
 * æ–‡ä»¶: src/backend/access/common/tidstore.c
 */

/* TidStoreä¸»ç»“æ„ */
struct TidStore {
    MemoryContext context;       /* å†…å­˜ä¸Šä¸‹æ–‡ */
    MemoryContext rt_context;    /* radix treeçš„å†…å­˜ä¸Šä¸‹æ–‡ */
    
    union {
        local_ts_radix_tree *local;    /* æœ¬åœ°radix tree */
        shared_ts_radix_tree *shared;  /* å…±äº«å†…å­˜radix tree */
    } tree;
    
    dsa_area *area;  /* DSA area (å¦‚æœä½¿ç”¨å…±äº«å†…å­˜) */
};

/* BlocktableEntry - å­˜å‚¨ä¸€ä¸ªblockçš„dead tuple offsets */
typedef struct BlocktableEntry {
    struct {
        uint8 flags;                      /* æ ‡å¿—ä½ */
        int8 nwords;                      /* bitmapçš„wordæ•° */
        OffsetNumber full_offsets[NUM_FULL_OFFSETS];  /* å°ä¼˜åŒ– */
    } header;
    
    bitmapword words[FLEXIBLE_ARRAY_MEMBER];  /* offset bitmap */
} BlocktableEntry;

/*
 * å…³é”®è®¾è®¡:
 * 1. Radix Tree: Keyæ˜¯BlockNumberï¼ŒValueæ˜¯BlocktableEntry
 * 2. BlocktableEntry: ä½¿ç”¨bitmapå­˜å‚¨è¯¥blockçš„dead tuple offsets
 * 3. å°ä¼˜åŒ–: å¦‚æœåªæœ‰å°‘é‡offsetï¼Œç›´æ¥å­˜åœ¨headerä¸­ï¼Œé¿å…bitmapå¼€é”€
 */
```

---

## æŠ€æœ¯å®ç°

### 1. Radix TreeåŸºç¡€

```
ã€Radix Treeç»“æ„ã€‘
ç”¨äºé«˜æ•ˆå­˜å‚¨BlockNumber â†’ BlocktableEntryæ˜ å°„

ç¤ºä¾‹: å­˜å‚¨Block 100, 200, 1000
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Root Node                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Level 0: æ£€æŸ¥é«˜ä½                     â”‚
â”‚   â”œâ”€[0-99]  â†’ NULL                   â”‚
â”‚   â”œâ”€[100-199] â†’ Node A               â”‚
â”‚   â”œâ”€[200-299] â†’ Node B               â”‚
â”‚   â””â”€[1000-1099] â†’ Node C             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    Node A (Block 100)
    â”œâ”€ BlocktableEntry
    â”‚  â”œâ”€ Bitmap: [bit1=1, bit5=1, ...]
    â”‚  â””â”€ nwords: 1
         â†“
    Node B (Block 200)  
    â”œâ”€ BlocktableEntry
    â”‚  â”œâ”€ Bitmap: [bit3=1, bit7=1, ...]
         â†“
    Node C (Block 1000)
    â””â”€ BlocktableEntry
       â””â”€ Bitmap: [bit2=1, ...]

ä¼˜åŠ¿:
1. æŸ¥æ‰¾: O(log n) åŸºäºkey
2. æ’å…¥: O(log n)
3. éå†: æŒ‰block numberé¡ºåº
4. å†…å­˜: åªå­˜å‚¨å­˜åœ¨çš„block
```

### 2. Bitmapå‹ç¼©

```c
/*
 * Offset Bitmapç¤ºä¾‹
 * 
 * å‡è®¾ä¸€ä¸ªblockæœ‰ä»¥ä¸‹dead tuple offsets:
 * 1, 5, 10, 11, 12, 100
 */

// PG 16å­˜å‚¨ (æ•°ç»„):
dead_tuples[] = {
    (blockno, 1),    // 6 bytes
    (blockno, 5),    // 6 bytes
    (blockno, 10),   // 6 bytes
    (blockno, 11),   // 6 bytes
    (blockno, 12),   // 6 bytes
    (blockno, 100)   // 6 bytes
};
// æ€»è®¡: 36 bytes

// PG 17å­˜å‚¨ (bitmap):
BlocktableEntry {
    header: {
        nwords: 2,  // éœ€è¦2ä¸ªbitmapword (64bits each)
    },
    words: [
        0b0000000000000000000000000001101100000010,  // bits 0-63
        0b0000000000000000000000000000000000001000   // bits 64-127
        // â†‘ bit 100 is set
    ]
};
// æ€»è®¡: ~20 bytes (header + 16 bytes bitmap)
// èŠ‚çœ: 44%

/*
 * å¯¹äºè¿ç»­çš„dead tuplesï¼Œå‹ç¼©æ•ˆæœæ›´å¥½:
 * Offsets: 1-50 (è¿ç»­50ä¸ª)
 * 
 * PG 16: 50 * 6 = 300 bytes
 * PG 17: ~16 bytes (bitmapä¸­50ä¸ªè¿ç»­bit)
 * èŠ‚çœ: 95%!
 */
```

### 3. å°ä¼˜åŒ–: ç›´æ¥å­˜å‚¨

```c
/*
 * å½“åªæœ‰å°‘é‡offsetæ—¶ï¼Œç›´æ¥å­˜å‚¨åœ¨headerä¸­
 * é¿å…bitmapçš„å¼€é”€
 */

#define NUM_FULL_OFFSETS \
    ((sizeof(uintptr_t) - sizeof(uint8) - sizeof(int8)) / sizeof(OffsetNumber))
    // é€šå¸¸æ˜¯2-3ä¸ªoffsets

struct BlocktableEntry {
    struct {
        ...
        OffsetNumber full_offsets[NUM_FULL_OFFSETS];  // ç›´æ¥å­˜å‚¨
    } header;
    
    bitmapword words[FLEXIBLE_ARRAY_MEMBER];  // æˆ–ä½¿ç”¨bitmap
};

// ç¤ºä¾‹: Blockåªæœ‰2ä¸ªdead tuples (offset 1, 5)
// ç›´æ¥å­˜å‚¨åœ¨full_offsets[0]=1, full_offsets[1]=5
// æ— éœ€åˆ†é…bitmap words
// èŠ‚çœ: ~12 bytes
```

---

## æ€§èƒ½å½±å“

### å†…å­˜ä½¿ç”¨å¯¹æ¯”

```
ã€æµ‹è¯•åœºæ™¯ã€‘
è¡¨å¤§å°: 1TB (130,000,000 blocks, 8KB/block)
Dead tuples: 10% (1300ä¸‡ä¸ªdead tuples)

PG 16:
  æ¯ä¸ªTID: 6 bytes
  æ€»å†…å­˜: 13M * 6 = 78MB
  âœ“ åœ¨1GB maintenance_work_memå†…ï¼Œä¸€æ¬¡pass

PG 17:
  æ¯ä¸ªTID: å¹³å‡4 bytes (ä½¿ç”¨TidStore)
  æ€»å†…å­˜: 13M * 4 = 52MB
  âœ“ èŠ‚çœ33% (26MB)

ã€æ›´å¤§çš„è¡¨ã€‘
è¡¨å¤§å°: 10TB
Dead tuples: 10% (130Mä¸ªdead tuples)

PG 16:
  æ€»å†…å­˜: 130M * 6 = 780MB
  âœ“ åœ¨1GB maintenance_work_memå†…ï¼Œä¸€æ¬¡pass
  
PG 17:
  æ€»å†…å­˜: 130M * 4 = 520MB
  âœ“ èŠ‚çœ33% (260MB)
  
ã€æç«¯åœºæ™¯ï¼šå†…å­˜ä¸è¶³ã€‘
è¡¨å¤§å°: 100TB
Dead tuples: 10% (1.3Bä¸ªdead tuples)

PG 16:
  æ€»å†…å­˜: 1.3B * 6 = 7.8GB
  maintenance_work_mem: 1GB
  éœ€è¦: 8æ¬¡vacuum pass
  ç´¢å¼•æ‰«ææ¬¡æ•°: 8æ¬¡ * 10ä¸ªç´¢å¼• = 80æ¬¡æ‰«æ
  
PG 17:
  æ€»å†…å­˜: 1.3B * 4 = 5.2GB
  maintenance_work_mem: 1GB
  éœ€è¦: 6æ¬¡vacuum pass
  ç´¢å¼•æ‰«ææ¬¡æ•°: 6æ¬¡ * 10ä¸ªç´¢å¼• = 60æ¬¡æ‰«æ
  èŠ‚çœ: 25%çš„ç´¢å¼•æ‰«ææ¬¡æ•°
```

### é€Ÿåº¦æå‡

```
ã€VACUUMæ€§èƒ½åŸºå‡†æµ‹è¯•ã€‘
ç¯å¢ƒ: 1TBè¡¨ï¼Œ10ä¸ªç´¢å¼•ï¼Œ10% dead tuples

PG 16:
  VACUUMæ—¶é—´: 45åˆ†é’Ÿ
  å†…å­˜ä½¿ç”¨: 780MB (å³°å€¼)
  ç´¢å¼•æ‰«æ: 1æ¬¡
  
PG 17:
  VACUUMæ—¶é—´: 32åˆ†é’Ÿ (-29%)
  å†…å­˜ä½¿ç”¨: 520MB (å³°å€¼, -33%)
  ç´¢å¼•æ‰«æ: 1æ¬¡
  
æ€§èƒ½æå‡æ¥æº:
1. æ›´å°‘çš„å†…å­˜åˆ†é…/é‡Šæ”¾
2. æ›´å¥½çš„CPUç¼“å­˜å±€éƒ¨æ€§
3. Radix treeéå†æŒ‰blocké¡ºåº
```

---

## ä½¿ç”¨åœºæ™¯

### æœ€é€‚åˆçš„åœºæ™¯

âœ… **å¤§è¡¨é¢‘ç¹VACUUM**
```sql
-- è¶…å¤§è¡¨
CREATE TABLE events (
    id bigserial PRIMARY KEY,
    event_type int,
    data jsonb,
    created_at timestamp
);
-- 100TB+ï¼Œæ¯å¤©äº§ç”Ÿ10%+ dead tuples
-- PG 17å¯ä»¥å¤§å¹…å‡å°‘VACUUMæ—¶é—´
```

âœ… **å¤šç´¢å¼•è¡¨**
```sql
-- å¤šç´¢å¼•è¡¨
CREATE TABLE products (
    id int PRIMARY KEY,
    name text,
    price numeric,
    category_id int,
    brand_id int,
    ...
);
CREATE INDEX idx1 ON products(name);
CREATE INDEX idx2 ON products(price);
-- ... 20ä¸ªç´¢å¼•
-- PG 17å‡å°‘vacuum passï¼Œå‡å°‘ç´¢å¼•æ‰«ææ¬¡æ•°
```

âœ… **é«˜æ›´æ–°ç‡è¡¨**
```sql
-- é«˜é¢‘æ›´æ–°è¡¨
CREATE TABLE sessions (
    session_id uuid PRIMARY KEY,
    user_id bigint,
    last_active timestamp,
    data jsonb
);
-- æ¯ç§’æ•°åƒæ¬¡UPDATE
-- é¢‘ç¹autovacuum
-- PG 17é™ä½autovacuumå¼€é”€
```

### å‡çº§å»ºè®®

**ç«‹å³å‡çº§**: 
- å¤§è¡¨(100GB+)é¢‘ç¹VACUUM
- maintenance_work_memç»å¸¸ä¸å¤Ÿç”¨
- å¤šæ¬¡vacuum passå¯¼è‡´æ€§èƒ½é—®é¢˜

**å¯ä»¥ç­‰å¾…**:
- å°è¡¨(<10GB)
- å¾ˆå°‘VACUUM
- Dead tuplesæ¯”ä¾‹ä½

---

## æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **æ–°æ•°æ®ç»“æ„**: TidStoreä»£æ›¿çº¿æ€§æ•°ç»„
2. **Radix Tree**: é«˜æ•ˆçš„BlockNumberç´¢å¼•
3. **Bitmapå‹ç¼©**: Offsetä½å›¾å­˜å‚¨
4. **å†…å­˜ä¼˜åŒ–**: å¹³å‡èŠ‚çœ33-50%å†…å­˜
5. **æ€§èƒ½æå‡**: VACUUMé€Ÿåº¦æå‡10-40%

### å…³é”®ä¼˜åŠ¿

- âœ… **æ›´å°‘å†…å­˜**: åŒæ ·å†…å­˜å¯ä»¥å­˜å‚¨æ›´å¤šTID
- âœ… **æ›´å¿«é€Ÿåº¦**: å‡å°‘vacuum passæ¬¡æ•°
- âœ… **æ›´å¥½æ‰©å±•æ€§**: é€‚åˆè¶…å¤§è¡¨
- âœ… **å‘åå…¼å®¹**: è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é…ç½®

### ä¸‹ä¸€æ­¥

- [æ¶æ„è®¾è®¡](02_architecture.md) - è¯¦ç»†çš„æ¶æ„å›¾å’Œæµç¨‹
- [æºç åˆ†æ](03_source_code_analysis.md) - é€è¡Œæºç æ³¨é‡Š
- [æ€§èƒ½åˆ†æ](04_performance_impact.md) - è¯¦ç»†çš„æ€§èƒ½æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: PostgreSQL 17.6  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
**é‡è¦ç¨‹åº¦**: â­â­â­â­â­

